<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ä¼šå ´</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #f4f7f6; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 40px; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .user-badge { font-size: 0.8rem; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; margin-top: 5px; display: inline-block; }

        /* å•†å“ãƒªã‚¹ãƒˆ */
        .container { max-width: 500px; margin: auto; padding: 10px; }
        .item-card { background: white; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; border: 1px solid #eee; }
        .item-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #ddd; }
        .item-body { padding: 15px; }
        
        /* ä¾¡æ ¼è¡¨ç¤º */
        .price-section { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .price-label { font-size: 0.8rem; color: #7f8c8d; }
        .current-price { font-size: 1.8rem; color: var(--accent); font-weight: bold; }
        
        /* å…¥æœ­ãƒ•ã‚©ãƒ¼ãƒ  */
        .bid-form { display: flex; gap: 8px; background: #f8f9fa; padding: 10px; border-radius: 10px; }
        .bid-input { flex: 1; border: 1px solid #ced4da; border-radius: 8px; padding: 12px; font-size: 1.1rem; outline: none; }
        .bid-btn { background: var(--accent); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .bid-btn:active { transform: scale(0.95); opacity: 0.8; }

        /* ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆå®Ÿååˆ¶ï¼‰ */
        #login-screen { position: fixed; inset: 0; background: var(--primary); color: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .login-input { width: 80%; padding: 15px; border-radius: 10px; border: none; font-size: 1.1rem; margin-top: 20px; }

				@keyframes pulse {
				    0% { transform: scale(1); }
				    50% { transform: scale(1.02); }
				    100% { transform: scale(1); }
				}

    </style>
</head>
<body>

<div id="login-screen">
    <h1>Welcome</h1>
    <p>ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹ãŸã‚ã€<br>å®Ÿåï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
    <input type="text" id="user-name-input" class="login-input" placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ">
    <button onclick="login()" style="margin-top:20px; padding:15px 40px; border-radius:30px; border:none; background:var(--accent); color:white; font-weight:bold; font-size:1rem;">å‚åŠ ã™ã‚‹</button>
</div>

<header class="header">
    <div style="font-weight: bold; font-size: 1.2rem;">Live Auction</div>
    <div id="my-name-display" class="user-badge">---</div>
</header>

<div id="user-info" style="text-align: right; margin-bottom: 10px; font-size: 0.9rem;">
    å…¥æœ­è€…å: <strong id="current-username">æœªè¨­å®š</strong>
    <button onclick="resetName()" style="font-size: 0.7rem; margin-left: 5px;">åå‰å¤‰æ›´</button>
</div>

<div class="container" id="items-list">
</div>

<script>
		const firebaseConfig = {
        apiKey: "AIzaSyAv_eQX0TeXEWWY6DlWt_8cbKVSsL8T2m4",
        authDomain: "bidding-75c1f.firebaseapp.com",
        projectId: "bidding-75c1f",
        storageBucket: "bidding-75c1f.firebasestorage.app", // .app ã§ã¯ãªã .appspot.com ã®å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€Configé€šã‚Šã§OK
        messagingSenderId: "790924245144",
        appId: "1:790924245144:web:c69ba31b34b53e8e2a78ed",
        measurementId: "G-P5JSZ0W8LR"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const ROOM_ID = urlParams.get('id');
    
    // èµ·å‹•æ™‚ã«ä¿å­˜ã•ã‚ŒãŸåå‰ï¼ˆuser_nameï¼‰ã‚’å–å¾—
		localStorage.clear('user_name');
		let myName = sessionStorage.getItem('user_name') || "";
		let lastSnapshotData = {};

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
		window.onload = async () => {
		    if (myName) {
		        const doc = await db.collection("auctions").doc(ROOM_ID).collection("participants").doc(myName).get();
		        if (doc.exists) {
		            showMain();
		        } else {
		            sessionStorage.removeItem('user_name');
		            document.getElementById('login-screen').style.display = 'flex';
		        }
		    } else {
		        document.getElementById('login-screen').style.display = 'flex';
		    }
		};

		async function login() {
		    const nameInput = document.getElementById('user-name-input').value.trim();
		    if (nameInput.length < 2) return alert("ãŠåå‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
		    if (!ROOM_ID) return alert("ãƒ«ãƒ¼ãƒ IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

		    const btn = document.querySelector('#login-screen button');
		    btn.disabled = true;
		    btn.innerText = "ãƒã‚§ãƒƒã‚¯ä¸­...";

		    try {
		        const participantRef = db.collection("auctions").doc(ROOM_ID).collection("participants").doc(nameInput);
		        const doc = await participantRef.get();

		        if (doc.exists) {
		            alert("ãã®åå‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
		            btn.disabled = false;
		            btn.innerText = "å‚åŠ ã™ã‚‹";
		            return;
		        }

		        await participantRef.set({ joinedAt: firebase.firestore.FieldValue.serverTimestamp() });
		        sessionStorage.setItem('user_name', nameInput);
		        myName = nameInput;
		        showMain();
		    } catch (e) {
		        alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + e.message);
		        btn.disabled = false;
		    }
		}

		function showMain() {
		    document.getElementById('login-screen').style.display = 'none';
		    document.getElementById('current-username').innerText = myName;
		    document.getElementById('my-name-display').innerText = `å‚åŠ è€…: ${myName}`;
		    if (ROOM_ID) {
		        startWatchingItems();
		    }
		}

		function resetName() {
		    if (confirm("åå‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ")) {
		        sessionStorage.removeItem('user_name');
		        location.reload();
		    }
		}

		function startWatchingItems() {
		    db.collection("auctions").doc(ROOM_ID).collection("items")
		      .orderBy("createdAt", "asc")
		      .onSnapshot((snapshot) => {
		          const listEl = document.getElementById('items-list');
		          listEl.innerHTML = '';
		          snapshot.forEach(doc => {
		              const data = doc.data();
		              lastSnapshotData[doc.id] = data; // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
		              renderCard(doc.id, data);
		          });
		      });
		    setInterval(updateAllCountdowns, 1000);
		}

		function calculateMinBid(currentPrice) {
		    return currentPrice < 10000 ? currentPrice + 100 : currentPrice + 500;
		}

		function renderCard(id, data) {
		    const card = document.createElement('div');
		    card.className = 'item-card';
		    
		    const now = new Date();
		    const endTimeDate = data.endTime && data.endTime.toDate ? data.endTime.toDate() : new Date(data.endTime);
		    const isEnded = endTimeDate <= now; 
		    
		    const isBlind = data.auctionType === "blind";
		    const isHighestBidder = (data.highestBidder === myName);
		    const savedBid = sessionStorage.getItem(`last_bid_${id}`);
		    const myCurrentBid = savedBid ? parseInt(savedBid) : null;

		    let displayPrice, bidderHTML, inputDefaultValue, cardStyle = "";

		    if (isEnded) {
		        displayPrice = `Â¥${(data.maxBid || data.currentPrice).toLocaleString()}`;
		        if (isHighestBidder) {
		            cardStyle = "border: 3px solid #f1c40f; background: #fffdf0;";
		            bidderHTML = `<div style="background: #e74c3c; color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; animation: pulse 2s infinite;">ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>ã‚ãªãŸãŒè½æœ­ã—ã¾ã—ãŸ</div>`;
		        } else {
		            bidderHTML = `<div style="background: #eee; color: #666; padding: 10px; border-radius: 8px; text-align: center;">è½æœ­è€…: ${data.highestBidder || 'ãªã—'}</div>`;
		        }
		        inputDefaultValue = myCurrentBid || 0;
		    } else {
		        if (isBlind) {
		            displayPrice = "ï¼Ÿï¼Ÿï¼Ÿ";
		            inputDefaultValue = myCurrentBid || data.startPrice;
		            bidderHTML = myCurrentBid ? `<span>ã‚ãªãŸã®å…¥æœ­é¡: Â¥${myCurrentBid.toLocaleString()}</span>` : `<span>æœªå…¥æœ­</span>`;
		        } else {
		            displayPrice = `Â¥${data.currentPrice.toLocaleString()}`;
		            inputDefaultValue = calculateMinBid(data.currentPrice);
		            bidderHTML = isHighestBidder ? `<strong style="color:red;">â˜…ã‚ãªãŸãŒæœ€é«˜å…¥æœ­è€…</strong>` : `<span>æœ€é«˜å…¥æœ­è€…: éå…¬é–‹</span>`;
		        }
		    }

		    card.style = cardStyle;
		    card.innerHTML = `
		        <img src="${data.imageUrl}" class="item-img">
		        <div class="item-body">
		            <h2 style="margin:0;">${data.title}</h2>
		            <div id="timer-${id}" class="timer-badge" data-endtime="${endTimeDate.getTime()}" style="color:red; font-weight:bold; margin: 10px 0;">
		                ${isEnded ? "ã€çµ‚äº†ã€‘" : "èª­ã¿è¾¼ã¿ä¸­..."}
		            </div>
		            <div class="price-section">
		                <span style="font-size:0.8rem; color:#666;">${isEnded ? 'æœ€çµ‚è½æœ­é¡' : 'ç¾åœ¨ã®ä¾¡æ ¼'}</span>
		                <span class="current-price">${displayPrice}</span>
		                <div style="margin-top:10px; width:100%;">${bidderHTML}</div>
		            </div>
		            <div class="bid-form" style="display: ${isEnded ? 'none' : 'flex'};">
		                <input type="number" id="bid-amount-${id}" class="bid-input" value="${inputDefaultValue}">
		                <button class="bid-btn" id="btn-${id}" onclick="placeBid('${id}', ${data.currentPrice}, '${data.auctionType}')">å…¥æœ­</button>
		            </div>
		        </div>
		    `;
		    document.getElementById('items-list').appendChild(card);
		}

		async function placeBid(itemId, currentPrice, auctionType) {
		    const bidInput = document.getElementById(`bid-amount-${itemId}`);
		    const btn = document.getElementById(`btn-${itemId}`);
		    if (!btn || !bidInput) return;

		    const newUserMaxBid = parseInt(bidInput.value);
		    const isBlind = auctionType === "blind";
		    const minRequired = calculateMinBid(currentPrice);
		    
		    if (isNaN(newUserMaxBid)) return alert("æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
		    if (newUserMaxBid < minRequired) {
		        alert(isBlind ? "ç¾åœ¨ä¾¡æ ¼ã‚ˆã‚Šé«˜ã„å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚" : `Â¥${minRequired.toLocaleString()}ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„`);
		        return;
		    }

		    btn.disabled = true;
		    const itemRef = db.collection("auctions").doc(ROOM_ID).collection("items").doc(itemId);

		    try {
		        await db.runTransaction(async (transaction) => {
		            const doc = await transaction.get(itemRef);
		            const data = doc.data();
		            const currentMaxBid = data.maxBid || data.startPrice;
		            const currentHighestBidder = data.highestBidder;

		            let nextPrice, nextHighestBidder, nextMaxBid;

		            if (currentHighestBidder === myName) {
		                nextPrice = data.currentPrice;
		                nextHighestBidder = myName;
		                nextMaxBid = Math.max(currentMaxBid, newUserMaxBid);
		            } else if (isBlind) {
		                nextPrice = data.currentPrice;
		                if (newUserMaxBid > currentMaxBid) {
		                    nextHighestBidder = myName;
		                    nextMaxBid = newUserMaxBid;
		                } else {
		                    nextHighestBidder = currentHighestBidder;
		                    nextMaxBid = currentMaxBid;
		                }
		            } else {
		                if (newUserMaxBid > currentMaxBid) {
		                    nextPrice = (currentHighestBidder === "ãªã—") ? data.startPrice : calculateMinBid(currentMaxBid);
		                    nextHighestBidder = myName;
		                    nextMaxBid = newUserMaxBid;
		                } else {
		                    nextPrice = calculateMinBid(newUserMaxBid);
		                    if (nextPrice > currentMaxBid) nextPrice = currentMaxBid;
		                    nextHighestBidder = currentHighestBidder;
		                    nextMaxBid = currentMaxBid;
		                }
		            }

		            let newEndTime = data.endTime;
		            if (data.autoExtend && !isBlind) {
		                if (nextHighestBidder === myName && currentHighestBidder !== myName) {
		                    const now = new Date();
		                    const end = data.endTime.toDate();
		                    const diffMs = end - now;
		                    const fiveMinutesMs = 5 * 60 * 1000;
		                    if (diffMs > 0 && diffMs < fiveMinutesMs) {
		                        newEndTime = firebase.firestore.Timestamp.fromDate(new Date(now.getTime() + fiveMinutesMs));
		                    }
		                }
		            }

		            // â˜…ã€ã“ã“ãŒæœ€é‡è¦ã€‘â˜…
		            // å€¤ãŒå¤‰ã‚ã‚‰ãªã„å…¥æœ­ï¼ˆæœ€é«˜å€¤ã«å±Šã‹ãªã„å¯†å°å…¥æœ­ãªã©ï¼‰ã§ã‚‚
		            // ç¢ºå®Ÿã« onSnapshot ã‚’ç™ºå‹•ã•ã›ã‚‹ãŸã‚ã«ã€å¸¸ã«å¤‰åŒ–ã™ã‚‹ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å…¥ã‚Œã‚‹
		            transaction.update(itemRef, {
		                currentPrice: nextPrice,
		                highestBidder: nextHighestBidder,
		                maxBid: nextMaxBid,
		                endTime: newEndTime,
		                lastBidAt: firebase.firestore.FieldValue.serverTimestamp() // å¸¸ã«æ–°ã—ã„æ™‚é–“ã‚’æ›¸ãè¾¼ã‚€
		            });
		        });

		        // è¨˜éŒ²ã‚’ä¿å­˜
		        sessionStorage.setItem(`last_bid_${itemId}`, newUserMaxBid);
		        
		        // â˜…ã€è¿½åŠ ã€‘â˜…
		        // è‡ªå‹•ã§ renderCard ãŒå‹•ã‹ãªã„å ´åˆã«å‚™ãˆã€æ‰‹å‹•ã§ä¸€ç¬ç”»é¢ã‚’æ›´æ–°ã™ã‚‹
		        if (typeof lastSnapshotData !== 'undefined' && lastSnapshotData[itemId]) {
		            renderCard(itemId, lastSnapshotData[itemId]);
		        }

		        alert(isBlind ? "å…¥æœ­ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼ˆå¯†å°å¼ï¼‰" : "å…¥æœ­ã—ã¾ã—ãŸï¼");

		    } catch (e) { 
		        alert("ã‚¨ãƒ©ãƒ¼: " + e); 
		    } finally { 
		        btn.disabled = false; 
		    }
		}

		function updateAllCountdowns() {
		    const timers = document.querySelectorAll('.timer-badge');
		    // å¸¸ã«ã€Œä»Šã®ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ã«è¿‘ã„ãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»ã€ã‚’å–å¾—
		    const now = new Date().getTime();

		    timers.forEach(el => {
		        if (!el || !el.dataset.endtime) return;

		        // dataset.endtime ã«ã¯ renderCard å†…ã§ .getTime() ã•ã‚ŒãŸæ•°å€¤ãŒå…¥ã£ã¦ã„ã¾ã™
		        const endTimeMs = Number(el.dataset.endtime);
		        const diff = endTimeMs - now;
		        const id = el.id.replace('timer-', '');

		        if (diff <= 0) {
		            if (el.innerText !== "ã€çµ‚äº†ã€‘") {
		                el.innerText = "ã€çµ‚äº†ã€‘";
		                // çµ‚äº†ã—ãŸç¬é–“ã«ç”»é¢ã‚’æ›¸ãæ›ãˆã¦ã€å…¥æœ­ãƒœã‚¿ãƒ³ã‚’æ¶ˆã—ã€è½æœ­è€…ã‚’è¡¨ç¤º
		                if (lastSnapshotData[id]) {
		                    refreshAllCards();
		                }
		            }
		        } else {
		            // ãƒŸãƒªç§’ã‚’ç§’ã«å¤‰æ›
		            let totalSec = Math.floor(diff / 1000);
		            
		            // æ™‚ãƒ»åˆ†ãƒ»ç§’ã®è¨ˆç®—
		            const h = Math.floor(totalSec / 3600);
		            totalSec %= 3600;
		            const m = Math.floor(totalSec / 60);
		            const s = totalSec % 60;

		            // è¡¨ç¤ºã®çµ„ã¿ç«‹ã¦
		            let timeStr = "";
		            if (h > 0) timeStr += h + "æ™‚é–“";
		            
		            // 0åŸ‹ã‚ï¼ˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã‚’ã—ã¦ã€Œ02:05ã€ã®ã‚ˆã†ãªè¦‹ã‚„ã™ã„å½¢å¼ã«
		            const mStr = String(m).padStart(2, '0');
		            const sStr = String(s).padStart(2, '0');
		            
		            el.innerText = `æ®‹ã‚Š: ${timeStr}${mStr}åˆ†${sStr}ç§’`;
		        }
		    });
		}

		function refreshAllCards() {
		    const listEl = document.getElementById('items-list');
		    listEl.innerHTML = '';
		    Object.keys(lastSnapshotData).forEach(id => renderCard(id, lastSnapshotData[id]));
		}

</script>
</body>
</html>