<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚³ãƒ³ã‚«ãƒ•ã‚§å¬¢ãƒãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ</title>
    <style>
        /* ã€ä¿®æ­£2ã€‘å…¨ä½“çš„ã«ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚µã‚¤ã‚ºèª¿æ•´ */
        body { 
            padding: 10px; 
            margin: 0; 
            font-family: sans-serif; 
            background-color: #fce4ec; /* ã‚³ãƒ³ã‚«ãƒ•ã‚§ã£ã½ã„èƒŒæ™¯è‰² */
            text-align: center;
        }
        h1 { color: #801e63; font-size: 1.2rem; margin: 15px 0; }
        
        input[type="file"] {
            margin: 10px 0;
            width: 90%;
        }

        button {
            width: 90%;
            max-width: 300px;
            padding: 12px;
            margin: 10px auto;
            display: block;
            background-color: #801e63;
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
        }

        /* ã€ä¿®æ­£3ã€‘Canvasã®è¡¨ç¤ºå¹…ã‚’ã‚¹ãƒãƒ›ç”»é¢ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
        #cardCanvas {
            width: 95%; /* ç”»é¢å¹…ã®95%ã‚’ä½¿ã† */
            max-width: 400px; /* PCã§è¦‹ã¦ã‚‚å¤§ãã™ããªã„åˆ¶é™ */
            height: auto;
            margin: 10px auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<h1>âœ¨ ã‚³ãƒ³ã‚«ãƒ•ã‚§å¬¢ãƒãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ âœ¨</h1>
<p style="font-size: 0.8rem; color: #666;">è‡ªæ’®ã‚Šç”»åƒã‚’é¸ã‚“ã§ãƒğŸ’•</p>
<input type="file" id="imageInput" accept="image/*" onchange="generateCard()"><br>
<button onclick="downloadCard()">ç”»åƒã‚’ä¿å­˜ã™ã‚‹ãƒ¨ğŸ“‹</button>
<canvas id="cardCanvas" width="300" height="1000"></canvas>

<script>
// =============================
// å±æ€§ãƒªã‚¹ãƒˆ
// =============================
const positiveAttributes = [
  "å…ƒæ°—","ç™’ã—","æ„›å¬Œ","é¢ç™½ã•","æ©Ÿè»¢","å¿ƒå°½ãã—","ã‚³ãƒŸãƒ¥åŠ›"
];

const negativeAttributes = [
  "æ‚ªãƒãƒª","ä¸‹ãƒã‚¿","Pæ´»","åº—å¤–","ã‚°ãƒªä¸‹","ä¹é£Ÿ","é¬¼ç•œ","è‰²å–¶",
  "ã‚ªãƒ©å–¶","ã‚¢ãƒ«ãƒãƒ©","é…’é›‘é­š","ãƒ›ã‚¹ç‹‚","å½¼æ°æŒã¡","é¢¨æ›ã‘æŒã¡"
];

// =============================
// SHA-256 ãƒãƒƒã‚·ãƒ¥
// =============================
async function hashImage(file) {
  const buffer = await file.arrayBuffer();
  const hash = await crypto.subtle.digest("SHA-256", buffer);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

// =============================
// ã‚·ãƒ¼ãƒ‰ä»˜ãä¹±æ•°
// =============================
function seededRandom(seed) {
  let h = 0;
  for (let i = 0; i < seed.length; i++) {
    h = Math.imul(31, h) + seed.charCodeAt(i) | 0;
  }
  return () => {
    h = Math.imul(48271, h) % 0x7fffffff;
    return (h & 0xfffffff) / 0x10000000;
  };
}

// =============================
// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆï¼ˆå›ºå®šï¼‰
// =============================
function randomStatsFromSeed(seed) {
  const rand = seededRandom(seed);
  return {
    beauty: Math.floor(rand() * 101),
    intelligence: Math.floor(rand() * 101),
    stamina: Math.floor(rand() * 101),
    guts: Math.floor(rand() * 101),
    mental: Math.floor(rand() * 101)
  };
}

// =============================
// å±æ€§ç”Ÿæˆï¼ˆå›ºå®šï¼‰
// =============================
function randomAttributesFromSeed(seed) {
  const rand = seededRandom(seed);
  const pos = [...positiveAttributes].sort(() => rand() - 0.5).slice(0, 2);
  const neg = [...negativeAttributes].sort(() => rand() - 0.5).slice(0, 1);
  return [...pos, ...neg];
}

// =============================
// ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆå›ºå®šï¼‰
// =============================
const listA = [
  "å¤œã®å…‰ã«æº¶ã‘ã‚‹ã‚ˆã†ã«",
"å¾®ç¬‘ã¿ã®å¥¥ã«å°ã•ãªç‚ã‚’ç¯ã—",
  "å¤¢ã®ç¶šãã«è¿·ã„è¾¼ã‚“ã ã¾ã¾",
"èª°ã‹ã®å¿ƒã‚’ãã£ã¨ç…§ã‚‰ã™ã‚ˆã†ã«",
"æ˜Ÿã®ç¬ãã‚’æŒ‡å…ˆã«é›†ã‚ã¦",
"å¿˜ã‚Œã‹ã‘ãŸç´„æŸã‚’ãƒã‚±ãƒƒãƒˆã«å¿ã°ã›",
"é›¨ä¸ŠãŒã‚Šã®åŒ‚ã„ã«èƒŒä¸­ã‚’æŠ¼ã•ã‚Œã¦",
"è¨€è‘‰ã«ã§ããªã„æ„Ÿæƒ…ã®æ¸¦ã®ä¸­ã§",
"æœˆæ˜ã‹ã‚ŠãŒæãå½±ã«èº«ã‚’æ½œã‚",
  "ç§˜å¯†ã®é­”æ³•ã‚’èƒ¸ã«æŠ±ã„ã¦"
];

const listB = [
  "ä»Šæ—¥ã‚‚ã‚ãªãŸã‚’è¿ãˆã«ã„ã",
"é™ã‹ã«å¼·ã•ã‚’éš ã—ã¦ã„ã‚‹",
  "ãµã‚ã‚Šã¨ä¸–ç•Œã‚’å¤‰ãˆã¦ã—ã¾ã†",
"å°ã•ãªå‹‡æ°—ã‚’ç©ã¿é‡ã­ã¦ã„ã‚‹",
"ç­”ãˆã®ãªã„å•ã„ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ã‚‹",
"ã»ã©ã‘ãã†ãªçµ†ã‚’çµã³ç›´ã—ã¦ã„ã‚‹",
"è‡ªåˆ†ã ã‘ã®åœ°å›³ã‚’æ›¸ãæ›ãˆã¦ã„ã‚‹",
"æ·¡ã„æœŸå¾…ã‚’é¢¨ã«ä¹—ã›ã¦é£›ã°ã™",
"ç¥ç€è‰²ã®è¨˜æ†¶ã‚’å¤§åˆ‡ã«å®ˆã£ã¦ã„ã‚‹",
  "èª°ã‚ˆã‚Šã‚‚å„ªã—ã„å˜˜ã‚’ã¤ã"
];

const listC = [
  "ãã‚“ãªç§ã‚’è¦‹ã¤ã‘ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚",
  "ã“ã®ç¬é–“ãŒæ°¸é ã§ã‚ã‚Šã¾ã™ã‚ˆã†ã«ã€‚",
  "ã‚ãªãŸã®ç‰©èªã«å¯„ã‚Šæ·»ãˆãŸã‚‰å¬‰ã—ã„ã€‚",
  "ä»Šæ—¥ã‚‚å°‘ã—ã ã‘å¼·ããªã‚ŒãŸæ°—ãŒã™ã‚‹ã€‚",
"æ˜æ—¥ã®é¢¨ãŒã€ã‚ãªãŸã«å„ªã—ãå¹ãã¾ã™ã‚ˆã†ã«ã€‚",
"ã¾ã èª°ã‚‚çŸ¥ã‚‰ãªã„ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’ã‚ãã‚ã†ã€‚",
"ãŸã£ãŸä¸€ã¤ã®å…‰ãŒã€ã“ã“ã«ã‚ã‚‹ã‹ã‚‰ã€‚",
"ãã®è¶³è·¡ãŒã€ã„ã¤ã‹èŠ±ã‚’å’²ã‹ã›ã‚‹ã¯ãšã€‚",
"ã“ã®å£°ãŒã€æ™‚ã‚’è¶…ãˆã¦å±Šãã¾ã™ã‚ˆã†ã«ã€‚",
  "å¿ƒã®ã©ã“ã‹ã§ã€ã‚ãªãŸã‚’å¾…ã£ã¦ã„ã‚‹ã€‚"
];

function randomCaptionFromSeed(seed) {
  const rand = seededRandom(seed);
  const pick = arr => arr[Math.floor(rand() * arr.length)];
  return pick(listA) + "ã€" + pick(listB) + "ã€‚" + pick(listC);
}

// =============================
// ã‚«ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆç”»åƒé¸æŠã§è‡ªå‹•ï¼‰
// =============================
async function generateCard() {
  const file = document.getElementById("imageInput").files[0];
  if (!file) return;

  const seed = await hashImage(file);
  const stats = randomStatsFromSeed(seed);
  const attrs = randomAttributesFromSeed(seed);
  const caption = randomCaptionFromSeed(seed);

  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => drawCard(img, stats, attrs, caption);
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// =============================
// ãƒ¬ã‚¢åº¦è¨ˆç®—
// =============================
function calcRarity(stats) {
  const values = Object.values(stats);
  const total = values.reduce((a, b) => a + b, 0);
  const minVal = Math.min(...values);

  if (total >= 420 && minVal >= 64) return "UR";
  if (total >= 400 && minVal >= 55) return "SSR";
  if (total >= 350 && minVal >= 40) return "SR";
  if (total >= 300) return "R";
  return "N";
}

// =============================
// ã‚«ãƒ¼ãƒ‰æç”»
// =============================
const rarityColor = {
  "UR":  "#4fc",
  "SSR": "#d3e",
  "SR":  "#ca2",
  "R":   "#e82",
  "N":   "#27f"
};

function drawCard(userImage, stats, attrs, caption) {
  const canvas = document.getElementById("cardCanvas");
  const ctx = canvas.getContext("2d");

  const rarity = calcRarity(stats);

  const frameImg = new Image();
  frameImg.crossOrigin = "anonymous";
  frameImg.src = {
    "UR":  "ur.png",
    "SSR": "ssr.png",
    "SR":  "sr.png",
    "R":   "r.png",
    "N":   "n.png"
  }[rarity];

  frameImg.onload = () => {
    ctx.fillStyle = "#404060";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // è‡ªæ’®ã‚ŠãƒˆãƒªãƒŸãƒ³ã‚°
    const targetW = 260, targetH = 460;
    const x = 20, y = 70;

    const ratio = Math.max(targetW / userImage.width, targetH / userImage.height);
    const w = userImage.width * ratio;
    const h = userImage.height * ratio;
    const cropX = (w - targetW) / 2;
    const cropY = (h - targetH) / 2;

    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = targetW;
    tempCanvas.height = targetH;
    const tempCtx = tempCanvas.getContext("2d");
    tempCtx.drawImage(userImage, -cropX, -cropY, w, h);

    ctx.drawImage(tempCanvas, x, y);
    ctx.drawImage(frameImg, 0, 0, 300, 600);

    drawStatusAndText(ctx, stats, attrs, rarity, caption, 610);
  };
}

// =============================
// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æç”»
// =============================
function drawStatusAndText(ctx, stats, attrs, rarity, caption, offsetY) {
  ctx.font = "20px sans-serif";
  ctx.fillStyle = rarityColor[rarity];
  ctx.fillText(rarity, 220, offsetY + 20);

  ctx.fillStyle = "#fff";
  ctx.font = "18px sans-serif";
  ctx.fillText("ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€‘", 20, offsetY + 20);

  function drawBar(label, value, y) {
    ctx.fillStyle = "#fff";
    ctx.font = "14px sans-serif";
    ctx.fillText(`${label}: ${value}`, 20, y);
    ctx.fillStyle = "#ddd";
    ctx.fillRect(100, y - 10, 150, 8);
    ctx.fillStyle = "#f20";
    ctx.fillRect(100, y - 10, (value / 100) * 150, 8);
  }

  drawBar("å®¹å§¿", stats.beauty, offsetY + 45);
  drawBar("çŸ¥åŠ›", stats.intelligence, offsetY + 70);
  drawBar("ä½“åŠ›", stats.stamina, offsetY + 95);
  drawBar("æ ¹æ€§", stats.guts, offsetY + 120);
  drawBar("ç²¾ç¥åŠ›", stats.mental, offsetY + 145);

  ctx.fillStyle = "#fff";
  ctx.font = "18px sans-serif";
  ctx.fillText("ã€ãƒ‘ãƒƒã‚·ãƒ–ã‚¹ã‚­ãƒ«ã€‘", 20, offsetY + 170);

  let ax = 20, ay = offsetY + 195;
  attrs.forEach(attr => {
    ctx.fillStyle = positiveAttributes.includes(attr) ? "#fcc" : "#2cf";
    ctx.font = "16px sans-serif";
    ctx.fillText(attr, ax, ay);
    ax += ctx.measureText(attr).width + 15;
    if (ax > 260) { ax = 20; ay += 20; }
  });

  ctx.font = "14px sans-serif";
  ctx.fillStyle = "#fff";
  const lines = caption.match(/.{1,15}/g);
  let cy = ay + 30;
  lines.forEach(line => {
    ctx.fillText(line, 20, cy);
    cy += 16;
  });
}


// =============================
// ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
// =============================

function downloadCard() {
  const canvas = document.getElementById("cardCanvas");
  const link = document.createElement("a");
  link.download = "battle_card.png";
  link.href = canvas.toDataURL();
  link.click();
}
</script>
</body>
</html>
