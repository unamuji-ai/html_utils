<!DOCTYPE html>
<html lang="ja">
<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>DICEãƒ¡ã‚¤ãƒ³</title>
    <style>
				/* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
				html, body {
					  background-color: #1a1a1a !important;
					  color: #ffffff !important;
					  margin: 0;
					  padding: 0;
					  min-height: 100vh;
				}

				.box {
				    background: #2a2a2a;
				    padding: 15px;
				    border-radius: 12px;
				    max-width: 500px;
				    margin: 10px auto;
				    border: 1px solid #444;
				}

				/* --- ãƒ†ã‚­ã‚¹ãƒˆè¦–èªæ€§ --- */
				h2, h3, #room-name-display, #turn-display, #result-message {
				    color: #ffffff !important; /* çµ¶å¯¾ã«ç™½ */
				}

				#ranking-list {
				    color: #ffffff; /* å¯¾æˆ¦çµæœã®æ–‡å­—ã‚‚ç™½ */
				}

				#curse-status-display {
				    color: #ff4d4d;
				    font-size: 1.5rem;
				    font-weight: bold;
				    text-shadow: 0 0 10px #ff0000;
				    min-height: 60px;
				}
				/* 2æšç›®ã®ç”»åƒã«ã‚ã‚‹ã‚°ãƒ¬ãƒ¼ã®ãƒœãƒƒã‚¯ã‚¹å†…ã®æ–‡å­—è‰²ã‚’ç™½ãã™ã‚‹ */
				#result-screen, .box {
				    background-color: #2a2a2a !important;
				    color: #ffffff !important;
				}

				/* ã€Œå¯¾æˆ¦çµæœã€ã‚„ã€Œé †ä½ã€ã®ãƒ†ã‚­ã‚¹ãƒˆãŒé»’ããªã‚‹ã®ã‚’é˜²ã */
				#result-screen h2, 
				#result-screen h3, 
				#ranking-list, 
				.result-item {
				    color: #ffffff !important;
				}

				/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚„ã€Œã‚·ãƒ§ãƒ³ãƒ™ãƒ³ã€ãªã©ã®æ–‡å­— */
				#ranking-list div, 
				#ranking-list span {
				    color: #ffffff !important;
				}

				/* ãƒœã‚¿ãƒ³ã‚’Windowsã‚¯ãƒ©ã‚·ãƒƒã‚¯é¢¨ã‹ã‚‰ãƒ¢ãƒ€ãƒ³ã«ä¿®æ­£ */
				#restart-btn {
				    background: #2196f3;
				    color: white;
				    border: none;
				    padding: 10px 20px;
				    border-radius: 5px;
				    cursor: pointer;
				    font-weight: bold;
				    appearance: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è§£é™¤ */
				}


				/* --- ã©ã‚“ã¶ã‚Š & ã‚µã‚¤ã‚³ãƒ­ --- */
				.dice-area {
				    position: relative;
				    width: 200px;
				    height: 200px;
				    margin: 20px auto;
				    border: 10px solid #8d6e63;
				    border-radius: 50%;
				    background: #efebe9;
				    display: flex;
				    justify-content: center;
				    align-items: center;
				    gap: 10px;
				    box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
				}

				.dice {
				    position: absolute;
				    width: 44px;
				    height: 44px;
				    background: #fff;
				    border-radius: 6px;
				    display: grid;
				    grid-template: repeat(3, 1fr) / repeat(3, 1fr);
				    padding: 4px;
				    box-sizing: border-box;
				    box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
				    border: 1px solid #ccc;
				    z-index: 10;
				    transition: transform 0.2s ease-out;
				}

				.dot { background: #333; border-radius: 50%; width: 8px; height: 8px; margin: auto; }
				.dice[data-value="1"] .dot { background: #e63946; width: 12px; height: 12px; }

				/* --- ã‚²ãƒ¼ã‚¸ --- */
				.gauge-container {
				    width: 95%;
				    max-width: 450px;
				    height: 50px;
				    margin: 20px auto;
						background-image: linear-gradient(
				        to right,
				        #f44336 0%,      /* å·¦ç«¯ï¼šèµ¤ */
				        #ffeb3b 30%,     /* 30%ã¾ã§ã‹ã‘ã¦é»„è‰²ã¸ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
				        #ffeb3b 40%,     /* 40%ã¾ã§ã—ã£ã‹ã‚Šé»„è‰² */
				        #40cf70 40%,     /* 40%ã§ãƒ‘ãƒƒã¨ç·‘ã«åˆ‡ã‚Šæ›¿ãˆ */
				        #40cf70 60%,     /* 60%ã¾ã§ãšã£ã¨ç·‘ */
				        #ffeb3b 60%,     /* 60%ã§ãƒ‘ãƒƒã¨é»„è‰²ã«åˆ‡ã‚Šæ›¿ãˆ */
				        #ffeb3b 70%,     /* 70%ã¾ã§é»„è‰²ã‚’ç¶­æŒ */
				        #f44336 100%     /* æœ€å¾Œã¯èµ¤ã¸ */
				    );
				    border: 3px solid #eee;
				    border-radius: 25px;
				    position: relative;
				    overflow: hidden;
				}

				#gauge-bar {
				    width: 0%;
				    height: 50%;
				    position: absolute;
				    top: 25%;
				    left: 0;
				    border-radius: 10px;
				    background-color: rgba(255, 255, 255, 0.7);
				    box-shadow: 0 0 15px rgba(255,255,255,0.8);
				    transition: width 0.02s linear, background-color 0.3s ease;
				    will-change: width;
				    z-index: 10;
				}

				.blind-overlay {
				    position: absolute;
				    top: 0;
				    left: 35%;
				    width: 30%;
				    height: 100%;
				    background: #000;
				    z-index: 15;
				    display: none;
				    box-shadow: 0 0 40px 30px #000;
				}
				.gauge-container.is-blinded .blind-overlay { display: block; }

				/* --- ãƒœã‚¿ãƒ³ --- */
				.btn-roll {
				    width: 85%;
				    height: 65px;
				    font-size: 1.5rem;
				    font-weight: bold;
				    border-radius: 35px;
				    border: none;
				    cursor: pointer;
				    background: #4caf50;
				    color: white;
				    margin: 10px auto;
				    display: block;
				}

				.btn-roll:disabled {
				    background: #444 !important;
				    color: #888 !important; /* å¾…æ©Ÿä¸­ã‚‚é»’ããªã‚‰ãšã€èª­ã¿ã‚„ã™ã„ã‚°ãƒ¬ãƒ¼ */
				    -webkit-text-fill-color: #888; /* Safariç”¨ */
				}

				/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
				@keyframes shake {
				    0%, 100% { transform: translate(0, 0); }
				    25% { transform: translate(-2px, -2px); }
				    50% { transform: translate(2px, 2px); }
				}
				.rolling { animation: shake 0.1s infinite; transition: none !important; }
    </style>
</head>
<body>

<body>
    <div class="box">
        <h2 id="room-name-display">èª­ã¿è¾¼ã¿ä¸­...</h2>
        <div id="turn-display">ç›¸æ‰‹ã®ç•ªã‚’å¾…ã£ã¦ã„ã¾ã™</div>
        <hr>

        <div id="result-message"></div>

        <div class="dice-area">
            <div id="d1" class="dice"></div>
            <div id="d2" class="dice"></div>
            <div id="d3" class="dice"></div>
        </div>

        <div id="curse-display-area">
            <div id="curse-status-display"></div>
        </div>

        <div class="gauge-container">
            <div id="gauge-bar"></div>
            <div class="blind-overlay"></div>
            <div style="position:absolute; left:50%; width:2px; height:100%; background:rgba(255,255,255,0.4); z-index:5;"></div>
        </div>

        <button id="roll-btn" class="btn-roll" onclick="handleButtonClick()" disabled>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="show-result-btn" class="btn-roll" style="display: none; background: #ff9800;" onclick="finalizeGame()">çµæœã‚’è¡¨ç¤ºã™ã‚‹</button>

        <div id="result-screen" style="display: none; background: #333; padding: 15px; border-radius: 12px; margin-top: 15px;">
            <h3 style="margin-top:0;">å¯¾æˆ¦çµæœ</h3>
            <div id="ranking-list" style="text-align: left;"></div>
            <button id="restart-btn" class="btn-roll" style="background: #2196f3; height: 50px; font-size: 1.2rem;" onclick="handleRestart()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
        </div>
    </div>
</body>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, onDisconnect, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDXQstrCY2Xo6MG5aKcM_orNxhddlDx3rA",
        authDomain: "dice-a59f3.firebaseapp.com",
        projectId: "dice-a59f3",
        storageBucket: "dice-a59f3.firebasestorage.app",
        messagingSenderId: "1013783488303",
        appId: "1:1013783488303:web:828116dfd3852ff85de3da",
        measurementId: "G-5GFX1S7DHQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('id');
    const myId = params.get('uid');
    const myName = params.get('uname');

		let currentRoomData = null; // ãƒ«ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let gaugeInterval = null;
    let gaugeValue = 0;
    let safeMin = 40; 
    let safeMax = 60; 

    const roomRef = roomId ? ref(db, `rooms/${roomId}`) : null;
    const myPlayerRef = (roomId && myId) ? ref(db, `rooms/${roomId}/players/${myId}`) : null;

    if (!roomId || !myId) {
        alert("ç„¡åŠ¹ãªã‚¢ã‚¯ã‚»ã‚¹ã§ã™");
        window.location.href = "lobby.html";
    } else {
        onDisconnect(myPlayerRef).remove(); 
        update(myPlayerRef, { name: myName, isReady: true });

				onValue(roomRef, (snapshot) => {
				    currentRoomData = snapshot.val();
				    if (!currentRoomData || !currentRoomData.players) return;

				    const curses = currentRoomData.activeCurses || {};
				    const curseTargetId = currentRoomData.curseTarget;
				    const isTarget = curseTargetId === myId;
				    const statusEl = document.getElementById('curse-status-display');

				    // --- 1. å‘ªã„ã®æ¼”å‡ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆå…¨å“¡åŒæœŸç‰ˆï¼‰ ---
				    let activeMessages = [];
				    if (curses.blind) activeMessages.push("æš—é»’");
				    if (curses.fast) activeMessages.push("ç¥é€Ÿ");
				    if (curses.badLuck) activeMessages.push("ä¸å¹¸");

				    // èª°ã‹ãŒå‘ªã‚ã‚Œã¦ã„ã‚‹ã€ã‹ã¤ãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã¾ã éƒ¨å±‹ã«ã„ã‚‹å ´åˆ
				    if (activeMessages.length > 0 && currentRoomData.players[curseTargetId]) {
				        const targetName = currentRoomData.players[curseTargetId].name;
				        const curseText = activeMessages.join("ãƒ»");

				        if (isTarget) {
				            // ã€æœ¬äººã®ç”»é¢ã€‘èƒŒæ™¯ã‚’èµ¤ãã—ã€è­¦å‘Šã‚’å‡ºã™
				            document.body.classList.add('curse-active');
				            statusEl.innerHTML = `<span style="font-size: 0.8rem; color: #ffeb3b;">âš ï¸ ã‚ãªãŸã«å—å‘ªä¸­</span><br>${curseText}`;
				            if (document.getElementById('result-message')) {
				                document.getElementById('result-message').style.color = "#ff6080";
				            }
				        } else {
				            // ã€ä»–äººã®ç”»é¢ã€‘èƒŒæ™¯ã¯é€šå¸¸ã€èª°ãŒå‘ªã‚ã‚Œã¦ã„ã‚‹ã‹ã ã‘è¡¨ç¤º
				            document.body.classList.remove('curse-active');
				            statusEl.innerHTML = `<span style="font-size: 0.9rem; color: #fff;">ğŸ’€ ${targetName} ãŒå—å‘ªä¸­</span><br><span style="color: #ff4d4d;">${curseText}</span>`;
				            if (document.getElementById('result-message')) {
				                document.getElementById('result-message').style.color = "#fff";
				            }
				        }
				    } else {
				        // èª°ã‚‚å‘ªã‚ã‚Œã¦ã„ãªã„
				        document.body.classList.remove('curse-active');
				        statusEl.innerText = "";
				        if (document.getElementById('result-message')) {
				            document.getElementById('result-message').style.color = "#fff";
				        }
				    }

				    // --- ä»¥é™ã€æ—¢å­˜ã®UIåˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ ---
				    const turnDisplay = document.getElementById('turn-display');
				    const btn = document.getElementById('roll-btn');
				    const diceArea = document.querySelector('.dice-area');
				    const gaugeContainer = document.querySelector('.gauge-container');
				    const resultScreen = document.getElementById('result-screen');
				    const msgEl = document.getElementById('result-message');
				    const showResultBtn = document.getElementById('show-result-btn');

				    document.getElementById('room-name-display').innerText = currentRoomData.roomName;
				    const turnPlayerId = currentRoomData.currentTurnPlayer;

				    if (turnPlayerId === "finished") {
				        if (diceArea) diceArea.style.display = 'none';
				        if (gaugeContainer) gaugeContainer.style.display = 'none';
				        if (btn) btn.style.display = 'none';
				        showResult(currentRoomData);
				    } else if (turnPlayerId === "waiting_result") {
				        turnDisplay.innerText = "å…¨å“¡ãŒæŒ¯ã‚Šçµ‚ã‚ã‚Šã¾ã—ãŸ";
				        if (btn) btn.style.display = "none";
				        if (showResultBtn) showResultBtn.style.display = (currentRoomData.hostId === myId) ? "block" : "none";
				    } else {
				        if (diceArea) diceArea.style.display = 'flex';
				        if (gaugeContainer) gaugeContainer.style.display = 'block';
				        if (btn) btn.style.display = 'block';
				        if (resultScreen) resultScreen.style.display = 'none';
				        if (showResultBtn) showResultBtn.style.display = "none";

				        if (turnPlayerId === myId) {
				            turnDisplay.innerText = "ã‚ãªãŸã®ç•ªã§ã™";
				            btn.disabled = false;
				            if (btn.innerText !== "ã‚¹ãƒˆãƒƒãƒ—") {
				                btn.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
				                btn.style.background = "#4caf50";
				            }
				        } else {
				            const turnOwnerName = currentRoomData.players[turnPlayerId] ? currentRoomData.players[turnPlayerId].name : "ä¸æ˜";
				            turnDisplay.innerText = `<span style="color: #ffffff;">${turnOwnerName}ã®ç•ªã§ã™</span>`;
				            btn.disabled = true;
				            btn.innerText = "å¾…æ©Ÿä¸­...";
				            btn.style.background = "#555";
				            stopGauge(); 
				        }
				    }

				    if (!currentRoomData.lastRoll) {
				        resetGaugeUI();
				        if (msgEl) msgEl.innerText = "";
				        const d1 = document.getElementById('d1');
				        const d2 = document.getElementById('d2');
				        const d3 = document.getElementById('d3');
				        [d1, d2, d3].forEach(d => {
				            d.classList.remove('rolling');
				            d.style.transform = "translate(0, 0) rotate(0deg)";
				        });
				        d1.innerHTML = getDiceHTML(1);
				        d2.innerHTML = getDiceHTML(1);
				        d3.innerHTML = getDiceHTML(1);

				        if (typeof remoteRollInterval !== 'undefined' && remoteRollInterval) {
				            clearInterval(remoteRollInterval);
				            remoteRollInterval = null;
				        }
				    } else {
				        updateDiceUI(currentRoomData.lastRoll);
				        const rollCount = currentRoomData.lastRoll.rollCount;
				        if (rollCount > 0 && turnPlayerId === myId && !currentRoomData.lastRoll.isRolling) {
				            if (msgEl && !msgEl.innerText.includes('å›ç›®')) {
				                msgEl.innerText += `ï¼ˆ${rollCount}å›ç›®ï¼‰`;
				            }
				        }
				    }
				});
    }

		// ãƒœã‚¿ãƒ³åˆ¶å¾¡ç”¨ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
		window.handleButtonClick = () => {
		    const btn = document.getElementById('roll-btn');
		    
		    if (btn.innerText === "ã‚¹ã‚¿ãƒ¼ãƒˆ") {
		        // --- ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç† ---
						document.getElementById('gauge-bar').style.width = "0%";
		        gaugeValue = 0;
		        loopCount = 0;

		        btn.innerText = "ã‚¹ãƒˆãƒƒãƒ—";
		        btn.style.background = "#e63946"; // ã‚¹ãƒˆãƒƒãƒ—ã¯èµ¤ç³»
		        startGauge();
		    } else {
		        // --- ã‚¹ãƒˆãƒƒãƒ—å‡¦ç† ---
		        btn.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
		        btn.style.background = "#4caf50"; // æ¬¡ã®ã‚¹ã‚¿ãƒ¼ãƒˆã«å‘ã‘ã¦ç·‘ç³»ã«
		        handleRoll(); // æ—¢å­˜ã®ã‚µã‚¤ã‚³ãƒ­ç¢ºå®šãƒ»é€ä¿¡å‡¦ç†
		    }
		};

		let loopCount = 0; // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ—å›æ•°
		const maxLoops = 5; // æœ€å¤§5å›ï¼ˆç·‘3å›ã€é»„1å›ã€èµ¤1å›ï¼‰

		// æ—¢å­˜ã® startGauge å†…ã®ç›£è¦–ã‚’å°‘ã—ä¿®æ­£
		function startGauge() {
		    if (gaugeInterval) return;

				// Firebaseã‹ã‚‰å–å¾—ã—ãŸæœ€æ–°ãƒ‡ãƒ¼ã‚¿(currentRoomDataã¨ã™ã‚‹)ã‚’ç¢ºèª
				// currentRoomData ãŒ undefined ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å…¥ã‚Œã‚‹
		    const curses = (currentRoomData && currentRoomData.activeCurses) ? currentRoomData.activeCurses : {};
		    const curseTargetId = currentRoomData ? currentRoomData.curseTarget : null;
		    const isTarget = curseTargetId === myId;

		    // â‘  é€Ÿåº¦ã®æ±ºå®šï¼ˆå‘ªã‚ã‚Œã¦ã„ã‚Œã°3å€é€Ÿã€ãã†ã§ãªã‘ã‚Œã°é€šå¸¸ï¼‰
	  	  let currentSpeed = (isTarget && curses.fast) ? 6 : 3;

	   	 	// â‘¡ ç›®éš ã—ã®è¡¨ç¤º
				const container = document.querySelector('.gauge-container');
				if (container) {
					if (isTarget && curses.blind) {
		 	       container.classList.add('is-blinded'); // CSSã§ä¸­å¤®ã‚’éš ã™
		 	 		} else {
		 	       container.classList.remove('is-blinded');
					}
				}

		    gaugeValue = 0;
		    loopCount = 0;
		    const maxLoops = 5; // æ˜ç¤ºçš„ã«æŒ‡å®š

		    // lastRollå…¨ä½“ã‚’ä¸Šæ›¸ãã›ãšã€isRollingãƒ•ãƒ©ã‚°ã ã‘ã‚’ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§æ›´æ–°
		    // ã“ã‚Œã«ã‚ˆã‚Š playerName ãªã©ã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¿æŒã•ã‚Œã¾ã™
		    update(ref(db, `rooms/${roomId}/lastRoll`), { isRolling: true });

		    gaugeInterval = setInterval(() => {
		        gaugeValue += currentSpeed;
		        
		        if (gaugeValue >= 100) {
		            gaugeValue = 0;
		            loopCount++;
		            
		            if (loopCount >= maxLoops) {
		                // ã€é‡è¦ã€‘å…ˆã«ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹ï¼ˆforceOutã¨ã®ç«¶åˆã‚’é˜²ãï¼‰
		                clearInterval(gaugeInterval);
		                gaugeInterval = null;

		                // è¦‹ãŸç›®ã‚’æº€ã‚¿ãƒ³ã«ã—ã¦ã‹ã‚‰å¼·åˆ¶çµ‚äº†
		                const bar = document.getElementById('gauge-bar');
		                if (bar) bar.style.width = "100%";

		                const btn = document.getElementById('roll-btn');
		                btn.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
		                btn.style.background = "#4caf50";
		                
		                forceOut();
		                return;
		            }
		        }
		        
		        // --- ã‚²ãƒ¼ã‚¸æç”» ---
		        const bar = document.getElementById('gauge-bar');
		        if (bar) {
		            bar.style.width = gaugeValue + "%";
		            if (loopCount < 3) bar.style.background = "#40cf7080";
		            else if (loopCount === 3) bar.style.background = "#ffeb3b80";
		            else bar.style.background = "#f4433680";
		        }

		        // --- ã‚µã‚¤ã‚³ãƒ­ã®æš´ã‚Œæ¼”å‡º ---
		        // è‡ªåˆ†ã®ç”»é¢ã§ã¯é«˜é€Ÿã«å‹•ã‹ã™
		        const d1 = document.getElementById('d1');
		        const d2 = document.getElementById('d2');
		        const d3 = document.getElementById('d3');
		        const power = (loopCount * 15) + (gaugeValue * 0.3); // é£›ã³å‡ºã—ã™ããªã„ã‚ˆã†å°‘ã—èª¿æ•´

		        [d1, d2, d3].forEach(el => {
		            const x = (Math.random() - 0.5) * power * 2;
		            const y = (Math.random() - 0.5) * power * 2;
		            const deg = Math.random() * 360;
		            el.style.transform = `translate(${x}px, ${y}px) rotate(${deg}deg)`;
		            el.innerHTML = getDiceHTML(Math.floor(Math.random() * 6) + 1); 
		        });
		    }, 20);
		}

		function updateGaugeUI() {
		    const bar = document.getElementById('gauge-bar');
		    if (!bar) return;
		    
		    // ã‚²ãƒ¼ã‚¸ã®é•·ã•ã‚’æ›´æ–°
		    bar.style.width = gaugeValue + "%";
		    
		    // å‘¨å›æ•°ï¼ˆloopCountï¼‰ã«åŸºã¥ããƒãƒ¼ã®è‰²è¨­å®š
		    // 0~2å‘¨ç›®ï¼ˆ3å›ç›®ã¾ã§ï¼‰: ç·‘
		    // 3å‘¨ç›®ï¼ˆ4å›ç›®ï¼‰: é»„è‰²
		    // 4å‘¨ç›®ï¼ˆ5å›ç›®ï¼‰: èµ¤
		    if (loopCount < 3) {
		        bar.style.backgroundColor = "#2ecc71c0"; // é®®ã‚„ã‹ãªç·‘
		    } else if (loopCount === 3) {
		        bar.style.backgroundColor = "#f1c40fc0"; // é»„è‰²
		    } else {
		        bar.style.backgroundColor = "#e74c3cc0"; // èµ¤ï¼ˆæœ€çµ‚å‘¨ï¼‰
		    }
		}

		// ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—æ™‚ã®å¼·åˆ¶ã‚·ãƒ§ãƒ³ãƒ™ãƒ³é–¢æ•°
		async function forceOut() {
		    // 1. ã‚²ãƒ¼ã‚¸ã‚’æ­¢ã‚ã‚‹
		    stopGauge();

		    // æ¼”å‡ºç”¨ã®å‡ºç›®ï¼ˆè¦‹ãŸç›®ã ã‘é©å½“ãªç›®ã«ã™ã‚‹ï¼‰
		    const dVals = [
		        Math.floor(Math.random() * 6) + 1,
		        Math.floor(Math.random() * 6) + 1,
		        Math.floor(Math.random() * 6) + 1
		    ];
		    
		    try {
		        const snapshot = await get(roomRef);
		        const data = snapshot.val();
						if (!data) return;

		        const playerIds = Object.keys(data.players);
		        const myIndex = playerIds.indexOf(myId);

						// è‡ªåˆ†ã®åå‰ã‚’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç¢ºå®Ÿã«å–å¾—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° myName ã§ã‚‚å¯ï¼‰
		        const myActualName = data.players[myId].name || "ä¸æ˜";

		        // --- æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ±ºå®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ ---
		        let nextPlayerId;
		        if (myIndex < playerIds.length - 1) {
		            // ã¾ã æ¬¡ã®äººãŒã„ã‚‹å ´åˆ
		            nextPlayerId = playerIds[myIndex + 1];
		        } else {
		            // è‡ªåˆ†ãŒæœ€å¾Œã®äººã ã£ãŸå ´åˆ
		            nextPlayerId = "waiting_result";
		        }

		        // 2. è‡ªåˆ†ã®å€‹åˆ¥ã‚¹ã‚³ã‚¢ã‚’ã€Œã‚·ãƒ§ãƒ³ãƒ™ãƒ³ã€ã§æ›´æ–°
		        await update(ref(db, `rooms/${roomId}/players/${myId}`), {
		            lastScore: -100,
		            lastResultName: "ã‚·ãƒ§ãƒ³ãƒ™ãƒ³"
		        });

		        // 3. ãƒ«ãƒ¼ãƒ å…¨ä½“ã®å…±æœ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆlastRollï¼‰ã¨æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚’æ›´æ–°
		        await update(roomRef, {
		            lastRoll: { 
		                values: [0, 0, 0], // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ç”¨
		                displayValues: dVals, 
										playerName: myActualName,
		                rollCount: 0,
		                isRolling: false // ç¢ºå®Ÿã«æ­¢ã‚ã‚‹
		            },
		            currentTurnPlayer: nextPlayerId
		        });

		    } catch (e) {
		        console.error("forceOut Error:", e);
		    }
		}

		function stopGauge() {
		    if (gaugeInterval) {
		        clearInterval(gaugeInterval);
		        gaugeInterval = null;
		    }
		}

		function getOutProbability(value) {
		    const center = 50;
		    const safeHalfWidth = 10; // ã‚°ãƒªãƒ¼ãƒ³ã‚¾ãƒ¼ãƒ³ã®åºƒã•ï¼ˆ40ã€œ60ãŒå®‰å…¨ï¼‰
		    const distanceFromCenter = Math.abs(value - center);

		    let prob = 0;

		    if (distanceFromCenter <= safeHalfWidth) {
		        // --- ã‚°ãƒªãƒ¼ãƒ³ã‚¾ãƒ¼ãƒ³å†… ---
		        // ã‚¾ãƒ¼ãƒ³å†…ã§ã‚‚ç«¯ã«ã„ãã»ã©å¾®å¢—ã•ã›ã‚‹ï¼ˆ0% ã€œ 10% ç¨‹åº¦ï¼‰
		        prob = (distanceFromCenter / safeHalfWidth) * 0.1;
		    } else {
		        // --- ã‚°ãƒªãƒ¼ãƒ³ã‚¾ãƒ¼ãƒ³å¤–ï¼ˆä¸€æ­©ã§ã‚‚ã¯ã¿å‡ºãŸï¼ï¼‰ ---
		        // ã¯ã¿å‡ºãŸç¬é–“ã« 0.5 (50%) ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã€ç«¯(50)ã«ã„ãã»ã© 1.0 ã«è¿‘ã¥ã
		        const overflowDistance = distanceFromCenter - safeHalfWidth;
		        const maxOverflow = 50 - safeHalfWidth; // 40
		        
		        prob = 0.5 + (overflowDistance / maxOverflow) * 0.5;
		    }

		    return Math.min(1.0, prob);
		}

    function getDiceHTML(num) {
        const dotPositions = {
            1: [4], 2: [0, 8], 3: [0, 4, 8],
            4: [0, 2, 6, 8], 5: [0, 2, 4, 6, 8], 6: [0, 3, 6, 2, 5, 8]
        };
        const positions = dotPositions[num] || [];
        let dots = "";
        for(let i=0; i<9; i++) {
            dots += positions.includes(i) ? '<div class="dot"></div>' : '<div></div>';
        }
        return `<div class="dice" data-value="${num}">${dots}</div>`;
    }

		// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼å¤‰æ•°ï¼ˆé–¢æ•°ã®å¤–ã«å®šç¾©ï¼‰
		let remoteRollInterval = null;

		function updateDiceUI(rollData) {
		    if (!rollData) return;

				const pName = rollData.playerName || "";
		    const values = rollData.values || [1, 1, 1];
		    const d = rollData.displayValues || values;
		    const msgEl = document.getElementById('result-message');
		    const isRolling = rollData.isRolling;

		    const d1 = document.getElementById('d1');
		    const d2 = document.getElementById('d2');
		    const d3 = document.getElementById('d3');
		    const area = document.querySelector('.dice-area');

		    if (isRolling) {
		        // --- èª°ã‹ãŒæŒ¯ã£ã¦ã„ã‚‹æœ€ä¸­ ---
						msgEl.innerText = pName ? `${pName} ãŒæŒ¯ã£ã¦ã„ã¾ã™...` : "æŒ¯ã£ã¦ã„ã¾ã™...";
		        msgEl.style.color = "#ffffff";
		        
		        // ã™ã§ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ã„ã¦ã„ãªã‘ã‚Œã°é–‹å§‹
		        if (!remoteRollInterval) {
		            remoteRollInterval = setInterval(() => {
		                // åº§æ¨™ã‚’é«˜é€Ÿã«ãƒ©ãƒ³ãƒ€ãƒ åŒ–ï¼ˆã©ã‚“ã¶ã‚Šã®ä¸­ã§é£›ã³è·³ã­ã•ã›ã‚‹ï¼‰
		                const randPos = () => Math.floor(Math.random() * 80) - 40; // -40px ~ 40px
		                const randRot = () => Math.floor(Math.random() * 360);

		                d1.style.transform = `translate(${randPos()}px, ${randPos()}px) rotate(${randRot()}deg)`;
		                d2.style.transform = `translate(${randPos()}px, ${randPos()}px) rotate(${randRot()}deg)`;
		                d3.style.transform = `translate(${randPos()}px, ${randPos()}px) rotate(${randRot()}deg)`;

		                // ç›®ã‚‚ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰ãˆã‚‹
		                d1.innerHTML = getDiceHTML(Math.floor(Math.random() * 6) + 1);
		                d2.innerHTML = getDiceHTML(Math.floor(Math.random() * 6) + 1);
		                d3.innerHTML = getDiceHTML(Math.floor(Math.random() * 6) + 1);
		            }, 50); // 0.05ç§’ã”ã¨ã«æ¿€ã—ãå‹•ã‹ã™
		        }
		    } else {
		        // --- æ­¢ã¾ã£ãŸæ™‚ ---
		        // å‹•ã„ã¦ã„ãŸã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
		        if (remoteRollInterval) {
		            clearInterval(remoteRollInterval);
		            remoteRollInterval = null;
		        }

		        d1.innerHTML = getDiceHTML(d[0]);
		        d2.innerHTML = getDiceHTML(d[1]);
		        d3.innerHTML = getDiceHTML(d[2]);

		        if (values[0] === 0) {
		            // ã‚·ãƒ§ãƒ³ãƒ™ãƒ³é…ç½®
		            d1.style.transform = "translate(-130px, -100px) rotate(-110deg)";
		            d2.style.transform = "translate(20px, -150px) rotate(200deg)";
		            d3.style.transform = "translate(120px, 60px) rotate(45deg)";
		            area.style.borderColor = "#ff4d4d";
		            msgEl.innerText = "ã‚·ãƒ§ãƒ³ãƒ™ãƒ³";
		            msgEl.style.color = "#ff4d4d";
		        } else {
		            // é€šå¸¸ç¢ºå®šé…ç½®
		            d1.style.transform = "translate(-2px, -42px) rotate(5deg)";
		            d2.style.transform = "translate(-40px, 24px) rotate(-10deg)";
		            d3.style.transform = "translate(36px, 24px) rotate(12deg)";
		            area.style.borderColor = "#8d6e63";

		            const result = judge(values);
		            msgEl.innerText = result.name;
		            msgEl.style.color = "#ffd11a";
		        }
		    }
		}

		function judge(dice) {
		    // 0. ã‚·ãƒ§ãƒ³ãƒ™ãƒ³åˆ¤å®šï¼ˆforceOutã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ [0,0,0] ã®ã‚±ãƒ¼ã‚¹ï¼‰
		    if (!dice || dice[0] === 0) {
		        return { name: "ã‚·ãƒ§ãƒ³ãƒ™ãƒ³", score: -100 };
		    }

		    // åˆ¤å®šã—ã‚„ã™ãã™ã‚‹ãŸã‚ã«æ˜‡é †ï¼ˆå°ã•ã„é †ï¼‰ã«ä¸¦ã³æ›¿ãˆã‚‹
		    const sorted = [...dice].sort((a, b) => a - b);
		    const [a, b, c] = sorted;

		    // 1. ã‚¾ãƒ­ç›®ï¼ˆã‚¢ãƒ©ã‚·ï¼‰
		    if (a === b && b === c) {
		        if (a === 1) {
		            return { name: "ãƒ”ãƒ³ã‚¾ãƒ­", score: 1000 }; // æœ€å¼·
		        }
		        return { name: a + "ã®ã‚¾ãƒ­ç›®", score: 500 + a }; // ä»–ã®å½¹ã‚ˆã‚Šåœ§å€’çš„ã«å¼·ã
		    }

		    // 2. ã‚·ã‚´ãƒ­ (4, 5, 6)
		    if (a === 4 && b === 5 && c === 6) {
		        return { name: "ã‚·ã‚´ãƒ­", score: 300 };
		    }

		    // 3. ãƒ’ãƒ•ãƒŸ (1, 2, 3)
		    if (a === 1 && b === 2 && c === 3) {
		        return { name: "ãƒ’ãƒ•ãƒŸ", score: -50 }; // å½¹ãªã—(0)ã‚ˆã‚Šå¼±ãã€ã‚·ãƒ§ãƒ³ãƒ™ãƒ³(-100)ã‚ˆã‚Šã¯ãƒã‚·
		    }

		    // 4. ç›®ã‚ã‚Šï¼ˆ2ã¤ã®ã‚µã‚¤ã‚³ãƒ­ãŒåŒã˜ã§ã€æ®‹ã‚Šã®1ã¤ãŒã€Œç›®ã€ã«ãªã‚‹ï¼‰
		    // ä¾‹: [2, 2, 5] ãªã‚‰ã€Œ5ã®ç›®ã€
		    // ã‚¹ã‚³ã‚¢ã¯ã€Œç›®ã€ã®æ•°å€¤ï¼ˆ1ã€œ6ï¼‰Ã—10 ã¨ã™ã‚‹ã“ã¨ã§ã€å½¹ãªã—(0)ã‚ˆã‚Šå¼·ãã—ã¾ã™
		    if (a === b) return { name: c + "ã®ç›®", score: c * 10 };
		    if (b === c) return { name: a + "ã®ç›®", score: a * 10 };

		    // 5. å½¹ãªã—ï¼ˆç›®ãªã—ï¼‰
		    return { name: "å½¹ãªã—", score: 0 };
		}

		// å…¨å“¡ã®é †ä½ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
		function showResult(data) {
		    // 1. ç”»é¢è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
		    document.querySelector('.dice-area').style.display = 'none';
		    document.querySelector('.gauge-container').style.display = 'none';
		    document.getElementById('roll-btn').style.display = 'none';
		    document.getElementById('show-result-btn').style.display = "none";

		    const resultScreen = document.getElementById('result-screen');
		    const rankingList = document.getElementById('ranking-list');
		    resultScreen.style.display = 'block';

		    // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
		    const players = data.players;
		    const sortedList = Object.keys(players).map(id => ({
		        name: players[id].name,
		        result: players[id].lastResultName || "å½¹ãªã—",
		        score: players[id].lastScore || 0
		    })).sort((a, b) => b.score - a.score);

		    // 3. åŒé †ä½ã‚’è€ƒæ…®ã—ãŸHTMLã®ç”Ÿæˆï¼ˆã‚¹ã‚³ã‚¢éè¡¨ç¤ºï¼‰
		    let displayRank = 1;
		    rankingList.innerHTML = sortedList.map((p, i) => {
		        // 2äººç›®ä»¥é™ã§ã€å‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ˆã‚Šã‚¹ã‚³ã‚¢ãŒä½ã„å ´åˆã®ã¿é †ä½ã‚’æ›´æ–°
		        if (i > 0 && p.score < sortedList[i - 1].score) {
		            displayRank = i + 1;
		        }

		        return `
		            <div style="border-bottom: 1px solid #444; padding: 12px; display: flex; align-items: center;">
		                <span style="width: 60px; font-weight: bold; color: #ffd11a;">${displayRank}ä½</span>
		                <span style="flex: 1; text-align: left; font-size: 1.1rem;"><strong>${p.name}</strong></span>
		                <span style="color: #ccc; font-size: 0.9rem;">${p.result}</span>
		            </div>
		        `;
		    }).join('');

		    // 4. ãƒ›ã‚¹ãƒˆãªã‚‰å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
		    if (data.hostId === myId) {
		        document.getElementById('restart-btn').style.display = 'block';
		    }
		}

		function resetGaugeUI() {
		    gaugeValue = 0;
		    loopCount = 0;
		    const bar = document.getElementById('gauge-bar');
		    if (bar) {
		        bar.style.width = "0%";
		        bar.style.background = "#4caf50";
		    }
		}

		//==================================
		//	â†“â†“â†“â†“â†“	ä»˜åŠ è¦ç´ 	â†“â†“â†“â†“â†“
		//==================================
		// ã‚¿ãƒ¼ãƒ³ã®åˆ‡ã‚Šæ›¿ã‚ã‚Šã‚’ç›£è¦–ã™ã‚‹å ´æ‰€ã«è¿½åŠ 
		async function setupTurnCurses(nextPlayerId, isCurseMode) {
		    if (!isCurseMode) return; // ãã‚‚ãã‚‚ãƒ¢ãƒ¼ãƒ‰ãŒOFFãªã‚‰ä½•ã‚‚ã—ãªã„

		    // å„å‘ªã„ãŒç‹¬ç«‹ã—ã¦æŠ½é¸ã•ã‚Œã‚‹ï¼ˆé‡è¤‡ã‚ã‚Šï¼‰
		    const curses = {
		        blind: Math.random() < 0.3,   // 30%ã§ç›®éš ã—
		        fast: Math.random() < 0.3,    // 30%ã§é«˜é€ŸåŒ–
		        badLuck: Math.random() < 0.3  // 30%ã§å‡ºç›®å¼±ä½“åŒ–
		    };

		    // Firebaseã«ä»Šå›ã®ã‚¿ãƒ¼ãƒ³ã®å‘ªã„çŠ¶æ…‹ã‚’æ›¸ãè¾¼ã‚€
		    await update(ref(db, `rooms/${roomId}`), {
		        activeCurses: curses,
		        curseTarget: nextPlayerId
		    });
		}

		function getDiceValues(isBadLuck) {
		    // å‘ªã‚ã‚Œã¦ã„ã‚‹å ´åˆã€3å‰²ã®ç¢ºç‡ã§ãƒ’ãƒ•ãƒŸã«ã™ã‚‹
		    if (isBadLuck && Math.random() < 0.3) {
		        return [1, 2, 3].sort(() => Math.random() - 0.5);
		    }
		    // é€šå¸¸ã®ãƒ©ãƒ³ãƒ€ãƒ 
		    return [
		        Math.floor(Math.random() * 6) + 1,
		        Math.floor(Math.random() * 6) + 1,
		        Math.floor(Math.random() * 6) + 1
		    ];
		}

		// å‘ªã„ã‚’æŠ½é¸ã™ã‚‹é–¢æ•°
		function generateRandomCurses(isCurseMode) {
		    // å¦¨å®³ãƒ¢ãƒ¼ãƒ‰ãŒOFFãªã‚‰ã™ã¹ã¦false
		    if (!isCurseMode) return { blind: false, fast: false, badLuck: false };

		    // 1. ã¾ãšã€Œå‘ªã„ãŒç™ºç”Ÿã™ã‚‹ã‹ã©ã†ã‹ã€ã‚’åˆ¤å®šï¼ˆä¾‹ï¼š70%ã§ç™ºç”Ÿï¼‰
		    if (Math.random() < 0.7) {
		        // 2. ç™ºç”Ÿã™ã‚‹å ´åˆã€ã©ã‚Œã‹1ã¤ã¯ã€Œå¿…ãšã€ONã«ã™ã‚‹
		        const curses = {
		            blind: Math.random() < 0.5,
		            fast: Math.random() < 0.5,
		            badLuck: Math.random() < 0.5
		        };

		        // ã‚‚ã—å…¨éƒ¨falseã«ãªã£ã¡ã‚ƒã£ãŸã‚‰ã€ã©ã‚Œã‹1ã¤ã‚’å¼·åˆ¶çš„ã«ON
		        if (!curses.blind && !curses.fast && !curses.badLuck) {
		            const keys = ['blind', 'fast', 'badLuck'];
		            const randomKey = keys[Math.floor(Math.random() * keys.length)];
		            curses[randomKey] = true;
		        }
		        return curses;
		    }

		    // 30%ã®ç¢ºç‡ã§ã€Œå¹³å’Œãªã‚¿ãƒ¼ãƒ³ã€
		    return { blind: false, fast: false, badLuck: false };
		}

		//==================================
		//	â†‘â†‘â†‘â†‘â†‘	ä»˜åŠ è¦ç´ 	â†‘â†‘â†‘â†‘â†‘
		//==================================


		window.finalizeGame = async () => {
		    try {
		        await update(roomRef, {
		            currentTurnPlayer: "finished"
		        });
		    } catch (e) {
		        console.error(e);
		    }
		};

		// ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™é–¢æ•°ï¼ˆãƒ›ã‚¹ãƒˆå°‚ç”¨ï¼‰
		window.handleRestart = async () => {
		    try {
		        const snapshot = await get(roomRef);
		        const data = snapshot.val();
		        const playerIds = Object.keys(data.players);
		        
		        const updates = {};
		        playerIds.forEach(id => {
		            updates[`players/${id}/lastScore`] = 0;
		            updates[`players/${id}/lastResultName`] = "";
		        });
		        
		        updates['currentTurnPlayer'] = playerIds[0];
		        updates['lastRoll'] = null;
		        // --- è¿½åŠ ï¼šã‚²ãƒ¼ã‚¸ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ ---
		        updates['currentGaugeValue'] = 0; 

		        await update(roomRef, updates);

		        // ãƒ›ã‚¹ãƒˆè‡ªèº«ã®UIã‚’å³æ™‚ãƒªã‚»ãƒƒãƒˆ
		        resetGaugeUI();
		        
		        document.getElementById('show-result-btn').style.display = 'none';
		        document.getElementById('result-screen').style.display = 'none';
		        document.querySelector('.dice-area').style.display = 'flex';
		        document.querySelector('.gauge-container').style.display = 'block';
		        document.getElementById('roll-btn').style.display = 'block';
		        document.getElementById('result-message').innerText = "";
		    } catch (e) {
		        console.error("å†ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:", e);
		    }
		};

		window.handleRoll = async () => {
		    stopGauge();
		    
		    const prob = getOutProbability(gaugeValue);
		    const isOut = Math.random() < prob;
		    
		    // ã€è¿½åŠ ã€‘ã€Œä¸å¹¸ã®å‘ªã„ã€ãŒã‹ã‹ã£ã¦ã„ã‚‹å ´åˆã®å‡ºç›®æ“ä½œ
		    const curses = currentRoomData?.activeCurses || {};
		    const isTarget = currentRoomData?.curseTarget === myId;
		    let dVals;
		    if (isTarget && curses.badLuck && Math.random() < 0.4) {
		        // å‘ªã„ï¼š40%ã®ç¢ºç‡ã§ 1,2,3 ãªã©ã®å¼±ã„ç›®ã«ã™ã‚‹
		        dVals = [1, 2, 3].sort(() => Math.random() - 0.5);
		    } else {
		        dVals = [
		            Math.floor(Math.random() * 6) + 1,
		            Math.floor(Math.random() * 6) + 1,
		            Math.floor(Math.random() * 6) + 1
		        ];
		    }

		    const finalValues = isOut ? [0, 0, 0] : dVals;

		    try {
		        const snapshot = await get(roomRef);
		        const data = snapshot.val();
		        if (!data || !data.players) return;

		        const playerIds = Object.keys(data.players);
		        
		        let currentRollCount = 1;
		        if (data.lastRoll && data.lastRoll.playerName === myName) {
		            const lastCount = Number(data.lastRoll.rollCount || 0);
		            currentRollCount = lastCount > 0 ? lastCount + 1 : 1;
		        }

		        const result = judge(dVals);
		        const isNone = result.name === "å½¹ãªã—";
		        const shouldSwitch = isOut || !isNone || currentRollCount >= 3;

		        let nextPlayerId = myId; 
		        let rollCountToSave = currentRollCount; 

		        // --- å‘ªã„ã®æº–å‚™ ---
		        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œä»Šã®å‘ªã„ã€ã‚’ç¶­æŒ
		        let nextCurses = data.activeCurses || { blind: false, fast: false, badLuck: false };
		        let nextCurseTarget = data.curseTarget || myId;

		        if (shouldSwitch) {
		            const myPlayerRef = ref(db, `rooms/${roomId}/players/${myId}`);
		            await update(myPlayerRef, {
		                lastResultName: isOut ? "ã‚·ãƒ§ãƒ³ãƒ™ãƒ³" : result.name,
		                lastScore: isOut ? -100 : result.score
		            });

		            const currentIndex = playerIds.indexOf(myId);
		            if (currentIndex === playerIds.length - 1) {
		                nextPlayerId = "waiting_result"; 
		                // å…¨å“¡çµ‚ã‚ã£ãŸã‚‰å‘ªã„ã‚’ã‚¯ãƒªã‚¢
		                nextCurses = { blind: false, fast: false, badLuck: false };
		                nextCurseTarget = "none";
		            } else {
		                nextPlayerId = playerIds[currentIndex + 1];
		                // ã€é‡è¦ã€‘æ¬¡ã®äººã¸å›ã‚‹æ™‚ã ã‘ã€æ–°ã—ã„å‘ªã„ã‚’ç”Ÿæˆ
		                nextCurses = generateRandomCurses(data.isCurseMode);
		                nextCurseTarget = nextPlayerId;
		            }
		            rollCountToSave = 0; 
		        }

		        // --- æœ€çµ‚çš„ãªDBæ›´æ–° ---
		        await update(roomRef, {
		            lastRoll: { 
		                values: finalValues, 
		                displayValues: dVals, 
		                playerName: myName,
		                rollCount: rollCountToSave
		            },
		            currentTurnPlayer: nextPlayerId,
		            activeCurses: nextCurses,
		            curseTarget: nextCurseTarget
		        });

		    } catch (e) {
		        console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
		    }
		};

</script>
</body>
</html>