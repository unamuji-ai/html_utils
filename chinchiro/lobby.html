<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICEãƒ­ãƒ“ãƒ¼</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; }
        .container { max-width: 500px; margin: auto; padding: 20px; }
        .box { background: #2a2a2a; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }
        input { padding: 12px; width: 80%; border-radius: 8px; border: none; margin-bottom: 10px; font-size: 16px; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .create-btn { background: #e63946; color: white; }
        .join-btn { background: #457b9d; color: white; margin-top: 5px; }
        ul { list-style: none; padding: 0; }
        li { background: #333; margin: 10px 0; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #e63946; }
        .room-info { text-align: left; }
        .room-name { font-weight: bold; color: #fff; }
        .player-count { font-size: 0.8rem; color: #aaa; }
        #lobby-ui, #game-room-ui { display: none; }
        #lobby-ui.active, #game-room-ui.active { display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ² DICEãƒ­ãƒ“ãƒ¼</h2>

    <div id="name-setup" class="box active">
        <input type="text" id="user-name" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›" maxlength="10">
        <button class="btn create-btn" onclick="confirmName()">ãƒ­ãƒ“ãƒ¼ã«å…¥ã‚‹</button>
    </div>

    <div id="lobby-ui" class="box">
        <div style="margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 15px;">
            <input type="text" id="new-room-name" placeholder="æ–°ã—ã„éƒ¨å±‹ã®åå‰">
            <button class="btn create-btn" onclick="createRoom()">ï¼‹ éƒ¨å±‹ã‚’ä½œã‚‹</button>
        </div>
        <h3>å…¬é–‹ä¸­ã®éƒ¨å±‹</h3>
        <ul id="room-list"></ul>
    </div>

		<div id="game-room-ui" class="box">
		    <h3 id="display-room-name">éƒ¨å±‹å</h3>
		    <p style="font-size: 0.9rem; color: #ffd11a;">ãƒ«ãƒ¼ãƒ ID: <span id="display-room-id"></span></p>
		    <hr>
		    <h4>å‚åŠ è€…ãƒªã‚¹ãƒˆ</h4>
		    <ul id="player-list"></ul>
		    
		    <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
						<div id="host-controls" style="display:none; border: 1px solid #ffd11a; padding: 15px; border-radius: 8px; background: rgba(255, 209, 26, 0.1); margin-bottom: 10px;">
						    <label style="display: flex; align-items: center; justify-content: flex-start; gap: 8px; margin-bottom: 15px; cursor: pointer; text-align: left;">
						        <input type="checkbox" id="curse-mode-check" style="width: 18px; height: 18px; cursor: pointer;"> 
						        <span style="color: #ffd11a; font-weight: bold; font-size: 0.95rem;">å¦¨å®³ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
						    </label>
						    <button id="start-game-btn" class="btn create-btn" style="width: 100%;" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button>
						</div>
		        <button class="btn join-btn" onclick="leaveRoom()">éƒ¨å±‹ã‚’æŠœã‘ã‚‹</button>
		    </div>
		</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, onDisconnect, remove, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
				  apiKey: "AIzaSyDXQstrCY2Xo6MG5aKcM_orNxhddlDx3rA",
				  authDomain: "dice-a59f3.firebaseapp.com",
				  projectId: "dice-a59f3",
				  storageBucket: "dice-a59f3.firebasestorage.app",
				  messagingSenderId: "1013783488303",
				  appId: "1:1013783488303:web:828116dfd3852ff85de3da",
				  measurementId: "G-5GFX1S7DHQ"
		};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myName = "";
    let myId = "p_" + Math.random().toString(36).substr(2, 9);
    let currentRoomId = null;

    window.confirmName = () => {
        const input = document.getElementById('user-name').value.trim();
        if (input.length < 2) return alert("åå‰ã‚’2æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„");
        myName = input;
        document.getElementById('name-setup').classList.remove('active');
        document.getElementById('lobby-ui').classList.add('active');
        listenToRooms();
    };

    function listenToRooms() {
        const roomsRef = ref(db, 'rooms');
        onValue(roomsRef, (snapshot) => {
            const rooms = snapshot.val();
            const listEl = document.getElementById('room-list');
            listEl.innerHTML = "";
            
            if (!rooms) {
                listEl.innerHTML = "<p style='color:#888'>ç¾åœ¨ã€éƒ¨å±‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
                return;
            }

            Object.entries(rooms).forEach(([id, data]) => {
                // ã€ã‚´ãƒŸæƒé™¤ã€‘ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ãªã„éƒ¨å±‹ã‚’è¦‹ã¤ã‘ãŸã‚‰å³å‰Šé™¤
                if (!data.players || Object.keys(data.players).length === 0) {
                    remove(ref(db, `rooms/${id}`));
                    return;
                }

                if (data.status !== "waiting") return;

                const pCount = Object.keys(data.players).length;
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">${data.roomName}</div>
                        <div class="player-count">å‚åŠ è€…: ${pCount}å / ãƒ›ã‚¹ãƒˆ: ${data.hostName}</div>
                    </div>
                    <button class="btn join-btn" style="width:auto; padding: 8px 15px;" onclick="joinRoom('${id}')">å‚åŠ </button>
                `;
                listEl.appendChild(li);
            });
        });
    }


		window.createRoom = async () => {
		    const nameInput = document.getElementById('new-room-name');
		    const roomName = nameInput.value.trim() || "ç„¡åã®éƒ¨å±‹";
		    
		    // pushã§å‚ç…§ã‚’å…ˆã«ä½œã‚‹
		    const roomsListRef = ref(db, 'rooms');
		    const newRoomRef = push(roomsListRef); 
		    currentRoomId = newRoomRef.key;

		    const initialData = {
		        roomName: roomName,
		        hostName: myName,
		        hostId: myId,
		        status: "waiting",
		        createdAt: Date.now(),
		        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã‚’åˆæœŸã‹ã‚‰æŒãŸã›ã‚‹
		        players: {
		            [myId]: { name: myName, isReady: false }
		        }
		    };

		    try {
		        // æ›¸ãè¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤
		        await set(newRoomRef, initialData);
		        enterRoom(currentRoomId, true);
		    } catch (e) {
		        console.error("Create Room Error:", e);
		    }
		};

		function enterRoom(roomId, isHost) {
		    const roomPath = `rooms/${roomId}`;
		    const playerRef = ref(db, `${roomPath}/players/${myId}`);
		    
		    set(playerRef, { name: myName, isReady: false });

		    const myDisconnect = onDisconnect(playerRef);
		    myDisconnect.remove();

		    document.getElementById('lobby-ui').classList.remove('active');
		    document.getElementById('game-room-ui').classList.add('active');
		    document.getElementById('display-room-id').innerText = roomId;

		    onValue(ref(db, `rooms/${roomId}`), (snapshot) => {
		        const data = snapshot.val();
		        if (!data) return;

		        if (data.status === "playing") {
		            myDisconnect.cancel();
		            window.location.href = `game.html?id=${roomId}&uid=${myId}&uname=${encodeURIComponent(myName)}`;
		            return; 
		        }

		        const players = data.players || {};
		        const playerIds = Object.keys(players);
		        let currentHostId = data.hostId;

		        // --- ãƒ›ã‚¹ãƒˆæ˜‡æ ¼ãƒ­ã‚¸ãƒƒã‚¯ ---
		        if (!currentHostId || !players[currentHostId]) {
		            if (playerIds.length > 0) {
		                const nextHostId = playerIds[0];
		                if (nextHostId === myId) {
		                    currentHostId = myId;
		                    update(ref(db, `rooms/${roomId}`), { hostId: myId, hostName: myName });
		                }
		            }
		        }

		        updatePlayerList(players, currentHostId);

		        // --- UIã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆä¿®æ­£ç®‡æ‰€ï¼‰ ---
		        const amIHost = (currentHostId === myId);
		        const hostControls = document.getElementById('host-controls'); 
		        const startBtn = document.getElementById('start-game-btn');

		        if (amIHost && hostControls && startBtn) {
		            hostControls.style.display = 'block'; 

		            // å‚åŠ äººæ•°ãŒ2äººä»¥ä¸Šã®ã¨ãã ã‘æ´»æ€§åŒ–
		            if (playerIds.length >= 2) {
		                startBtn.disabled = false;
		                startBtn.style.opacity = "1";
		                startBtn.style.cursor = "pointer";
		                startBtn.innerText = "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼";
		            } else {
		                // äººæ•°ãŒè¶³ã‚Šãªã„ã¨ã
		                startBtn.disabled = true;
		                startBtn.style.opacity = "0.5";
		                startBtn.style.cursor = "not-allowed";
		                startBtn.innerText = `ã‚ã¨${2 - playerIds.length}åã§é–‹å§‹å¯èƒ½`;
		            }
		        } else if (hostControls) {
		            hostControls.style.display = 'none'; 
		        }
		    });
		}

    window.joinRoom = (roomId) => {
        currentRoomId = roomId;
        enterRoom(roomId, false);
    };

		function updatePlayerList(players, hostId) {
		    const listEl = document.getElementById('player-list');
		    listEl.innerHTML = "";
		    if (!players) return;

		    Object.entries(players).forEach(([id, info]) => {
		        const li = document.createElement('li');
		        
		        // åŸºæœ¬ã®åå‰è¡¨ç¤º
		        let displayName = info.name;
		        
		        // è‡ªåˆ†ã®å ´åˆã¯ (ã‚ãªãŸ) ã‚’ä»˜ä¸
		        if (id === myId) {
		            displayName += " (ã‚ãªãŸ)";
		        }

		        // ãƒ›ã‚¹ãƒˆã®å ´åˆã¯ ğŸ‘‘ãƒãƒ¼ã‚¯ ã‚’ä»˜ä¸
		        if (id === hostId) {
		            li.style.borderLeft = "4px solid #ffd11a"; // ãƒ›ã‚¹ãƒˆã ã‘æ ç·šã®è‰²ã‚’å¤‰ãˆã‚‹
		            li.innerHTML = `<span style="color: #ffd11a;">ğŸ‘‘</span> ${displayName} <span style="font-size: 0.7rem; background: #555; padding: 2px 5px; border-radius: 4px; margin-left: 5px;">HOST</span>`;
		        } else {
		            li.innerText = displayName;
		        }

		        listEl.appendChild(li);
		    });
		}

    // å®‰å…¨ãªé€€å®¤ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    async function safeLeaveRoom(roomId, myId) {
        const roomRef = ref(db, `rooms/${roomId}`);
        try {
            await runTransaction(roomRef, (currentData) => {
                if (currentData) {
                    if (currentData.players && currentData.players[myId]) {
                        delete currentData.players[myId];
                    }
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ0äººãªã‚‰éƒ¨å±‹ã”ã¨å‰Šé™¤
                    const remaining = currentData.players ? Object.keys(currentData.players).length : 0;
                    if (remaining === 0) return null; 
                }
                return currentData;
            });
        } catch (error) {
            console.error("Leave error:", error);
        }
    }

    window.leaveRoom = async () => {
        if (!currentRoomId) return;
        await safeLeaveRoom(currentRoomId, myId);
        location.reload();
    };


		window.startGame = async () => {
		    if (!currentRoomId) return;
		    const roomRef = ref(db, `rooms/${currentRoomId}`);
		    
		    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å–å¾—
		    const curseEnabled = document.getElementById('curse-mode-check').checked;
		    
		    try {
		        const snapshot = await get(roomRef);
		        const data = snapshot.val();

		        if (data && data.players) {
		            const playerIds = Object.keys(data.players);
								const firstPlayerId = playerIds[0]; // æœ€åˆã®äºº

		            // å¦¨å®³ãƒ¢ãƒ¼ãƒ‰ãŒONãªã‚‰ã€æœ€åˆã®äººã«ã‚‚å‘ªã„ã‚’æŠ½é¸ã™ã‚‹
		            const curseEnabled = document.getElementById('curse-mode-check').checked;
		            const initialCurses = generateRandomCurses(curseEnabled);		            

		            await update(roomRef, {
		                status: "playing",
										currentTurnPlayer: firstPlayerId,
		                isCurseMode: curseEnabled, // å¦¨å®³ãƒ¢ãƒ¼ãƒ‰ãŒONã‹ã©ã†ã‹ã‚’ä¿å­˜
										activeCurses: initialCurses, // â† ã“ã“ã§æœ€åˆã®äººã¸ã®å‘ªã„ã‚’ã‚»ãƒƒãƒˆï¼
                		curseTarget: firstPlayerId   // â† ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚‚æœ€åˆã®äººã«
		            });
		        }
		    } catch (error) {
		        console.error("é–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
		    }
		};

		// å‘ªã„ã‚’æŠ½é¸ã™ã‚‹é–¢æ•°
		function generateRandomCurses(isCurseMode) {
		    // å¦¨å®³ãƒ¢ãƒ¼ãƒ‰ãŒOFFãªã‚‰ã™ã¹ã¦false
		    if (!isCurseMode) return { blind: false, fast: false, badLuck: false };

		    // 1. ã¾ãšã€Œå‘ªã„ãŒç™ºç”Ÿã™ã‚‹ã‹ã©ã†ã‹ã€ã‚’åˆ¤å®šï¼ˆä¾‹ï¼š70%ã§ç™ºç”Ÿï¼‰
		    if (Math.random() < 0.7) {
		        // 2. ç™ºç”Ÿã™ã‚‹å ´åˆã€ã©ã‚Œã‹1ã¤ã¯ã€Œå¿…ãšã€ONã«ã™ã‚‹
		        const curses = {
		            blind: Math.random() < 0.5,
		            fast: Math.random() < 0.5,
		            badLuck: Math.random() < 0.5
		        };

		        // ã‚‚ã—å…¨éƒ¨falseã«ãªã£ã¡ã‚ƒã£ãŸã‚‰ã€ã©ã‚Œã‹1ã¤ã‚’å¼·åˆ¶çš„ã«ON
		        if (!curses.blind && !curses.fast && !curses.badLuck) {
		            const keys = ['blind', 'fast', 'badLuck'];
		            const randomKey= keys[Math.floor(Math.random() * keys.length)];
		            curses[randomKey] = true;
		        }
		        return curses;
		    }

		    // 30%ã®ç¢ºç‡ã§ã€Œå¹³å’Œãªã‚¿ãƒ¼ãƒ³ã€
		    return { blind: false, fast: false, badLuck: false };
		}

</script>
</body>
</html>