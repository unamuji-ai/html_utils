<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Online Lobby</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        /* 全体：スマホで文字が勝手に拡大されないように調整 */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            text-align: center; background: #1a1a1a; color: #eee; margin: 0; padding: 15px;
            touch-action: manipulation;
        }
        
        h2 { font-size: 1.5rem; margin-top: 10px; color: #fff; }

        .box { 
            background: #2a2a2a; border-radius: 16px; padding: 20px; 
            margin: 10px auto; max-width: 400px; border: 1px solid #444;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* ボタン：スマホの親指で押しやすいサイズ(最小44px以上) */
        .btn { 
            padding: 18px; font-size: 18px; margin: 10px 0; border: none; 
            border-radius: 12px; cursor: pointer; font-weight: bold; 
            width: 100%; display: block;
            box-shadow: 0 3px 0 #8d2630;
        }
        .host-btn { background: #e63946; color: white; box-shadow: 0 4px 0 #b32d38; }
        .host-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #b32d38; }
        
        .guest-btn { background: #457b9d; color: white; box-shadow: 0 4px 0 #1d3557; }
        .guest-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #1d3557; }

        /* QRコード：スマホ画面で見やすい白背景 */
        #qrcode { 
            background: white; padding: 10px; display: inline-block; 
            margin: 15px auto; border-radius: 12px; 
        }
        #qrcode img { width: 200px !important; height: 200px !important; }

        /* ビデオ：スマホカメラのアスペクト比を維持 */
        #v-container { 
            position: relative; width: 100%; max-width: 320px; 
            margin: 0 auto; overflow: hidden; border-radius: 16px; 
            background: #000; display: none;
        }
        video { width: 100%; height: auto; display: block; }
        
        /* 手入力エリア */
        #manual-id { 
            padding: 15px; border-radius: 8px; border: 2px solid #457b9d; 
            width: 80%; background: #000; color: #fff; font-size: 20px; 
            text-align: center; margin-bottom: 10px;
        }

        /* ゲーム画面：スマホの全画面を活用 */
        #game-frame { 
            display: none; width: 100vw; height: 100vh; 
            position: fixed; top: 0; left: 0; border: none; 
            background: #fff; z-index: 9999;
        }

        .room-id-text {
            font-size: 32px; font-weight: bold; color: #ffd11a;
            margin: 10px 0; letter-spacing: 5px;
        }
    </style>
</head>
<body>

    <div id="lobby-ui">
				<div id="setup-ui">
				    <h3>遊ぶゲームを選択</h3>
				    <div style="margin-bottom: 20px; text-align: left; display: inline-block;">
				        <label style="display: block; margin-bottom: 10px; cursor: pointer;">
				            <input type="radio" name="game-select" value="hitnblow"> 
				            <strong>Hit & Blow</strong> (数字当てゲーム)
				        </label>
				        <label style="display: block; margin-bottom: 10px; cursor: pointer; color: #888;">
				            <input type="radio" name="game-select" value="geister" checked> 
				            ガイスター（心理戦ゲーム） 
				        </label>
				    </div>
				    <br>
				    <button class="btn" onclick="initP2P(true)">ホストとして部屋を作る</button>
				    <button class="btn" onclick="initP2P(false)">ゲストとして参加する</button>
				</div>

        <div id="host-ui" style="display:none;">
            <div class="box">
                <p>相手にこのQRを読ませるか、<br>5桁のIDを教えてください</p>
                <div id="qrcode"></div>
                <div class="room-id-text" id="room-id-display"></div>
            </div>
        </div>

        <div id="guest-ui" style="display:none;">
            <div id="v-container">
                <video id="video" playsinline></video>
                <canvas id="qr-canvas" style="display:none;"></canvas>
            </div>
            
            <div class="box" id="input-area">
                <p>IDを手入力して接続：</p>
                <input type="number" pattern="\d*" id="manual-id" placeholder="12345">
                <button class="btn guest-btn" onclick="handleManualInput()">接続する</button>
            </div>
        </div>
    </div>

    <iframe id="game-frame"></iframe>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

				// For Firebase JS SDK v7.20.0 and later, measurementId is optional
				const firebaseConfig = {
				  apiKey: "AIzaSyBghe53eweW5j3zPe55skV8YXFMPpRwdjc",
				  authDomain: "connectp2p-1ba54.firebaseapp.com",
				  databaseURL: "https://connectp2p-1ba54-default-rtdb.firebaseio.com",
				  projectId: "connectp2p-1ba54",
				  storageBucket: "connectp2p-1ba54.firebasestorage.app",
				  messagingSenderId: "34700692828",
				  appId: "1:34700692828:web:b20ce75b17862e849f4599",
				  measurementId: "G-DZ6TVZBKBG"
				};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let pc, dataChannel, isHost, roomRef;
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
				let selectedGame = "hitnblow"; // デフォルト値

        window.initP2P = async (hostMode) => {
				    // 接続開始時に、選択されているラジオボタンの値を取得する
				    const selected = document.querySelector('input[name="game-select"]:checked');
				    if (selected) {
				        selectedGame = selected.value;
				    }

            isHost = hostMode;
            document.getElementById('setup-ui').style.display = 'none';
            pc = new RTCPeerConnection(config);

            if (isHost) {
                document.getElementById('host-ui').style.display = 'block';
                const roomId = Math.floor(10000 + Math.random() * 90000).toString();
                document.getElementById('room-id-display').innerText = roomId;
                roomRef = ref(db, 'rooms/' + roomId);

                new QRCode(document.getElementById("qrcode"), {
                    text: roomId, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.L
                });

                dataChannel = pc.createDataChannel("gameChannel");
                setupDataEvents();

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                pc.onicecandidate = e => {
                    if (!e.candidate) {
                        set(roomRef, { offer: { type: pc.localDescription.type, sdp: pc.localDescription.sdp } });
                    }
                };

                onValue(roomRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.answer && !pc.remoteDescription) {
                        pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });

            } else {
                document.getElementById('guest-ui').style.display = 'block';
                pc.ondatachannel = e => { dataChannel = e.channel; setupDataEvents(); };
                startScan();
            }
        };

        async function connectByRoomId(id) {
            stopScan();
            document.getElementById('v-container').style.display = 'none';
            document.getElementById('input-area').style.display = 'none';
            roomRef = ref(db, 'rooms/' + id);

            onValue(roomRef, async (snapshot) => {
                const data = snapshot.val();
                if (data && data.offer && !pc.remoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    pc.onicecandidate = e => {
                        if (!e.candidate) {
                            update(roomRef, { answer: { type: pc.localDescription.type, sdp: pc.localDescription.sdp } });
                        }
                    };
                }
            });
        }

				function setupDataEvents() {
				    dataChannel.onopen = () => {
				        remove(roomRef);
				        
				        // 1. ホストの場合、選択中のゲーム名を相手（ゲスト）に送る
				        if (isHost) {
				            const gameName = document.querySelector('input[name="game-select"]:checked').value;
				            dataChannel.send(JSON.stringify({ type: "SYSTEM_START", game: gameName }));
				            
				            // 自分も起動
				            launchGame(gameName, "host");
				        }
				    };

				    dataChannel.onmessage = e => {
				        const data = JSON.parse(e.data);
				        
				        // 2. ゲストの場合、ホストから送られてきたゲーム名で起動する
				        if (data.type === "SYSTEM_START") {
				            launchGame(data.game, "guest");
				        } else {
				            // それ以外のメッセージ（ゲーム中のデータ）は子画面へ転送
				            document.getElementById('game-frame').contentWindow.postMessage(data, "*");
				        }
				    };
				}

				// ゲーム画面を起動する共通関数
				function launchGame(gameFile, role) {
				    setTimeout(() => {
				        document.getElementById('lobby-ui').style.display = "none";
				        const frame = document.getElementById('game-frame');
				        frame.src = `${gameFile}.html?role=${role}`;
				        frame.style.display = "block";
				    }, 500);
				}

        window.addEventListener("message", (e) => {
            if (dataChannel && dataChannel.readyState === "open") {
                dataChannel.send(JSON.stringify(e.data));
            }
        });

        // カメラ制御
        const video = document.getElementById("video");
        const canvas = document.getElementById("qr-canvas");
        const ctx = canvas.getContext("2d");
        let scanReq;

        async function startScan() {
            document.getElementById('v-container').style.display = 'block';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.play();
                scanReq = requestAnimationFrame(tick);
            } catch (e) {
            }
        }

        function stopScan() {
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            cancelAnimationFrame(scanReq);
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight; canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) { connectByRoomId(code.data); return; }
            }
            scanReq = requestAnimationFrame(tick);
        }

        window.handleManualInput = () => {
            const id = document.getElementById('manual-id').value;
            if (id) connectByRoomId(id);
        };
    </script>
</body>
</html>