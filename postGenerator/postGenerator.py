import streamlit as st
import pandas as pd
import plotly.express as px
import random

# ページ設定
st.set_page_config(page_title="あなたに対するネット上の評価", layout="centered")

# --- セッション状態の初期化 ---
if 'step' not in st.session_state:
    st.session_state.step = 0
if 'answers' not in st.session_state:
    st.session_state.answers = []
# sales: 営業火力, mental: 対人胆力, risk: 爆弾指数, compliance: 規律遵守
if 'points' not in st.session_state:
    st.session_state.points = {"sales": 0, "mental": 0, "risk": 0, "compliance": 0}

# --- 劇薬化された設問データ ---
# 配点順: (営業火力, 対人胆力, 爆弾指数, 規律遵守)
questions = [
    # SNS・自撮り編
    {"q": "自撮りの投稿傾向は？", "options": [
        ("清楚・美少女系", (5, 0, -10, 50)), 
        ("グラビア系", (25, 15, 15, 0)), 
        ("露出・エロ寄り", (45, 45, 60, -50)), 
        ("病み・地雷系", (15, -15, 30, 0))]},
    {"q": "客へのSNS営業のメイン手法は？", "options": [
        ("ポストのみ", (-10, -20, 0, 40)), 
        ("DMで「今日いるよ！」", (15, 5, 5, 20)), 
        ("DMで「寂しい」", (35, 25, 30, -10)), 
        ("DMで「今日来て！何時くる？」", (50, 40, 20, -20))]},
    {"q": "SNSでの返信・いいね運用は？", "options": [
        ("ほとんどしない", (-20, -30, 0, 30)), 
        ("出勤日にいいねだけ", (-5, 10, 10, 30)), 
        ("太客・オキニには厚めに", (40, 30, 40, -10)), 
        ("気まぐれに適当", (15, 15, 15, 15))]},

    # 接客・ドリンク編
    {"q": "ドリンクのねだり方は？", "options": [
        ("いただけてもよろしいですか？", (5, -10, -5, 50)), 
        ("ねー、なんか飲んでいい？", (30, 20, 20, -10)), 
        ("無言で見つめる", (40, 40, 30, 10)), 
        ("喉乾いちゃった🥺", (25, 15, 15, 5))]},
    {"q": "チェキ撮影時の物理的距離は？", "options": [
        ("ソーシャルディスタンス", (-20, -10, -10, 50)), 
        ("こぶし一つ分", (10, 5, 5, 30)), 
        ("多少の接触まで", (35, 25, 25, 0)), 
        ("完全な接触・密着", (60, 50, 60, -50))]},
    
    # ガチ恋対応編
    {"q": "【リアル】「付き合ってるよね？」と手を重ねてこられたら？", "options": [
        ("「秘密だよ」と指を絡める", (60, 60, 50, -60)), 
        ("えー何飲んでいい？と高額ボトル要求", (10, 40, 50, 0)), 
        ("笑いながら僅かだけ許容", (40, 20, 20, 0)), 
        ("「接触はNGだよ」と制する", (-30, -40, -20, 60))]},
    {"q": "【DM】深夜3時の就寝前「誰かと一緒？不安」という粘着DMには？", "options": [
        ("「もう寝るとこ、おやすみ」", (20, 10, 0, 10)), 
        ("未読放置", (-10, -20, 0, 40)), 
        ("翌朝「ごめん、寝てた」の一言", (10, 0, 5, 30)), 
        ("出勤前まで既読放置", (5, -10, 0, 30))]},
    
    # 説教対応編
    {"q": "【リアル】「君の自撮りは良くない、そもそも髪型が…」と説教され始めたら？", "options": [
        ("「えーどんなのが好き？」とじっくり聞く", (40, 50, -10, 30)), 
        ("「好みは人それぞれだからね」と軽く流す", (5, 10, 5, 20)), 
        ("「喉乾いた！お茶飲んでいい？」と話題を変える", (-10, 20, 15, 15)), 
        ("「自分がかわいいと思えばいいの！」と反論", (-20, 30, 30, 5))]},
    {"q": "【DM】客から長文のダメ出しDMが届いたら？", "options": [
        ("改善する（フリ）の返信をする", (50, 50, -10, 30)), 
        ("スクショしていつか晒す、その場は無視", (-20, 30, 40, -10)), 
        ("「はいはいｗ」とスタンプ1個で終了", (-15, 20, 20, 10)), 
        ("ブロックorミュート設定", (-40, -50, 20, 10))]},
    
    # 下ネタ・セクハラ編
    {"q": "【リアル】「最近いつした？」と聞かれたら？", "options": [
        ("「出勤前」と即答", (50, 60, 50, -40)), 
        ("えー何を？ととぼける", (0, -10, -10, 20)), 
        ("「シャンパン入れてくれたら教える」", (30, 25, 20, 10)), 
        ("「セクハラなら普通に引きます」と断絶", (-20, -50, -10, 60))]},
    {"q": "【DM】太客から卑猥な画像と共に「そっちのも送って」と来たら？", "options": [
        ("「いくらのボトル下ろすかによる」", (20, 60, 30, -30)), 
        ("「びっくり!ちっさw」と煽る", (-30, 50, 20, -10)), 
        ("無言で既読スルー", (0, -10, 0, 30)), 
        ("運営に報告・ブロック相談", (0, 10, -30, 50))]},

    # 特殊客編
    {"q": "【素伝】ドリンク出さない客への対応は？", "options": [
        ("「来てくれるだけいいよ」と聖母対応", (45, 40, 20, 10)), 
        ("「話すると喉渇くんだよね〜」と圧", (15, 20, 15, 10)), 
        ("挨拶だけで放置", (-20, -15, 10, 30)), 
        ("ダメもとでドリンクおねだり", (-10, 10, 5, 20))]},
    {"q": "【推し変】目の前で他の子を褒め始めたら？", "options": [
        ("「他の子がいいんだ」と拗ねる", (40, 20, 10, -10)), 
        ("「あの子可愛いよね！」と割り切る", (5, 10, 5, 30)), 
        ("温度を0にして放置", (10, -10, 15, 20)), 
        ("「ふーん、あっそ、バイバイｗ」と切り捨てる", (20, 0, 10, 0))]},
    {"q": "【臭い客】至近距離で臭いがきつい時は？", "options": [
        ("笑顔で耐えて香水を撒く", (20, 40, 5, 30)), 
        ("常に距離をキープ", (5, -10, 0, 20)), 
        ("ファブリーズを撒く", (10, 30, 30, -20)), 
        ("「お風呂入ってきた？ｗ」と指摘", (-10, 40, 20, -30))]},
    {"q": "【繋がり要求】「本名とLINE教えて」と言われたら？", "options": [
        ("「もっと仲良くなったらね」", (30, 30, 20, 10)), 
        ("「店辞めたら教えるかも」", (45, 20, 50, -20)), 
        ("「無理ｗ」", (0, 10, 5, 20)), 
        ("「ルール違反。次言ったら出禁」", (-30, 30, -20, 60))]},
    {"q": "【店外要求】「今後ご飯行こう」と誘われたら？", "options": [
        ("「おいしい所なら！」と言いながら絶対行かない", (55, 40, 15, -40)), 
        ("「100万くらい使ってくれたら考える」", (15, 40, 30, 10)), 
        ("相手次第", (5, 30, 60, -60)), 
        ("「解雇になっちゃうんで…」で断る", (-20, -20, -20, 60))]},
    
    # 詰め編
    {"q": "シャンパンが入った時のリアクションは？", "options": [
        ("実際の感情以上に喜ぶ", (30, 10, 30, 30)), 
        ("「お礼は何がいい？」とする気もない話をする", (50, 45, 20, -10)), 
        ("淡々と、でも丁寧に御礼", (10, -10, 5, 30)), 
        ("「次回は別のもほしいな」", (20, 30, 20, 10))]},
    {"q": "客が他の客と喧嘩し始めたら？", "options": [
        ("オーナーもしくは警察を呼ぶ", (0, -10, 20, 50)), 
        ("「他のお客様の迷惑なので」と注意する", (-10, 30, -10, 40)), 
        ("誰かがどうにかするだろ、で放置", (0, -30, 10, -30)), 
        ("面白いので煽る", (0, 30, 60, -50))]},
    {"q": "卒業時群がってくる繋がり厨への対応は？", "options": [
        ("「卒業したら会おうね」と嘘をつき通す", (60, 50, 40, -50)), 
        ("「もう会えないけどありがとう」で乗り切る", (-20, -10, -20, 50)), 
        ("相手による", (10, -10, 40, -40)), 
        ("「転生するまで待ってて」で次に引っ張る", (20, 20, 10, 20))]},
    {"q": "最後に。あなたにとって「客」とは？", "options": [
        ("人生を豊かにしてくれる存在", (30, 30, 20, 30)), 
        ("ただの「ATM（金）」", (-30, 30, 50, 0)), 
        ("適度な距離で楽しむ遊び相手", (15, 10, 10, 40)), 
        ("接客という仕事の攻略対象", (15, 25, 10, 20))]}
]

TOTAL_STEPS = len(questions)

# --- 画面描画 ---
if st.session_state.step == 0:
    st.title("🌐 コンカフェ嬢のあなたのまとめ")
    st.warning("⚠️ **診断の際のお願い**\n\n特定の個人や状況に限定せず、**平均的な自身の振る舞い**をイメージして回答してください。")
    name = st.text_input("源氏名を入力してください", key="name_input")
    if st.button("診断を開始"):
        if name:
            st.session_state.name = name
            st.session_state.step = 1
            st.rerun()

elif 1 <= st.session_state.step <= TOTAL_STEPS:
    idx = st.session_state.step - 1
    q_data = questions[idx]
    st.write(f"第 {st.session_state.step} 問 / {TOTAL_STEPS}")
    st.progress(st.session_state.step / TOTAL_STEPS)
    st.subheader(q_data["q"])
    choice_text = st.radio("選択肢：", [opt[0] for opt in q_data["options"]], index=None, key=f"q_{st.session_state.step}")
    if st.button("次へ →"):
        if choice_text:
            selected_opt = next(opt for opt in q_data["options"] if opt[0] == choice_text)
            st.session_state.points["sales"] += selected_opt[1][0]
            st.session_state.points["mental"] += selected_opt[1][1]
            st.session_state.points["risk"] += selected_opt[1][2]
            st.session_state.points["compliance"] += selected_opt[1][3]
            st.session_state.step += 1
            st.rerun()

else:
    st.balloons()
    st.title(f"📊 {st.session_state.name} さんの分析結果")
    
    # --- スコア計算（平滑化防止のため分母を調整） ---
    s = max(min(st.session_state.points["sales"] // 4, 100), 0)
    m = max(min(st.session_state.points["mental"] // 4, 100), 0)
    r = max(min(st.session_state.points["risk"] // 4, 100), 0)
    c = max(min(st.session_state.points["compliance"] // 4, 100), 0)

    # --- レーダーチャート ---
    df = pd.DataFrame(dict(
        r=[s, m, r, c],
        theta=['営業火力', '対人胆力', '爆弾指数', '規律遵守']
    ))
    fig = px.line_polar(df, r='r', theta='theta', line_close=True, range_r=[0,100])
    fig.update_traces(fill='toself', line_color='#FF4B4B')
    st.plotly_chart(fig)

    col1, col2 = st.columns(2)
    col1.metric("営業火力", f"{s}%")
    col1.metric("対人胆力", f"{m}%")
    col2.metric("爆弾指数", f"{r}%")
    col2.metric("規律遵守", f"{c}%")

    st.divider()

    # --- タイプ判定ロジック ---
    if c > 75 and s > 75:
        style, desc = "伝説の1000万プレイヤー", "高い規律と圧倒的な営業火力を両立。業界の模範となるトップキャストです。"
    elif r > 70 and m > 70:
        style, desc = "界隈の劇薬・爆弾娘", "対人胆力は最強。リスクを承知で客を沼に沈める、取り扱い注意なカリスマ。"
    elif c > 80 and r < 30:
        style, desc = "鉄壁のプロ・ホワイト嬢", "店のルールを完璧に守る。繋がりを一切感じさせない、運営が最も安心するタイプ。"
    elif m > 80 and s < 40:
        style, desc = "鋼のメンタル・職人職", "痛客の攻撃を真正面から受け流し、淡々と売上を回収するメンタルモンスター。"
    elif s < 30 and c < 40:
        style, desc = "迷い込んだ一般人", "まだ業界の毒に染まっていない。その危うさと純粋さが一部のファンを狂わせます。"
    else:
        style, desc = "バランス型アイドル嬢", "全てのバランスが取れた万能型。立ち回り次第でどんな色にも染まれます。"

    st.success(f"あなたの営業スタイル： **【{style}】**")
    st.write(desc)
    
    # --- タイプ別：SNSスレ反応 ---
    type_replies = {
        "伝説の1000万プレイヤー": [f"「{st.session_state.name}様、昨日もタワー立ててて震えた」「規律遵守も火力もMAXとか、もはやサイボーグだろｗ」"],
        "界隈の劇薬・爆弾娘": [f"「【悲報】{st.session_state.name}、また裏垢投下。これ半分テロだろ」「胆力{m}%は伊達じゃないな。沼ったら最後だぞ」"],
        "鉄壁のプロ・ホワイト嬢": [f"「{st.session_state.name}のガードは鉄壁。DM返信も完璧にマニュアル通りｗ」「でもそこが信頼できるんだよな」"],
        "鋼のメンタル・職人職": [f"「説教1時間耐えて最後に『で、次は何飲む？』って言った{st.session_state.name}マジで強すぎる」「メンタル鋼かよ」"],
        "迷い込んだ一般人": [f"「{st.session_state.name}の素人感がたまらん。悪い太客に捕まる前に通わなきゃ」「今のうちにチェキ撮っとけ」"],
        "バランス型アイドル嬢": [f"「{st.session_state.name}は安定感ある。迷ったらとりあえず会いに行くべき」「最近あそこの店で一番目立ってるわ」"]
    }

    general_replies = [
        f"「お前ら{st.session_state.name}の話しすぎｗ」「↑本人は今頃パトロンと美味い飯食ってるよ、夢見すぎ」「診断結果リアルすぎて草」"
    ]

    st.subheader("💬 SNSまとめスレの反応")
    all_replies = type_replies.get(style, type_replies["バランス型アイドル嬢"]) + general_replies
    for rep in random.sample(all_replies, min(len(all_replies), 3)):
        st.chat_message("user").write(rep)

    if st.button("やり直す"):
        for key in list(st.session_state.keys()): del st.session_state[key]
        st.rerun()