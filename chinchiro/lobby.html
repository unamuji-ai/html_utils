<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICEãƒ­ãƒ“ãƒ¼</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; }
        .container { max-width: 500px; margin: auto; padding: 20px; }
        .box { background: #2a2a2a; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }
        input { padding: 12px; width: 80%; border-radius: 8px; border: none; margin-bottom: 10px; font-size: 16px; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .create-btn { background: #e63946; color: white; }
        .join-btn { background: #457b9d; color: white; margin-top: 5px; }
        ul { list-style: none; padding: 0; }
        li { background: #333; margin: 10px 0; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #e63946; }
        .room-info { text-align: left; }
        .room-name { font-weight: bold; color: #fff; }
        .player-count { font-size: 0.8rem; color: #aaa; }
        #lobby-ui, #game-room-ui { display: none; }
        #lobby-ui.active, #game-room-ui.active { display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ² DICEãƒ­ãƒ“ãƒ¼</h2>

    <div id="name-setup" class="box active">
        <input type="text" id="user-name" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›" maxlength="10">
        <button class="btn create-btn" onclick="confirmName()">ãƒ­ãƒ“ãƒ¼ã«å…¥ã‚‹</button>
    </div>

    <div id="lobby-ui" class="box">
        <div style="margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 15px;">
            <input type="text" id="new-room-name" placeholder="æ–°ã—ã„éƒ¨å±‹ã®åå‰">
            <button class="btn create-btn" onclick="createRoom()">ï¼‹ éƒ¨å±‹ã‚’ä½œã‚‹</button>
        </div>
        <h3>å…¬é–‹ä¸­ã®éƒ¨å±‹</h3>
        <ul id="room-list"></ul>
    </div>

    <div id="game-room-ui" class="box">
        <h3 id="display-room-name">éƒ¨å±‹å</h3>
        <p style="font-size: 0.9rem; color: #ffd11a;">ãƒ«ãƒ¼ãƒ ID: <span id="display-room-id"></span></p>
        <hr>
        <h4>å‚åŠ è€…ãƒªã‚¹ãƒˆ</h4>
        <ul id="player-list"></ul>
        <button class="btn join-btn" onclick="leaveRoom()">éƒ¨å±‹ã‚’æŠœã‘ã‚‹</button>
        <button id="start-btn" class="btn create-btn" style="display:none;" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, onDisconnect, remove, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
				  apiKey: "AIzaSyDXQstrCY2Xo6MG5aKcM_orNxhddlDx3rA",
				  authDomain: "dice-a59f3.firebaseapp.com",
				  projectId: "dice-a59f3",
				  storageBucket: "dice-a59f3.firebasestorage.app",
				  messagingSenderId: "1013783488303",
				  appId: "1:1013783488303:web:828116dfd3852ff85de3da",
				  measurementId: "G-5GFX1S7DHQ"
		};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myName = "";
    let myId = "p_" + Math.random().toString(36).substr(2, 9);
    let currentRoomId = null;

    window.confirmName = () => {
        const input = document.getElementById('user-name').value.trim();
        if (input.length < 2) return alert("åå‰ã‚’2æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„");
        myName = input;
        document.getElementById('name-setup').classList.remove('active');
        document.getElementById('lobby-ui').classList.add('active');
        listenToRooms();
    };

    function listenToRooms() {
        const roomsRef = ref(db, 'rooms');
        onValue(roomsRef, (snapshot) => {
            const rooms = snapshot.val();
            const listEl = document.getElementById('room-list');
            listEl.innerHTML = "";
            
            if (!rooms) {
                listEl.innerHTML = "<p style='color:#888'>ç¾åœ¨ã€éƒ¨å±‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
                return;
            }

            Object.entries(rooms).forEach(([id, data]) => {
                // ã€ã‚´ãƒŸæƒé™¤ã€‘ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ãªã„éƒ¨å±‹ã‚’è¦‹ã¤ã‘ãŸã‚‰å³å‰Šé™¤
                if (!data.players || Object.keys(data.players).length === 0) {
                    remove(ref(db, `rooms/${id}`));
                    return;
                }

                if (data.status !== "waiting") return;

                const pCount = Object.keys(data.players).length;
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">${data.roomName}</div>
                        <div class="player-count">å‚åŠ è€…: ${pCount}å / ãƒ›ã‚¹ãƒˆ: ${data.hostName}</div>
                    </div>
                    <button class="btn join-btn" style="width:auto; padding: 8px 15px;" onclick="joinRoom('${id}')">å‚åŠ </button>
                `;
                listEl.appendChild(li);
            });
        });
    }


		window.createRoom = async () => {
		    const nameInput = document.getElementById('new-room-name');
		    const roomName = nameInput.value.trim() || "ç„¡åã®éƒ¨å±‹";
		    
		    // pushã§å‚ç…§ã‚’å…ˆã«ä½œã‚‹
		    const roomsListRef = ref(db, 'rooms');
		    const newRoomRef = push(roomsListRef); 
		    currentRoomId = newRoomRef.key;

		    const initialData = {
		        roomName: roomName,
		        hostName: myName,
		        hostId: myId,
		        status: "waiting",
		        createdAt: Date.now(),
		        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã‚’åˆæœŸã‹ã‚‰æŒãŸã›ã‚‹
		        players: {
		            [myId]: { name: myName, isReady: false }
		        }
		    };

		    try {
		        // æ›¸ãè¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤
		        await set(newRoomRef, initialData);
		        enterRoom(currentRoomId, true);
		    } catch (e) {
		        console.error("Create Room Error:", e);
		    }
		};

		function enterRoom(roomId, isHost) {
		    const roomPath = `rooms/${roomId}`;
		    const playerRef = ref(db, `${roomPath}/players/${myId}`);
		    
		    // ãƒ›ã‚¹ãƒˆãƒ»ã‚²ã‚¹ãƒˆã«é–¢ã‚ã‚‰ãšã€å¿…ãšè‡ªåˆ†ã‚’ç™»éŒ²ã™ã‚‹ï¼ˆç¢ºå®ŸãªåŒæœŸã®ãŸã‚ï¼‰
		    set(playerRef, { name: myName, isReady: false });

		    // ã€é‡è¦ã€‘å¤‰æ•°ã‚’å®šç¾©ã—ã¦ãŠãã€å¾Œã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
		    const myDisconnect = onDisconnect(playerRef);
		    myDisconnect.remove();

		    document.getElementById('lobby-ui').classList.remove('active');
		    document.getElementById('game-room-ui').classList.add('active');
		    document.getElementById('display-room-id').innerText = roomId;

		    onValue(ref(db, `rooms/${roomId}`), (snapshot) => {
		        const data = snapshot.val();
		        if (!data) { /* ...è§£æ•£å‡¦ç†... */ return; }

		        // --- ã‚²ãƒ¼ãƒ é–‹å§‹åˆ¤å®š ---
		        if (data.status === "playing") {
		            // ã€é‡è¦ã€‘ãƒšãƒ¼ã‚¸é·ç§»ã®ç›´å‰ã«ã€onDisconnectï¼ˆå‰Šé™¤äºˆç´„ï¼‰ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ï¼
		            // ã“ã‚Œã«ã‚ˆã‚Šã€é·ç§»ä¸­ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰è‡ªåˆ†ãŒæ¶ˆãˆã‚‹ã®ã‚’é˜²ãã¾ã™
		            myDisconnect.cancel();
		            
		            window.location.href = `game.html?id=${roomId}&uid=${myId}&uname=${encodeURIComponent(myName)}`;
		            return; 
		        }

		        // --- ä»¥ä¸‹ã€ãƒ›ã‚¹ãƒˆæ˜‡æ ¼ã‚„ãƒªã‚¹ãƒˆæ›´æ–°ãªã©ã®æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ ---
		        const players = data.players || {};
		        const playerIds = Object.keys(players);
		        let currentHostId = data.hostId;

		        if (!currentHostId || !players[currentHostId]) {
		            if (playerIds.length > 0) {
		                const nextHostId = playerIds[0];
		                if (nextHostId === myId) {
		                    currentHostId = myId;
		                    update(ref(db, `rooms/${roomId}`), { hostId: myId, hostName: myName });
		                }
		            }
		        }
		        updatePlayerList(players, currentHostId);
		        const amIHost = (currentHostId === myId);
		        const startBtn = document.getElementById('start-btn');
		        if (amIHost && playerIds.length >= 2) {
		            startBtn.style.display = 'block';
		        } else {
		            startBtn.style.display = 'none';
		        }
		    });
		}

    window.joinRoom = (roomId) => {
        currentRoomId = roomId;
        enterRoom(roomId, false);
    };

		function updatePlayerList(players, hostId) {
		    const listEl = document.getElementById('player-list');
		    listEl.innerHTML = "";
		    if (!players) return;

		    Object.entries(players).forEach(([id, info]) => {
		        const li = document.createElement('li');
		        
		        // åŸºæœ¬ã®åå‰è¡¨ç¤º
		        let displayName = info.name;
		        
		        // è‡ªåˆ†ã®å ´åˆã¯ (ã‚ãªãŸ) ã‚’ä»˜ä¸
		        if (id === myId) {
		            displayName += " (ã‚ãªãŸ)";
		        }

		        // ãƒ›ã‚¹ãƒˆã®å ´åˆã¯ ğŸ‘‘ãƒãƒ¼ã‚¯ ã‚’ä»˜ä¸
		        if (id === hostId) {
		            li.style.borderLeft = "4px solid #ffd11a"; // ãƒ›ã‚¹ãƒˆã ã‘æ ç·šã®è‰²ã‚’å¤‰ãˆã‚‹
		            li.innerHTML = `<span style="color: #ffd11a;">ğŸ‘‘</span> ${displayName} <span style="font-size: 0.7rem; background: #555; padding: 2px 5px; border-radius: 4px; margin-left: 5px;">HOST</span>`;
		        } else {
		            li.innerText = displayName;
		        }

		        listEl.appendChild(li);
		    });
		}

    // å®‰å…¨ãªé€€å®¤ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    async function safeLeaveRoom(roomId, myId) {
        const roomRef = ref(db, `rooms/${roomId}`);
        try {
            await runTransaction(roomRef, (currentData) => {
                if (currentData) {
                    if (currentData.players && currentData.players[myId]) {
                        delete currentData.players[myId];
                    }
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ0äººãªã‚‰éƒ¨å±‹ã”ã¨å‰Šé™¤
                    const remaining = currentData.players ? Object.keys(currentData.players).length : 0;
                    if (remaining === 0) return null; 
                }
                return currentData;
            });
        } catch (error) {
            console.error("Leave error:", error);
        }
    }

    window.leaveRoom = async () => {
        if (!currentRoomId) return;
        await safeLeaveRoom(currentRoomId, myId);
        location.reload();
    };


		window.startGame = async () => {
		    if (!currentRoomId) return;
		    const roomRef = ref(db, `rooms/${currentRoomId}`);
		    
		    try {
		        const snapshot = await get(roomRef);
		        const data = snapshot.val();

		        if (data && data.players) {
		            const playerIds = Object.keys(data.players);
		            
		            // set ã§ã¯ãªã update ã‚’ä½¿ã„ã€ç‰¹å®šã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘ã‚’æ›¸ãæ›ãˆã‚‹
		            await update(roomRef, {
		                status: "playing",
		                currentTurnPlayer: playerIds[0],
		                // players ã¯ãã®ã¾ã¾æ®‹ã‚‹ã¯ãšã§ã™ãŒã€
		                // å¿ƒé…ãªå ´åˆã¯ã“ã“ã«æ˜ç¤ºçš„ã«å«ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆupdateãªã®ã§ï¼‰
		            });
		        }
		    } catch (error) {
		        console.error("é–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
		    }
		};

</script>
</body>
</html>