<style>
/* 全体 */
body {
  -webkit-user-select: none;
  user-select: none;
  margin:0;
  padding:0;
}

/* 盤面 */
#board { 
  display:grid; 
  pointer-events: none; /* 盤面は触れてもイベントを拾わない */
  grid-template-columns: repeat(3, 1fr); 
  grid-template-rows: repeat(5, 1fr);   
  gap: 2vw; 
  width: 90vw; 
  margin:auto;
}
.circle { 
  width:20vw; 
  height:20vw; 
  border-radius:50%; 
}
.board-red { background:red; }
.board-blue { background:blue; }
.board-green { background:green; }
.board-yellow { background:yellow; }

/* UI */
#instruction { 
  margin-top:2vh; 
  font-size:5vw; 
  text-align:center;
}
#controls { 
  display: flex;
  justify-content: center;
  margin: 2vh 0;
}
button {
  font-size:5vw;
  padding:1vh 2vh;
}
#countdown {
  width:80vw;
  height:4vh;
  border:1px solid #333;
  margin:2vh auto;
  background: #eee;
  overflow: hidden;
}
#bar {
  height:100%;
  width:100%;
  background:limegreen;
}
#spinButton {
  touch-action: manipulation; /* タップをクリック扱いにする */
}

/* ルーレット共通 */
.roulette-wrap {
  display:flex; 
  justify-content:center; 
  gap:20px; 
  margin-top:20px;
}
.roulette {
  position: relative;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  border: 3px solid #333;
  margin: 0 auto;
  will-change: transform;
}

.roulette-container {
  position: relative;
}
.marker {
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
}

/* 指ルーレット（5分割） */
.finger-roulette {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  border: 3px solid #333;
  background: conic-gradient(
    #444444 0deg 72deg,
    #666666 72deg 144deg,
    #888888 144deg 216deg,
    #aaaaaa 216deg 288deg,
    #cccccc 288deg 360deg
  );
  position: relative;
  will-change: transform;
}

/* ラベル共通：0deg=上、中心角配置 */
.label-finger,
.label-color {
  position: absolute;
  left: 50%;
  top: 50%;
  /* 上方向へ半径分移動する設計（translateY）で0deg=上を維持 */
  transform: rotate(var(--angle)) translateY(-60px) rotate(calc(-1 * var(--angle)));
  transform-origin: center;
  font-size: 20px;
  font-weight: bold;
  color: #fff;
  text-shadow: 0 1px 2px rgba(255,255,255,0.7);
}

/* 色ルーレット（conic-gradientの順と表示の順を揃える: 赤→青→緑→黄） */
.color-roulette {
  background: conic-gradient(
    red 0deg 90deg,
    blue 90deg 180deg,
    green 180deg 270deg,
    gold 270deg 360deg
  );
}

/* 注意：.label-color の別定義（translate(60px)など）は削除。二重定義厳禁 */
</style>

<!-- 盤面 -->
<div id="board"></div>
<div id="countdown"><div id="bar"></div></div>

<div class="roulette-wrap">
  <!-- 指ルーレット -->
  <div class="roulette-container">
    <div class="marker">▽</div>
    <div class="finger-roulette" id="fingerRoulette">
      <div class="finger-labels">
        <span class="label-finger">親</span>
        <span class="label-finger">人</span>
        <span class="label-finger">中</span>
        <span class="label-finger">薬</span>
        <span class="label-finger">小</span>
      </div>
    </div>
  </div>

  <!-- 色ルーレット -->
  <div class="roulette-container">
    <div class="marker">▽</div>
    <div class="roulette color-roulette" id="colorRoulette">
      <div class="color-labels">
        <span class="label-color">赤</span>
        <span class="label-color">青</span>
        <span class="label-color">緑</span>
        <span class="label-color">黄</span>
      </div>
    </div>
  </div>
</div>

<div id="controls">
  <button id="spinButton" onclick="spinBoth()">ルーレット回す</button>
</div>
<div id="instruction"></div>

<script>
const colorLabels = ["赤", "青", "緑", "黄"];     // conic-gradient の順と一致
const fingers = ["親指","人差し指","中指","薬指","小指"];
let countdownTime = 5; // 秒
/* 初期配置（指5、色4）*/
placeLabels("fingerRoulette", "label-finger", 5);
placeLabels("colorRoulette", "label-color", 4);

document.getElementById("spinButton").addEventListener("click", () => {
  spinBoth();
});

// 盤面生成
function createBoard() {
  const board = document.getElementById("board");
  board.innerHTML = "";
  const boardColors = ["board-red","board-blue","board-green","board-yellow"];
  for (let i = 0; i < 15; i++) {
    const circle = document.createElement("div");
    circle.className = "circle " + boardColors[Math.floor(Math.random()*boardColors.length)];
    board.appendChild(circle);
  }
}

/* 角度ユーティリティ */
function degPerSlice(count) { return 360 / count; }
function centerAngleOfIndex(idx, count) {
  const slice = degPerSlice(count);
  return -idx * slice - slice / 2; // スライスの中心角（0deg=上、反時計回り）
}

/* ラベルに中心角を割り当て（境界を避ける） */
function placeLabels(containerId, labelClass, sliceCount) {
  const container = document.getElementById(containerId);
  const labels = container.querySelectorAll(`.${labelClass}`);
  const slice = degPerSlice(sliceCount);
  labels.forEach((el, idx) => {
    const center = idx * slice + slice / 2;
    el.style.setProperty("--angle", `${center}deg`);
  });
}

/* カウントダウン */
function startCountdown() {
  const bar = document.getElementById("bar");
  bar.style.transition = "none";
  bar.style.width = "100%";
  void bar.offsetWidth;
  bar.style.transition = `width ${countdownTime}s linear`;
  bar.style.width = "0%";
}

function resetCountdown(){
  const bar = document.getElementById("bar");
  bar.style.transition = "none";
  bar.style.width = "100%";
}

/* スナップを中心角に合わせて回す */
function spinRoulette(id, sliceCount, callback) {
  const roulette = document.getElementById(id);

  const resultIndex = Math.floor(Math.random() * sliceCount);
  const targetAngle = centerAngleOfIndex(resultIndex, sliceCount);

  // 4〜6回転のランダム（いずれも 360°の倍数）
  const extraSpins = 4 + Math.floor(Math.random() * 3); // 4,5,6
  const baseRotation = extraSpins * 360;

  // 境界衝突回避（必要なら微小）
  const epsilon = 0.0001;
  const finalRotation = baseRotation + targetAngle + epsilon;


  // リセット→回転
  roulette.style.transition = "none";
  roulette.style.transform = "rotate(0deg)";
  void roulette.offsetWidth;

  roulette.style.transition = "transform 3s ease-out";
  roulette.style.transform = `rotate(${finalRotation}deg)`;

  setTimeout(() => {
    callback(resultIndex);
  }, 3000);
}


function spinBoth() {
  let fingerResult = null;
  let colorResult = null;
	resetCountdown();

  spinRoulette("fingerRoulette", 5, (idx) => {
    fingerResult = fingers[idx];
    if (colorResult) showResult(fingerResult, colorResult);
  });

  spinRoulette("colorRoulette", 4, (idx) => {
    colorResult = colorLabels[idx];
    if (fingerResult) showResult(fingerResult, colorResult);
  });
}

function showResult(finger, color) {
  document.getElementById("instruction").textContent = `${finger} を ${color} に置いてください`;
  startCountdown();
}

// 初期化
createBoard();
</script>