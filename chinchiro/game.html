<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>DICEãƒ¡ã‚¤ãƒ³</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; }
        .box { background: #2a2a2a; padding: 20px; border-radius: 12px; max-width: 500px; margin: 20px auto; border: 1px solid #444; }
        .gauge-container { width: 100%; height: 30px; background: #444; border-radius: 15px; position: relative; overflow: hidden; margin: 20px 0; }
        #gauge-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #4cc9f0, #f72585); position: absolute; }
        .dice-area { font-size: 3rem; margin: 20px; display: flex; justify-content: center; gap: 10px; }
        .btn-roll { padding: 15px 30px; font-size: 1.2rem; background: #e63946; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; }
        .btn-roll:disabled { background: #555; cursor: not-allowed; }


		/* ã©ã‚“ã¶ã‚Š */
		.dice-area {
		    position: relative;
		    width: 200px;
		    height: 200px;
		    margin: 40px auto;
		    border: 8px solid #8d6e63; /* ã©ã‚“ã¶ã‚Šã®ç¸ */
		    border-radius: 50%;
		    background: #efebe9; /* ã©ã‚“ã¶ã‚Šã®åº• */
		    display: flex;
		    justify-content: center;
		    align-items: center;
		}

		#gauge-bar { 
		    width: 0%; 
		    height: 100%; 
		    background: #4caf50; /* åˆæœŸè‰²ã®ç·‘ */
		    position: absolute; 
		    transition: background 0.2s; /* è‰²ã®å¤‰åŒ–ã‚’æ»‘ã‚‰ã‹ã« */
		}
		/* ã‚µã‚¤ã‚³ãƒ­æœ¬ä½“ */
		.dice {
		    position: absolute;
		    width: 44px;
		    height: 44px;
		    background: #fff;
		    border-radius: 6px;
		    display: grid;
		    grid-template: repeat(3, 1fr) / repeat(3, 1fr);
		    padding: 4px;
		    box-sizing: border-box;
		    box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
		    border: 1px solid #ccc; 
		    z-index: 10;
		    left: 50%;
		    top: 50%;
		    /* åˆæœŸä½ç½®ï¼ˆJSãŒå½“ãŸã‚‹å‰ã®ä½ç½®ï¼‰ */
		    margin-left: -22px;
		    margin-top: -22px;
		    /* transition ã‚’ä»˜ã‘ã¦ãŠãã¨ã€æ­¢ã¾ã‚‹æ™‚ã«ã€Œã‚¹ãƒƒã€ã¨ä½ç½®ã«ã¤ãã¾ã™ */
		    transition: transform 0.2s ease-out; 
		}

		/* ã‚µã‚¤ã‚³ãƒ­ã®ç›®ï¼ˆãƒ‰ãƒƒãƒˆï¼‰ */
		.dot {
		    background: #333;
		    border-radius: 50%;
		    width: 8px;
		    height: 8px;
		    margin: auto;
		}
		/* 1ã®ç›®ã ã‘èµ¤ãå¤§ããã™ã‚‹æ¼”å‡º */
		.dice[data-value="1"] .dot { background: #e63946; width: 12px; height: 12px; }

		.dice-area.out-flash {
		    border-color: #ff4d4d !important;
		    box-shadow: 0 0 20px #ff4d4d;
		    transition: all 0.3s;
		}

		@keyframes shake {
		    0% { margin-top: -22px; margin-left: -22px; }
		    25% { margin-top: -25px; margin-left: -19px; }
		    50% { margin-top: -19px; margin-left: -25px; }
		    75% { margin-top: -23px; margin-left: -20px; }
		    100% { margin-top: -22px; margin-left: -22px; }
		}

		.rolling {
		    animation: shake 0.1s infinite;
		    /* æŒ¯ã£ã¦ã„ã‚‹é–“ã¯ transition ã‚’åˆ‡ã‚‹ã¨ã‚ˆã‚Šæ¿€ã—ãè¦‹ãˆã¾ã™ */
		    transition: none !important; 
		}

    </style>
</head>
<body>

<div class="box">
    <h2 id="room-name-display">èª­ã¿è¾¼ã¿ä¸­...</h2>
    <div id="turn-display" style="color: #ffd11a; font-weight: bold;">ç›¸æ‰‹ã®ç•ªã‚’å¾…ã£ã¦ã„ã¾ã™</div>
    <hr>

		<div id="result-message" style="font-size: 1.5rem; color: #ffd11a; min-height: 2rem; margin-top: 10px;"></div>

    <div class="dice-area">
        <span id="d1">ğŸ²</span><span id="d2">ğŸ²</span><span id="d3">ğŸ²</span>
    </div>
		<button id="show-result-btn" class="btn-roll" style="display: none; background: #ff9800; margin-top: 10px;" onclick="finalizeGame()">çµæœã‚’è¡¨ç¤ºã™ã‚‹</button>

		<div id="result-screen" style="display: none; background: #333; padding: 20px; border-radius: 12px; margin: 20px auto; max-width: 400px;">
		    <h3>å¯¾æˆ¦çµæœ</h3>
		    <div id="ranking-list" style="text-align: left; line-height: 2;"></div>
		    <button id="restart-btn" class="btn-roll" style="display: none; background: #2196f3; margin-top: 20px;" onclick="handleRestart()">ã‚²ãƒ¼ãƒ ã‚’å†é–‹ã™ã‚‹</button>
		</div>

		<div class="gauge-container">
		    <div id="gauge-bar"></div>
		    <div id="safe-zone" style="position:absolute; left:40%; width:20%; height:100%; background:rgba(255,255,255,0.2); border-left:1px dashed #fff; border-right:1px dashed #fff;"></div>
		</div>

		<button id="roll-btn" class="btn-roll" onclick="handleButtonClick()" disabled>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, onDisconnect, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDXQstrCY2Xo6MG5aKcM_orNxhddlDx3rA",
        authDomain: "dice-a59f3.firebaseapp.com",
        projectId: "dice-a59f3",
        storageBucket: "dice-a59f3.firebasestorage.app",
        messagingSenderId: "1013783488303",
        appId: "1:1013783488303:web:828116dfd3852ff85de3da",
        measurementId: "G-5GFX1S7DHQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('id');
    const myId = params.get('uid');
    const myName = params.get('uname');

    let gaugeInterval = null;
    let gaugeValue = 0;
    let safeMin = 40; 
    let safeMax = 60; 

    const roomRef = roomId ? ref(db, `rooms/${roomId}`) : null;
    const myPlayerRef = (roomId && myId) ? ref(db, `rooms/${roomId}/players/${myId}`) : null;

    if (!roomId || !myId) {
        alert("ç„¡åŠ¹ãªã‚¢ã‚¯ã‚»ã‚¹ã§ã™");
        window.location.href = "lobby.html";
    } else {
        onDisconnect(myPlayerRef).remove(); 
        update(myPlayerRef, { name: myName, isReady: true });

				onValue(roomRef, (snapshot) => {
				    const data = snapshot.val();
				    if (!data || !data.players) return;

				    const turnDisplay = document.getElementById('turn-display');
				    const btn = document.getElementById('roll-btn');
				    const diceArea = document.querySelector('.dice-area');
				    const gaugeContainer = document.querySelector('.gauge-container');
				    const resultScreen = document.getElementById('result-screen');
				    const msgEl = document.getElementById('result-message');
				    const showResultBtn = document.getElementById('show-result-btn');

				    document.getElementById('room-name-display').innerText = data.roomName;
				    const turnPlayerId = data.currentTurnPlayer;

				    // --- 1. çŠ¶æ…‹ã«å¿œã˜ãŸè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ ---
				    if (turnPlayerId === "finished") {
				        if (diceArea) diceArea.style.display = 'none';
				        if (gaugeContainer) gaugeContainer.style.display = 'none';
				        if (btn) btn.style.display = 'none';
				        showResult(data);
				    } else if (turnPlayerId === "waiting_result") {
				        turnDisplay.innerText = "å…¨å“¡ãŒæŒ¯ã‚Šçµ‚ã‚ã‚Šã¾ã—ãŸ";
				        if (btn) btn.style.display = "none";
				        if (showResultBtn) showResultBtn.style.display = (data.hostId === myId) ? "block" : "none";
				    } else {
				        // é€šå¸¸é€²è¡Œä¸­ or ãƒªã‚¹ã‚¿ãƒ¼ãƒˆç›´å¾Œ
				        if (diceArea) diceArea.style.display = 'flex';
				        if (gaugeContainer) gaugeContainer.style.display = 'block';
				        if (btn) btn.style.display = 'block';
				        if (resultScreen) resultScreen.style.display = 'none'; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã‚’éš ã™
				        if (showResultBtn) showResultBtn.style.display = "none";

				        if (turnPlayerId === myId) {
				            turnDisplay.innerText = "ã‚ãªãŸã®ç•ªã§ã™";
				            btn.disabled = false;
				            if (btn.innerText !== "ã‚¹ãƒˆãƒƒãƒ—") {
				                btn.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
				                btn.style.background = "#4caf50";
				            }
				        } else {
				            const turnOwnerName = data.players[turnPlayerId] ? data.players[turnPlayerId].name : "ä¸æ˜";
				            turnDisplay.innerText = `${turnOwnerName}ã®ç•ªã§ã™`;
				            btn.disabled = true;
				            btn.innerText = "å¾…æ©Ÿä¸­...";
				            btn.style.background = "#555";
				            stopGauge(); // è‡ªåˆ†ã®ã‚²ãƒ¼ã‚¸ãŒå‹•ã„ã¦ã„ãŸã‚‰æ­¢ã‚ã‚‹
				        }
				    }

				    // --- 2. ã‚µã‚¤ã‚³ãƒ­ãƒ»ã‚²ãƒ¼ã‚¸ã®ãƒªã‚»ãƒƒãƒˆåŒæœŸ ---
				    if (!data.lastRoll) {
				        // ã€é‡è¦ã€‘ãƒ›ã‚¹ãƒˆãŒãƒªã‚¹ã‚¿ãƒ¼ãƒˆã—ãŸæ™‚ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†
				        resetGaugeUI(); // ã‚²ãƒ¼ã‚¸ã‚’0%ã«
				        if (msgEl) msgEl.innerText = "";
				        
				        // ã‚µã‚¤ã‚³ãƒ­ã‚’åˆæœŸä½ç½®ã«æˆ»ã™
				        const d1 = document.getElementById('d1');
				        const d2 = document.getElementById('d2');
				        const d3 = document.getElementById('d3');
				        [d1, d2, d3].forEach(d => {
				            d.classList.remove('rolling');
				            d.style.transform = "translate(0, 0) rotate(0deg)";
				        });
				        d1.innerHTML = getDiceHTML(1);
				        d2.innerHTML = getDiceHTML(1);
				        d3.innerHTML = getDiceHTML(1);

				        // ä»–äººã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¿ã‚¤ãƒãƒ¼ã‚‚è§£é™¤
				        if (typeof remoteRollInterval !== 'undefined' && remoteRollInterval) {
				            clearInterval(remoteRollInterval);
				            remoteRollInterval = null;
				        }
				    } else {
				        // --- 3. ã‚µã‚¤ã‚³ãƒ­æç”»ï¼ˆé€šå¸¸æ™‚ãƒ»ä»–äººãŒæŒ¯ã£ã¦ã„ã‚‹æ™‚ï¼‰ ---
				        updateDiceUI(data.lastRoll);

				        const rollCount = data.lastRoll.rollCount;
				        // è‡ªåˆ†ãŒæŒ¯ã£ã¦ã„ã‚‹æœ€ä¸­ã§ã€å½¹ãªã—æŒ¯ã‚Šç›´ã—ã®å ´åˆ
				        if (rollCount > 0 && turnPlayerId === myId && !data.lastRoll.isRolling) {
				            if (msgEl && !msgEl.innerText.includes('å›ç›®')) {
				                msgEl.innerText += `ï¼ˆ${rollCount}å›ç›®ï¼‰`;
				            }
				        }
				    }
				});
    }

		// ãƒœã‚¿ãƒ³åˆ¶å¾¡ç”¨ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
		window.handleButtonClick = () => {
		    const btn = document.getElementById('roll-btn');
		    
		    if (btn.innerText === "ã‚¹ã‚¿ãƒ¼ãƒˆ") {
		        // --- ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç† ---
						document.getElementById('gauge-bar').style.width = "0%";
		        gaugeValue = 0;
		        loopCount = 0;

		        btn.innerText = "ã‚¹ãƒˆãƒƒãƒ—";
		        btn.style.background = "#e63946"; // ã‚¹ãƒˆãƒƒãƒ—ã¯èµ¤ç³»
		        startGauge();
		    } else {
		        // --- ã‚¹ãƒˆãƒƒãƒ—å‡¦ç† ---
		        btn.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
		        btn.style.background = "#4caf50"; // æ¬¡ã®ã‚¹ã‚¿ãƒ¼ãƒˆã«å‘ã‘ã¦ç·‘ç³»ã«
		        handleRoll(); // æ—¢å­˜ã®ã‚µã‚¤ã‚³ãƒ­ç¢ºå®šãƒ»é€ä¿¡å‡¦ç†
		    }
		};

		let loopCount = 0; // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ—å›æ•°
		const maxLoops = 5; // æœ€å¤§5å›ï¼ˆç·‘3å›ã€é»„1å›ã€èµ¤1å›ï¼‰

		// æ—¢å­˜ã® startGauge å†…ã®ç›£è¦–ã‚’å°‘ã—ä¿®æ­£
		function startGauge() {
		    if (gaugeInterval) return;
		    gaugeValue = 0;
		    loopCount = 0;

				update(roomRef, { "lastRoll/isRolling": true });

		    gaugeInterval = setInterval(() => {
		        gaugeValue += 4;
		        if (gaugeValue >= 100) {
		            gaugeValue = 0;
		            loopCount++;
		            if (loopCount >= maxLoops) {
										// æ™‚é–“åˆ‡ã‚Œï¼
				            gaugeValue = 100; // å†…éƒ¨å€¤ã‚’100ã«å›ºå®š
				            updateGaugeUI();   // è¦‹ãŸç›®ã‚’100%ï¼ˆæº€ã‚¿ãƒ³ï¼‰ã«ã™ã‚‹

		                // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—æ™‚ã¯ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æˆ»ã—ã¦å¼·åˆ¶ã‚·ãƒ§ãƒ³ãƒ™ãƒ³
		                const btn = document.getElementById('roll-btn');
		                btn.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
		                btn.style.background = "#4caf50";
		                forceOut();
		                return;
		            }
		        }
		        
		        // --- ã‚²ãƒ¼ã‚¸æç”»ã¨ã‚µã‚¤ã‚³ãƒ­ã®æš´ã‚Œæ¼”å‡ºã¯ãã®ã¾ã¾ ---
		        const bar = document.getElementById('gauge-bar');
		        bar.style.width = gaugeValue + "%";

		        // ãƒ«ãƒ¼ãƒ—å›æ•°ã«å¿œã˜ã¦è‰²ã‚’å¤‰ãˆã‚‹
		        if (loopCount < 3) {
		            bar.style.background = "#4caf50"; // ç·‘ (1ã€œ3å›ç›®)
		        } else if (loopCount === 3) {
		            bar.style.background = "#ffeb3b"; // é»„ (4å›ç›®)
		        } else {
		            bar.style.background = "#f44336"; // èµ¤ (5å›ç›®)
		        }

		        // ã‚µã‚¤ã‚³ãƒ­ã®æš´ã‚Œæ¼”å‡ºï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
		        const d1 = document.getElementById('d1');
		        const d2 = document.getElementById('d2');
		        const d3 = document.getElementById('d3');
		        const power = (loopCount * 20) + (gaugeValue * 0.5); // ãƒ«ãƒ¼ãƒ—ãŒé€²ã‚€ã»ã©æ¿€ã—ã

		        [d1, d2, d3].forEach(el => {
		            const x = (Math.random() - 0.5) * power * 2;
		            const y = (Math.random() - 0.5) * power * 2;
		            const deg = Math.random() * 360;
		            el.style.transform = `translate(${x}px, ${y}px) rotate(${deg}deg)`;
		            el.innerHTML = getDiceHTML(Math.floor(Math.random() * 6) + 1); 
		        });
		    }, 20);
		}

		// ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—æ™‚ã®å¼·åˆ¶ã‚·ãƒ§ãƒ³ãƒ™ãƒ³é–¢æ•°
		async function forceOut() {
		    // 1. ã¾ãšã‚²ãƒ¼ã‚¸ã‚’æ­¢ã‚ã¦ãƒªã‚»ãƒƒãƒˆ
		    stopGauge();
		    
		    // 2. æ¼”å‡ºç”¨ã®ç›®ã‚’ä½œæˆ
		    const dVals = [
		        Math.floor(Math.random() * 6) + 1,
		        Math.floor(Math.random() * 6) + 1,
		        Math.floor(Math.random() * 6) + 1
		    ];
		    
		    try {
		        const snapshot = await get(roomRef);
		        const data = snapshot.val();
		        const playerIds = Object.keys(data.players);
		        const nextPlayerId = playerIds[(playerIds.indexOf(myId) + 1) % playerIds.length];

		        // 3. å¼·åˆ¶ã‚·ãƒ§ãƒ³ãƒ™ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
		        await update(roomRef, {
		            lastRoll: { 
		                values: [0, 0, 0], 
		                displayValues: dVals, 
		                playerName: myName,
										rollCount: 0 // ãƒªã‚»ãƒƒãƒˆ
		            },
		            currentTurnPlayer: nextPlayerId
		        });
		    } catch (e) {
		        console.error(e);
		    }
		}

		function stopGauge() {
		    if (gaugeInterval) {
		        clearInterval(gaugeInterval);
		        gaugeInterval = null;
		    }
		}

    function getOutProbability(val) {
        const center = (safeMin + safeMax) / 2;
        const distanceFromCenter = Math.abs(val - center);
        return Math.pow(distanceFromCenter / center, 2); 
    }

    function getDiceHTML(num) {
        const dotPositions = {
            1: [4], 2: [0, 8], 3: [0, 4, 8],
            4: [0, 2, 6, 8], 5: [0, 2, 4, 6, 8], 6: [0, 3, 6, 2, 5, 8]
        };
        const positions = dotPositions[num] || [];
        let dots = "";
        for(let i=0; i<9; i++) {
            dots += positions.includes(i) ? '<div class="dot"></div>' : '<div></div>';
        }
        return `<div class="dice" data-value="${num}">${dots}</div>`;
    }

		// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼å¤‰æ•°ï¼ˆé–¢æ•°ã®å¤–ã«å®šç¾©ï¼‰
		let remoteRollInterval = null;

		function updateDiceUI(rollData) {
		    if (!rollData) return;

		    const values = rollData.values || [1, 1, 1];
		    const d = rollData.displayValues || values;
		    const msgEl = document.getElementById('result-message');
		    const isRolling = rollData.isRolling;

		    const d1 = document.getElementById('d1');
		    const d2 = document.getElementById('d2');
		    const d3 = document.getElementById('d3');
		    const area = document.querySelector('.dice-area');

		    if (isRolling) {
		        // --- èª°ã‹ãŒæŒ¯ã£ã¦ã„ã‚‹æœ€ä¸­ ---
		        msgEl.innerText = `${rollData.playerName} ãŒæŒ¯ã£ã¦ã„ã¾ã™...`;
		        msgEl.style.color = "#ffffff";
		        
		        // ã™ã§ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‹•ã„ã¦ã„ãªã‘ã‚Œã°é–‹å§‹
		        if (!remoteRollInterval) {
		            remoteRollInterval = setInterval(() => {
		                // åº§æ¨™ã‚’é«˜é€Ÿã«ãƒ©ãƒ³ãƒ€ãƒ åŒ–ï¼ˆã©ã‚“ã¶ã‚Šã®ä¸­ã§é£›ã³è·³ã­ã•ã›ã‚‹ï¼‰
		                const randPos = () => Math.floor(Math.random() * 80) - 40; // -40px ~ 40px
		                const randRot = () => Math.floor(Math.random() * 360);

		                d1.style.transform = `translate(${randPos()}px, ${randPos()}px) rotate(${randRot()}deg)`;
		                d2.style.transform = `translate(${randPos()}px, ${randPos()}px) rotate(${randRot()}deg)`;
		                d3.style.transform = `translate(${randPos()}px, ${randPos()}px) rotate(${randRot()}deg)`;

		                // ç›®ã‚‚ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰ãˆã‚‹
		                d1.innerHTML = getDiceHTML(Math.floor(Math.random() * 6) + 1);
		                d2.innerHTML = getDiceHTML(Math.floor(Math.random() * 6) + 1);
		                d3.innerHTML = getDiceHTML(Math.floor(Math.random() * 6) + 1);
		            }, 50); // 0.05ç§’ã”ã¨ã«æ¿€ã—ãå‹•ã‹ã™
		        }
		    } else {
		        // --- æ­¢ã¾ã£ãŸæ™‚ ---
		        // å‹•ã„ã¦ã„ãŸã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
		        if (remoteRollInterval) {
		            clearInterval(remoteRollInterval);
		            remoteRollInterval = null;
		        }

		        d1.innerHTML = getDiceHTML(d[0]);
		        d2.innerHTML = getDiceHTML(d[1]);
		        d3.innerHTML = getDiceHTML(d[2]);

		        if (values[0] === 0) {
		            // ã‚·ãƒ§ãƒ³ãƒ™ãƒ³é…ç½®
		            d1.style.transform = "translate(-130px, -100px) rotate(-110deg)";
		            d2.style.transform = "translate(20px, -150px) rotate(200deg)";
		            d3.style.transform = "translate(120px, 60px) rotate(45deg)";
		            area.style.borderColor = "#ff4d4d";
		            msgEl.innerText = "ã‚·ãƒ§ãƒ³ãƒ™ãƒ³";
		            msgEl.style.color = "#ff4d4d";
		        } else {
		            // é€šå¸¸ç¢ºå®šé…ç½®
		            d1.style.transform = "translate(-2px, -42px) rotate(5deg)";
		            d2.style.transform = "translate(-40px, 24px) rotate(-10deg)";
		            d3.style.transform = "translate(36px, 24px) rotate(12deg)";
		            area.style.borderColor = "#8d6e63";

		            const result = judge(values);
		            msgEl.innerText = result.name;
		            msgEl.style.color = "#ffd11a";
		        }
		    }
		}

		function judge(dice) {
		    // åˆ¤å®šã—ã‚„ã™ãã™ã‚‹ãŸã‚ã«æ˜‡é †ï¼ˆå°ã•ã„é †ï¼‰ã«ä¸¦ã³æ›¿ãˆã‚‹
		    const sorted = [...dice].sort((a, b) => a - b);
		    const [a, b, c] = sorted;

		    // 1. ã‚¾ãƒ­ç›®ï¼ˆã‚¢ãƒ©ã‚·ï¼‰
		    if (a === b && b === c) {
		        if (a === 1) {
		            return { name: "ãƒ”ãƒ³ã‚¾ãƒ­", score: 100 }; // æœ€å¼·
		        }
		        return { name: a + "ã®ã‚¾ãƒ­ç›®", score: 90 + a };
		    }

		    // 2. ã‚·ã‚´ãƒ­ (4, 5, 6)
		    if (a === 4 && b === 5 && c === 6) {
		        return { name: "ã‚·ã‚´ãƒ­", score: 80 };
		    }

		    // 3. ãƒ’ãƒ•ãƒŸ (1, 2, 3)
		    if (a === 1 && b === 2 && c === 3) {
		        return { name: "ãƒ’ãƒ•ãƒŸ", score: -1 }; // æœ€å¼±ï¼ˆè² ã‘ï¼‰
		    }

		    // 4. ç›®ã‚ã‚Šï¼ˆ2ã¤ã®ã‚µã‚¤ã‚³ãƒ­ãŒåŒã˜ã§ã€æ®‹ã‚Šã®1ã¤ãŒã€Œç›®ã€ã«ãªã‚‹ï¼‰
		    // ä¾‹: [2, 2, 5] ãªã‚‰ã€Œ5ã®ç›®ã€
		    if (a === b) return { name: c + "ã®ç›®", score: c };
		    if (b === c) return { name: a + "ã®ç›®", score: a };
		    
		    // a === c ã®ã‚±ãƒ¼ã‚¹ï¼ˆ[2, 5, 2] ãªã©ï¼‰ã¯ã€ã‚½ãƒ¼ãƒˆæ¸ˆã¿ãªã®ã§ [2, 2, 5] ã«ãªã‚Šä¸Šã®åˆ¤å®šã§æ‹¾ãˆã¾ã™

		    // 5. å½¹ãªã—ï¼ˆç›®ãªã—ï¼‰
		    return { name: "å½¹ãªã—", score: 0 };
		}

		// å…¨å“¡ã®é †ä½ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
		function showResult(data) {
		    // 1. ç”»é¢è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
		    document.querySelector('.dice-area').style.display = 'none';
		    document.querySelector('.gauge-container').style.display = 'none';
		    document.getElementById('roll-btn').style.display = 'none';
		    document.getElementById('show-result-btn').style.display = "none";

		    const resultScreen = document.getElementById('result-screen');
		    const rankingList = document.getElementById('ranking-list');
		    resultScreen.style.display = 'block';

		    // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
		    const players = data.players;
		    const sortedList = Object.keys(players).map(id => ({
		        name: players[id].name,
		        result: players[id].lastResultName || "å½¹ãªã—",
		        score: players[id].lastScore || 0
		    })).sort((a, b) => b.score - a.score);

		    // 3. åŒé †ä½ã‚’è€ƒæ…®ã—ãŸHTMLã®ç”Ÿæˆï¼ˆã‚¹ã‚³ã‚¢éè¡¨ç¤ºï¼‰
		    let displayRank = 1;
		    rankingList.innerHTML = sortedList.map((p, i) => {
		        // 2äººç›®ä»¥é™ã§ã€å‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ˆã‚Šã‚¹ã‚³ã‚¢ãŒä½ã„å ´åˆã®ã¿é †ä½ã‚’æ›´æ–°
		        if (i > 0 && p.score < sortedList[i - 1].score) {
		            displayRank = i + 1;
		        }

		        return `
		            <div style="border-bottom: 1px solid #444; padding: 12px; display: flex; align-items: center;">
		                <span style="width: 60px; font-weight: bold; color: #ffd11a;">${displayRank}ä½</span>
		                <span style="flex: 1; text-align: left; font-size: 1.1rem;"><strong>${p.name}</strong></span>
		                <span style="color: #ccc; font-size: 0.9rem;">${p.result}</span>
		            </div>
		        `;
		    }).join('');

		    // 4. ãƒ›ã‚¹ãƒˆãªã‚‰å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
		    if (data.hostId === myId) {
		        document.getElementById('restart-btn').style.display = 'block';
		    }
		}

		function resetGaugeUI() {
		    gaugeValue = 0;
		    loopCount = 0;
		    const bar = document.getElementById('gauge-bar');
		    if (bar) {
		        bar.style.width = "0%";
		        bar.style.background = "#4caf50";
		    }
		}

		window.finalizeGame = async () => {
		    try {
		        await update(roomRef, {
		            currentTurnPlayer: "finished"
		        });
		    } catch (e) {
		        console.error(e);
		    }
		};

		// ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™é–¢æ•°ï¼ˆãƒ›ã‚¹ãƒˆå°‚ç”¨ï¼‰
		window.handleRestart = async () => {
		    try {
		        const snapshot = await get(roomRef);
		        const data = snapshot.val();
		        const playerIds = Object.keys(data.players);
		        
		        const updates = {};
		        playerIds.forEach(id => {
		            updates[`players/${id}/lastScore`] = 0;
		            updates[`players/${id}/lastResultName`] = "";
		        });
		        
		        updates['currentTurnPlayer'] = playerIds[0];
		        updates['lastRoll'] = null;
		        // --- è¿½åŠ ï¼šã‚²ãƒ¼ã‚¸ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ ---
		        updates['currentGaugeValue'] = 0; 

		        await update(roomRef, updates);

		        // ãƒ›ã‚¹ãƒˆè‡ªèº«ã®UIã‚’å³æ™‚ãƒªã‚»ãƒƒãƒˆ
		        resetGaugeUI();
		        
		        document.getElementById('show-result-btn').style.display = 'none';
		        document.getElementById('result-screen').style.display = 'none';
		        document.querySelector('.dice-area').style.display = 'flex';
		        document.querySelector('.gauge-container').style.display = 'block';
		        document.getElementById('roll-btn').style.display = 'block';
		        document.getElementById('result-message').innerText = "";
		    } catch (e) {
		        console.error("å†ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:", e);
		    }
		};

		window.handleRoll = async () => {
		    stopGauge();
		    
		    const prob = getOutProbability(gaugeValue);
		    const isOut = Math.random() < prob;
		    const dVals = [
		        Math.floor(Math.random() * 6) + 1,
		        Math.floor(Math.random() * 6) + 1,
		        Math.floor(Math.random() * 6) + 1
		    ];
		    // ã‚·ãƒ§ãƒ³ãƒ™ãƒ³ãªã‚‰[0,0,0]ã€ãã†ã§ãªã‘ã‚Œã°å‡ºç›®ã‚’ãã®ã¾ã¾ä½¿ã†
		    const finalValues = isOut ? [0, 0, 0] : dVals;

		    try {
		        const snapshot = await get(roomRef);
		        const data = snapshot.val();
		        if (!data || !data.players) return;

		        const playerIds = Object.keys(data.players);
		        
		        // --- 1. å›æ•°ã‚«ã‚¦ãƒ³ãƒˆã®ä¿®æ­£ ---
		        let currentRollCount = 1;
		        // å‰å›ã®è¨˜éŒ²ãŒã‚ã‚Šã€ã‹ã¤è‡ªåˆ†ãŒæŒ¯ã£ã¦ã„ãŸå ´åˆã®ã¿ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
		        if (data.lastRoll && data.lastRoll.playerName === myName) {
		            // å‰å›ã®rollCountãŒ0ï¼ˆäº¤ä»£ç›´å¾Œï¼‰ã§ãªã‘ã‚Œã°åŠ ç®—
		            const lastCount = Number(data.lastRoll.rollCount || 0);
		            currentRollCount = lastCount > 0 ? lastCount + 1 : 1;
		        }

		        const result = judge(dVals);
		        const isNone = result.name === "å½¹ãªã—";
		        
		        // äº¤ä»£æ¡ä»¶ï¼šã‚·ãƒ§ãƒ³ãƒ™ãƒ³ã€ã¾ãŸã¯å½¹ãŒå‡ºãŸã€ã¾ãŸã¯3å›ç›®
		        const shouldSwitch = isOut || !isNone || currentRollCount >= 3;

		        let nextPlayerId = myId; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œè‡ªåˆ†ï¼ˆæŒ¯ã‚Šç›´ã—ï¼‰ã€
		        let rollCountToSave = currentRollCount; // DBã«ä¿å­˜ã™ã‚‹å›æ•°

		        if (shouldSwitch) {
		            // å½¹ã®çµæœã¨ã‚¹ã‚³ã‚¢ã‚’å€‹äººæ ã«ä¿å­˜ï¼ˆãƒªã‚¶ãƒ«ãƒˆç”¨ï¼‰
		            const myPlayerRef = ref(db, `rooms/${roomId}/players/${myId}`);
		            await update(myPlayerRef, {
		                lastResultName: isOut ? "ã‚·ãƒ§ãƒ³ãƒ™ãƒ³" : result.name,
		                lastScore: isOut ? -100 : result.score
		            });

		            const currentIndex = playerIds.indexOf(myId);
		            if (currentIndex === playerIds.length - 1) {
		                nextPlayerId = "waiting_result"; // å…¨å“¡çµ‚äº†
		            } else {
		                nextPlayerId = playerIds[currentIndex + 1]; // æ¬¡ã®äººã¸
		            }
		            rollCountToSave = 0; // ã‚¿ãƒ¼ãƒ³ãŒçµ‚äº†ã™ã‚‹ã®ã§ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
		        }

		        // --- 2. ã€é‡è¦ã€‘ã“ã“ã§å¿…ãšDBã‚’æ›´æ–°ã™ã‚‹ ---
		        // ã“ã‚Œã«ã‚ˆã‚Šã€å½¹ãªã—ï¼ˆshouldSwitch=falseï¼‰ã®æ™‚ã§ã‚‚ lastRoll ãŒæ›´æ–°ã•ã‚Œã€
		        // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã® onValue -> updateDiceUI ãŒç™ºç«ã—ã¾ã™ã€‚
		        await update(roomRef, {
		            lastRoll: { 
		                values: finalValues, 
		                displayValues: dVals, 
		                playerName: myName,
		                rollCount: rollCountToSave
		            },
		            currentTurnPlayer: nextPlayerId
		        });

		    } catch (e) {
		        console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
		    }
		};

</script>
</body>
</html>