<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä»£å¼è€…ã²ã‚ˆã“</title>
<style>
  body { text-align:center; background:#f7f7f9; font-family:sans-serif; padding:20px; }
  img {
    width: 240px;
    transition: transform 0.2s ease-in-out;
  }
  .talking {
    animation: squishy 0.6s infinite alternate ease-in-out;
  }
  @keyframes squishy {
    0%   { transform: scale(1,1); }
    50%  { transform: scale(1.05,0.95); }
    100% { transform: scale(0.95,1.05); }
  }

  /* é€šå¸¸çŠ¶æ…‹ */
  #recordBtn {
    background-color: #2b7;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  /* ç„¡åŠ¹åŒ–çŠ¶æ…‹ï¼ˆdisabledï¼‰ */
  #recordBtn:disabled {
    background-color: #ccc;   /* ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ */
    color: #666;              /* æ–‡å­—ã‚‚è–„ã */
    cursor: not-allowed;      /* ã‚«ãƒ¼ã‚½ãƒ«ã‚‚ç¦æ­¢ãƒãƒ¼ã‚¯ */
  }

  /* ç„¡åŠ¹åŒ–çŠ¶æ…‹ï¼ˆdisabledï¼‰ */
  #playBtn:disabled {
    background-color: #ccc;   /* ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ */
    color: #666;              /* æ–‡å­—ã‚‚è–„ã */
    cursor: not-allowed;      /* ã‚«ãƒ¼ã‚½ãƒ«ã‚‚ç¦æ­¢ãƒãƒ¼ã‚¯ */
  }

  button {
    padding: 12px 20px;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    background: #2b7;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    margin: 6px;
  }
  .meter {
    width: 20px;
    height: 120px;
    background: #ddd;
    margin: 20px auto;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
  }
  .level {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: linear-gradient(to top, #2b7, #6f6);
    transition: height 0.1s ease-out;
  }
  .pitch-options {
    margin: 12px 0;
    display: flex;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .pitch-options label {
    font-size: 0.9rem;
  }
</style>
</head>
<body>
  <h1>ã²ã‚ˆã“ã‹ã‚‰ãŠã¯ãªã—ãŒã‚ã‚Šã¾ã™</h1>
  <img id="yuruChar" src="hiyoko.png" alt="ã²ã‚ˆã“ã‚­ãƒ£ãƒ©">
  <div class="meter"><div id="levelBar" class="level" style="height:0%"></div></div>

  <div class="pitch-options">
    <label><input type="radio" name="pitch" value="0.8">ä½ã‚</label>
    <label><input type="radio" name="pitch" value="1.0">æ™®é€š</label>
    <label><input type="radio" name="pitch" value="1.5">ã‚„ã‚„é«˜ã‚</label>
    <label><input type="radio" name="pitch" value="1.8" checked>é«˜ã‚</label>
    <label><input type="radio" name="pitch" value="2.2">ã‹ãªã‚Šé«˜ã‚</label>
  </div>

  <button id="recordBtn" disabled>ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
  <button id="playBtn" disabled>â–¶ï¸ å†ç”Ÿ</button>
	<br>
	<button id="micToggleBtn">ãƒã‚¤ã‚¯ON</button>


<script>
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let analyser, audioCtx, sourceNode;
let drawId;
let recordedBuffer = null;
let micOn = false;
let stream = null;

const recordBtn = document.getElementById("recordBtn");
const playBtn = document.getElementById("playBtn");
const char = document.getElementById("yuruChar");
const levelBar = document.getElementById("levelBar");
const micToggleBtn = document.getElementById("micToggleBtn");


recordBtn.addEventListener("click", async () => {
  if (!micOn) return; // ãƒã‚¤ã‚¯ãŒOFFãªã‚‰ä½•ã‚‚ã—ãªã„

  if (!isRecording) {
    audioCtx = new AudioContext();
    sourceNode = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    sourceNode.connect(analyser);

    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
      cancelAnimationFrame(drawId);
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const arrayBuffer = await blob.arrayBuffer();
      const ctx = new AudioContext();
      recordedBuffer = await ctx.decodeAudioData(arrayBuffer);
      playBtn.disabled = false; // å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      levelBar.style.height = "0%";
    };

    mediaRecorder.start();
    drawMeter(analyser);
    recordBtn.textContent = "â¹ï¸ éŒ²éŸ³åœæ­¢";
    isRecording = true;
  } else {
    mediaRecorder.stop();
    recordBtn.textContent = "ğŸ¤ éŒ²éŸ³é–‹å§‹";
    isRecording = false;
  }
});

micToggleBtn.addEventListener("click", async () => {
  if (micOn) {
    // ãƒã‚¤ã‚¯ã‚’OFFã«ã™ã‚‹
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    micOn = false;
    micToggleBtn.textContent = "ãƒã‚¤ã‚¯ON";   // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’ONã«æˆ»ã™
    recordBtn.disabled = true;              // éŒ²éŸ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    console.log("ãƒã‚¤ã‚¯OFF");
  } else {
    // ãƒã‚¤ã‚¯ã‚’ONã«ã™ã‚‹
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      micOn = true;
      micToggleBtn.textContent = "ãƒã‚¤ã‚¯OFF"; // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’OFFã«åˆ‡ã‚Šæ›¿ãˆ
      recordBtn.disabled = false;             // éŒ²éŸ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      console.log("ãƒã‚¤ã‚¯ON");
    } catch (err) {
      console.error("ãƒã‚¤ã‚¯å–å¾—å¤±æ•—:", err);
    }
  }
});


playBtn.addEventListener("click", () => {
  if (!recordedBuffer) return;
  const ctx = new AudioContext();
  const pitchVal = parseFloat(document.querySelector('input[name="pitch"]:checked').value);

  const source = ctx.createBufferSource();
  source.buffer = recordedBuffer;
  source.playbackRate.value = pitchVal;
  source.connect(ctx.destination);
  source.start();

  const replayAnalyser = ctx.createAnalyser();
  const replaySource = ctx.createBufferSource();
  replaySource.buffer = recordedBuffer;
  replaySource.playbackRate.value = pitchVal;
  replaySource.connect(replayAnalyser);
  replayAnalyser.connect(ctx.destination);
  replaySource.start();

  char.classList.add("talking");
  drawMeter(replayAnalyser);
  replaySource.onended = () => {
    char.classList.remove("talking");
    cancelAnimationFrame(drawId);
    levelBar.style.height = "0%";
  };
});

function drawMeter(analyserNode){
  const dataArray = new Uint8Array(analyserNode.frequencyBinCount);
  function draw(){
    analyserNode.getByteFrequencyData(dataArray);
    const avg = dataArray.reduce((a,b) => a + b, 0) / dataArray.length;
    const percent = Math.min(100, Math.floor(avg / 2));
    levelBar.style.height = percent + "%";
    drawId = requestAnimationFrame(draw);
  }
  draw();
}
</script>
</body>
</html>