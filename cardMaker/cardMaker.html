<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>コンカフェ嬢バトルカード生成</title>
<style>
  h1 { color: #801e63; font-size: 20px; }
  body { padding: 10px; }
  button { width: 100%; box-sizing: border-box; }
  #cardCanvas {
    border: 2px solid #e91e63;
    margin-top: 20px;
    max-width: 100%;
    height: auto;
    display: block;
  }
</style>
</head>
<body>

<h1>✨ コンカフェ嬢バトルカード生成 ✨</h1>

<input type="file" id="imageInput" accept="image/*" onchange="generateCard()"><br>
<button onclick="downloadCard()">ダウンロード</button>

<canvas id="cardCanvas" width="300" height="1000"></canvas>

<script>
// =============================
// 属性リスト
// =============================
const positiveAttributes = [
  "元気","癒し","愛嬌","面白さ","機転","心尽くし","コミュ力"
];

const negativeAttributes = [
  "悪ノリ","下ネタ","P活","店外","グリ下","乞食","鬼畜","色営",
  "オラ営","アルハラ","酒雑魚","ホス狂","彼氏持ち","風掛け持ち"
];

// =============================
// SHA-256 ハッシュ
// =============================
async function hashImage(file) {
  const buffer = await file.arrayBuffer();
  const hash = await crypto.subtle.digest("SHA-256", buffer);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

// =============================
// シード付き乱数
// =============================
function seededRandom(seed) {
  let h = 0;
  for (let i = 0; i < seed.length; i++) {
    h = Math.imul(31, h) + seed.charCodeAt(i) | 0;
  }
  return () => {
    h = Math.imul(48271, h) % 0x7fffffff;
    return (h & 0xfffffff) / 0x10000000;
  };
}

// =============================
// ステータス生成（固定）
// =============================
function randomStatsFromSeed(seed) {
  const rand = seededRandom(seed);
  return {
    beauty: Math.floor(rand() * 101),
    intelligence: Math.floor(rand() * 101),
    stamina: Math.floor(rand() * 101),
    guts: Math.floor(rand() * 101),
    mental: Math.floor(rand() * 101)
  };
}

// =============================
// 属性生成（固定）
// =============================
function randomAttributesFromSeed(seed) {
  const rand = seededRandom(seed);
  const pos = [...positiveAttributes].sort(() => rand() - 0.5).slice(0, 2);
  const neg = [...negativeAttributes].sort(() => rand() - 0.5).slice(0, 1);
  return [...pos, ...neg];
}

// =============================
// キャプション生成（固定）
// =============================
const listA = [
  "夜の光に溶けるように","微笑みの奥に小さな炎を灯し",
  "夢の続きに迷い込んだまま","誰かの心をそっと照らすように",
  "秘密の魔法を胸に抱いて"
];

const listB = [
  "今日もあなたを迎えにいく","静かに強さを隠している",
  "ふわりと世界を変えてしまう","小さな勇気を積み重ねている",
  "誰よりも優しい嘘をつく"
];

const listC = [
  "そんな私を見つけてくれてありがとう。",
  "この瞬間が永遠でありますように。",
  "あなたの物語に寄り添えたら嬉しい。",
  "今日も少しだけ強くなれた気がする。",
  "心のどこかで、あなたを待っている。"
];

function randomCaptionFromSeed(seed) {
  const rand = seededRandom(seed);
  const pick = arr => arr[Math.floor(rand() * arr.length)];
  return pick(listA) + "、" + pick(listB) + "。" + pick(listC);
}

// =============================
// カード生成（画像選択で自動）
// =============================
async function generateCard() {
  const file = document.getElementById("imageInput").files[0];
  if (!file) return;

  const seed = await hashImage(file);
  const stats = randomStatsFromSeed(seed);
  const attrs = randomAttributesFromSeed(seed);
  const caption = randomCaptionFromSeed(seed);

  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => drawCard(img, stats, attrs, caption);
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// =============================
// レア度計算
// =============================
function calcRarity(stats) {
  const values = Object.values(stats);
  const total = values.reduce((a, b) => a + b, 0);
  const minVal = Math.min(...values);

  if (total >= 420 && minVal >= 64) return "UR";
  if (total >= 400 && minVal >= 55) return "SSR";
  if (total >= 350 && minVal >= 40) return "SR";
  if (total >= 300) return "R";
  return "N";
}

// =============================
// カード描画
// =============================
const rarityColor = {
  "UR":  "#4fc",
  "SSR": "#d3e",
  "SR":  "#ca2",
  "R":   "#e82",
  "N":   "#27f"
};

function drawCard(userImage, stats, attrs, caption) {
  const canvas = document.getElementById("cardCanvas");
  const ctx = canvas.getContext("2d");

  const rarity = calcRarity(stats);

  const frameImg = new Image();
  frameImg.crossOrigin = "anonymous";
  frameImg.src = {
    "UR":  "ur.png",
    "SSR": "ssr.png",
    "SR":  "sr.png",
    "R":   "r.png",
    "N":   "n.png"
  }[rarity];

  frameImg.onload = () => {
    ctx.fillStyle = "#404060";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 自撮りトリミング
    const targetW = 260, targetH = 460;
    const x = 20, y = 70;

    const ratio = Math.max(targetW / userImage.width, targetH / userImage.height);
    const w = userImage.width * ratio;
    const h = userImage.height * ratio;
    const cropX = (w - targetW) / 2;
    const cropY = (h - targetH) / 2;

    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = targetW;
    tempCanvas.height = targetH;
    const tempCtx = tempCanvas.getContext("2d");
    tempCtx.drawImage(userImage, -cropX, -cropY, w, h);

    ctx.drawImage(tempCanvas, x, y);
    ctx.drawImage(frameImg, 0, 0, 300, 600);

    drawStatusAndText(ctx, stats, attrs, rarity, caption, 610);
  };
}

// =============================
// ステータス描画
// =============================
function drawStatusAndText(ctx, stats, attrs, rarity, caption, offsetY) {
  ctx.font = "20px sans-serif";
  ctx.fillStyle = rarityColor[rarity];
  ctx.fillText(rarity, 220, offsetY + 20);

  ctx.fillStyle = "#fff";
  ctx.font = "18px sans-serif";
  ctx.fillText("【ステータス】", 20, offsetY + 20);

  function drawBar(label, value, y) {
    ctx.fillStyle = "#fff";
    ctx.font = "14px sans-serif";
    ctx.fillText(`${label}: ${value}`, 20, y);
    ctx.fillStyle = "#ddd";
    ctx.fillRect(100, y - 10, 150, 8);
    ctx.fillStyle = "#f20";
    ctx.fillRect(100, y - 10, (value / 100) * 150, 8);
  }

  drawBar("容姿", stats.beauty, offsetY + 45);
  drawBar("知力", stats.intelligence, offsetY + 70);
  drawBar("体力", stats.stamina, offsetY + 95);
  drawBar("根性", stats.guts, offsetY + 120);
  drawBar("精神力", stats.mental, offsetY + 145);

  ctx.fillStyle = "#fff";
  ctx.font = "18px sans-serif";
  ctx.fillText("【パッシブスキル】", 20, offsetY + 170);

  let ax = 20, ay = offsetY + 195;
  attrs.forEach(attr => {
    ctx.fillStyle = positiveAttributes.includes(attr) ? "#fcc" : "#2cf";
    ctx.font = "16px sans-serif";
    ctx.fillText(attr, ax, ay);
    ax += ctx.measureText(attr).width + 15;
    if (ax > 260) { ax = 20; ay += 20; }
  });

  ctx.font = "14px sans-serif";
  ctx.fillStyle = "#fff";
  const lines = caption.match(/.{1,15}/g);
  let cy = ay + 30;
  lines.forEach(line => {
    ctx.fillText(line, 20, cy);
    cy += 16;
  });
}

// =============================
// ダウンロード
// =============================
function downloadCard() {
  const canvas = document.getElementById("cardCanvas");
  const link = document.createElement("a");
  link.download = "battle_card.png";
  link.href = canvas.toDataURL();
  link.click();
}
</script>

</body>
</html>