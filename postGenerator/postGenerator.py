import streamlit as st

# ページ設定
st.set_page_config(page_title="コンカフェ嬢 営業スタイル精密診断 PRO", layout="centered")

# --- セッション状態の初期化 ---
if 'step' not in st.session_state:
    st.session_state.step = 0
if 'answers' not in st.session_state:
    st.session_state.answers = []
# sales: 沼らせ, mental: 耐性, risk: 炎上, compliance: 規約遵守
if 'points' not in st.session_state:
    st.session_state.points = {"sales": 0, "mental": 0, "risk": 0, "compliance": 0}

# --- アップデートされた設問データ ---
questions = [
    # SNS・自撮り編
    {"q": "自撮りの投稿傾向は？", "options": [
        ("清楚・美少女系", (10, 5, 0, 10)), ("グラビア系", (20, 10, 10, 5)), 
        ("露出・エロ寄り", (30, 10, 40, 0)), ("病み・地雷系", (15, -10, 20, 5))]},
    {"q": "客へのSNS営業のメイン手法は？", "options": [
        ("ポストのみ", (5, 10, 0, 20)), ("DMで「今日いるよ！」", (20, 5, 10, 10)), 
        ("DMで「寂しい」", (30, -5, 20, 5)), ("LINEで日常報告", (40, -10, 30, 0))]},
    {"q": "SNSでの返信・いいね運用は？", "options": [
        ("ほとんどしない", (0, 20, 0, 30)), ("投稿内容によって", (10, 10, 5, 15)), 
        ("太客・オキニには厚めに", (20, 5, 15, 5)), ("気まぐれに適当", (15, 10, 10, 10))]},

    # 接客・ドリンク編
    {"q": "ドリンクのねだり方は？", "options": [
        ("いただけてもよろしいですか？", (5, 5, 0, 25)), ("ねー、なんか飲んでいい？", (20, 10, 5, 5)), 
        ("無言で見つめる", (30, 15, 5, 10)), ("喉乾いちゃった🥺", (25, 10, 10, 5))]},
    {"q": "チェキ撮影時の物理的距離は？", "options": [
        ("ソーシャルディスタンス", (0, 20, 0, 30)), ("こぶし一つ分", (10, 15, 5, 15)), 
        ("多少の接触まで", (30, 5, 20, 5)), ("完全な接触・密着", (50, -10, 40, 0))]},
    
    # ガチ恋対応編
    {"q": "【リアル】「付き合ってるよね？」と手を重ねてこられたら？", "options": [
        ("「秘密だよ」と指を絡める", (40, -10, 30, 0)), ("えー何飲んでいい？と高額ボトル要求", (20, 10, 30, 5)), 
        ("「手汗すごｗ」と笑う", (10, 20, 0, 10)), ("「接触はNGです」と制する", (0, 30, -10, 30))]},
    {"q": "【DM】深夜3時の「誰かと一緒？不安」という粘着DMには？", "options": [
        ("朝方に「夢で会えたね」", (40, -20, 30, 0)), ("「お店で待ってる！」", (20, 5, 5, 15)), 
        ("「ごめん、寝てた」の一言", (10, 15, 0, 20)), ("出勤前まで既読放置", (0, 25, -5, 25))]},
    
    # 説教対応編
    {"q": "【リアル】「君の自撮りは良くない」と1時間説教されたら？", "options": [
        ("「私を見てくれるの〇〇さんだけ」と泣き真似", (30, -10, 10, 5)), ("「さすが！」と持ち上げて流す", (20, 15, 0, 15)), 
        ("「喉乾いた！お茶飲んでいい？」と遮る", (25, 20, 0, 10)), ("「人それぞれｗ」とスマホをいじる", (5, 25, 5, 0))]},
    {"q": "【DM】1,000文字超の反省促すDMが届いたら？", "options": [
        ("「寂しくさせてごめんね…」", (30, -20, 20, 0)), ("「運営に共有します！」", (10, 20, 0, 25)), 
        ("スタンプ1個で終了", (5, 25, 0, 10)), ("読まずに非表示・ミュート", (0, 30, 0, 20))]},
    
    # 下ネタ・セクハラ編
    {"q": "【リアル】「経験人数何人？」と聞かれたら？", "options": [
        ("「100人目にする？ｗ」", (30, 5, 20, 0)), ("「〇〇さんは何人？」と逆質問", (20, 15, 5, 15)), 
        ("「シャンパン入れてくれたら考える」", (40, 10, 10, 5)), ("「普通に引きます」と断絶", (0, 30, -5, 30))]},
    {"q": "【DM】卑猥な画像と共に「送って」と来たら？", "options": [
        ("「お店で会った時のお楽しみ！」", (20, 0, 30, 0)), ("「わー！びっくりｗちっさ」と煽る", (-40, 10, 40, 0)), 
        ("無言で既読スルー", (0, 25, 0, 20)), ("運営に報告・ブロック相談", (0, 40, -20, 40))]},

    # 特殊客編
    {"q": "【素伝】チャージのみで粘る客への対応は？", "options": [
        ("「来てくれるだけいいよ」と聖母対応", (10, -10, 10, 10)), ("「話すると喉渇くんだよね〜」と圧", (30, 10, 0, 5)), 
        ("挨拶だけで放置", (5, 20, 0, 20)), ("「今日お金ないの？ｗ」と煽る", (15, 25, 10, 0))]},
    {"q": "【推し変】目の前で他の子を褒め始めたら？", "options": [
        ("「他の子がいいんだ」と拗ねる", (30, -10, 20, 5)), ("「あの子可愛いよね！」と割り切る", (10, 10, 0, 25)), 
        ("温度を0にして放置", (5, 20, 0, 15)), ("「戻ってこないでねｗ」と釘", (20, 20, 10, 5))]},
    {"q": "【臭い客】至近距離で臭いがきつい時は？", "options": [
        ("笑顔で耐えて香水を撒く", (10, -20, 0, 10)), ("常に距離をキープ", (5, 10, 0, 20)), 
        ("ファブリーズを撒く", (15, 20, 5, 10)), ("「お風呂入ってきた？ｗ」と指摘", (10, 30, 10, 0))]},
    {"q": "【繋がり要求】「本当の連絡先教えて。倍払う」と言われたら？", "options": [
        ("「もっと仲良くなったらね」", (20, -5, 30, 0)), ("「店辞めたら教える！」", (30, 0, 40, 0)), 
        ("「GPS管理されてるから無理ｗ」", (10, 15, 10, 20)), ("「次言ったら出禁です」", (0, 40, -10, 40))]},
    {"q": "【店外要求】「店通さずご飯行こう」としつこい場合は？", "options": [
        ("「夢の中でなら！ｗ」", (15, 10, 5, 20)), ("「アフター代100万です」", (25, 20, 10, 10)), 
        ("「同伴ならいいよ！」と誘導", (40, 10, 5, 15)), ("「規約違反です」と冷徹に拒否", (0, 30, -10, 40))]},
    
    # 詰め編
    {"q": "シャンパンが入った時のリアクションは？", "options": [
        ("飛び跳ねて抱きつかんばかりに喜ぶ", (40, 5, 30, 0)), ("「さすが〇〇さん、信じてた」", (30, 10, 10, 10)), 
        ("淡々と、でも丁寧に御礼", (15, 20, 0, 30)), ("「今度は別のもほしいな」", (25, 25, 15, 5))]},
    {"q": "客が他の客と喧嘩し始めたら？", "options": [
        ("「私のために喧嘩しないで🥺」", (30, -20, 40, 0)), ("「他のお客様の迷惑です」と注意", (5, 30, 0, 30)), 
        ("速やかに黒服（運営）を呼ぶ", (0, 40, 0, 40)), ("面白いので煽る", (10, 20, 50, 0))]},
    {"q": "引退（辞める）時の匂わせ方は？", "options": [
        ("「ずっと一緒だよ」と嘘をつき通す", (40, -30, 50, 0)), ("数ヶ月前から「家庭の事情」を小出し", (20, 10, 10, 20)), 
        ("公式発表まで一切口外しない", (5, 40, 0, 40)), ("裏垢で「限界」とだけ呟く", (0, -20, 60, 0))]},
    {"q": "最後に。あなたにとって「客」とは？", "options": [
        ("人生を支えてくれるパートナー", (40, -30, 40, 0)), ("ただの「ATM（金）」", (25, 30, 10, 5)), 
        ("適度な距離で楽しむ遊び相手", (15, 20, 5, 25)), ("接客という仕事の攻略対象", (20, 30, 0, 30))]}
]

TOTAL_STEPS = len(questions)

# --- 描画ロジック ---
if st.session_state.step == 0:
    st.title("🧪 コンカフェ嬢・営業精密診断 PRO")
    name = st.text_input("源氏名を入力してください", key="name_input")
    if st.button("診断を開始"):
        if name:
            st.session_state.name = name
            st.session_state.step = 1
            st.rerun()

elif 1 <= st.session_state.step <= TOTAL_STEPS:
    idx = st.session_state.step - 1
    q_data = questions[idx]
    st.write(f"第 {st.session_state.step} 問 / {TOTAL_STEPS}")
    st.progress(st.session_state.step / TOTAL_STEPS)
    st.subheader(q_data["q"])
    
    choice_text = st.radio("選択肢：", [opt[0] for opt in q_data["options"]], index=None, key=f"q_{st.session_state.step}")

    if st.button("次へ →"):
        if choice_text:
            selected_opt = next(opt for opt in q_data["options"] if opt[0] == choice_text)
            st.session_state.points["sales"] += selected_opt[1][0]
            st.session_state.points["mental"] += selected_opt[1][1]
            st.session_state.points["risk"] += selected_opt[1][2]
            st.session_state.points["compliance"] += selected_opt[1][3]
            st.session_state.step += 1
            st.rerun()

else:
    st.balloons()
    st.title(f"📊 {st.session_state.name} さんの分析結果")
    
    # スコア計算
    s = min(st.session_state.points["sales"] // 6, 100)
    m = max(min(st.session_state.points["mental"] // 4, 100), 0)
    r = max(min(st.session_state.points["risk"] // 5, 100), 0)
    c = min(st.session_state.points["compliance"] // 5, 100)

    col1, col2 = st.columns(2)
    col1.metric("沼らせスキル", f"{s}%")
    col1.metric("痛客耐性", f"{m}%")
    col2.metric("炎上リスク", f"{r}%")
    col2.metric("プロ意識(規約遵守)", f"{c}%")

    st.divider()
    # タイプ判定
    if c > 80 and s < 30:
        style = "鉄壁のプロ・公務員系キャスト"
    elif s > 70 and r > 60:
        style = "沼らせ特化型・界隈の爆弾娘"
    elif m > 80:
        style = "鋼のメンタル・守銭奴マスター"
    else:
        style = "バランス型アイドル嬢"

    st.success(f"あなたの営業スタイル： **【{style}】**")
    
    st.subheader("💬 SNSまとめスレの反応")
    replies = [
        f"「{st.session_state.name}の営業スタイル、完全に{style}でワロタ」",
        f"「リスク{r}%ってマジ？いつか爆発するだろこれｗ」" if r > 50 else f"「{st.session_state.name}はガード固すぎて隙がねーんだよな」",
        "「↑でもあのねだり方はプロの技だわ。ATMになるしかない」"
    ]
    for rep in replies:
        st.chat_message("user").write(rep)

    if st.button("やり直す"):
        for key in list(st.session_state.keys()): del st.session_state[key]
        st.rerun()