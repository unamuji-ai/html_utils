import streamlit as st
import pandas as pd
import plotly.express as px
import random

# ページ設定
st.set_page_config(page_title="あなたに対するネット上の評価", layout="centered")

# --- セッション状態の初期化 ---
if 'step' not in st.session_state:
    st.session_state.step = 0
if 'answers' not in st.session_state:
    st.session_state.answers = []
# sales: 営業火力, mental: 対人胆力, risk: 爆弾指数, compliance: 規律遵守
if 'points' not in st.session_state:
    st.session_state.points = {"sales": 0, "mental": 0, "risk": 0, "compliance": 0}

# --- 劇薬化された設問データ ---
# 配点順: (営業火力, 対人胆力, 爆弾指数, 規律遵守)
questions = [
    # SNS・自撮り編
    {
      "q": "自撮りを投稿するとき、どんな基準で選ぶことが多い？",
      "options": [
        ("盛れてる写真を厳選して投稿する", (5, 0, -10, 50)),
        ("スタイルがよく見える写真を選びがち", (25, 15, 15, 0)),
        ("刺激的・インパクト重視で選ぶ", (45, 45, 60, -50)),
        ("気分で撮ったものをそのまま上げる", (15, -15, 30, 0))
      ]
    },
    {
      "q": "SNSでの営業、あなたの“基本スタンス”に近いのは？",
      "options": [
        ("投稿中心で、営業感は控えめにしている", (-10, -20, 0, 40)),
        ("必要なときだけ軽く声をかけて様子を見る", (15, 5, 5, 20)),
        ("距離を縮めるために感情表現を多めに使う", (35, 25, 30, -10)),
        ("積極的に誘って予定を取りにいくスタイル", (50, 40, 20, -20))
      ]
    },
    {
      "q": "SNSでの返信・いいね、あなたの“運用スタイル”に近いのは？",
      "options": [
        ("必要最低限だけ返すタイプ", (-20, -30, 0, 30)),
        ("決まったタイミングでまとめて反応する", (-5, 10, 10, 30)),
        ("関係性に応じてメリハリをつけて反応する", (40, 30, 40, -10)),
        ("気分で返したり返さなかったりする", (15, 15, 20, 15))  # ★ risk微調整
      ]
    },

    # 接客・ドリンク編
    {
      "q": "ドリンクをお願いするとき、あなたの“普段のスタイル”に近いのは？",
      "options": [
        ("丁寧にタイミングを見てお願いする", (5, -10, -5, 50)),
        ("軽いノリで気楽に声をかける", (30, 20, 20, -10)),
        ("相手の反応を見ながら無言の圧で伝える", (40, 40, 30, 10)),
        ("雑談の流れで自然に欲しさを匂わせる", (25, 15, 15, 5))
      ]
    },
    {
      "q": "チェキ撮影のとき、あなたが取りがちな“距離感”に近いのは？",
      "options": [
        ("基本は距離を保って安心感を優先する", (-20, -10, -10, 50)),
        ("自然に会話できるくらいの適度な距離を取る", (10, 5, 5, 30)),
        ("盛り上がりに合わせて少し近づくこともある", (35, 25, 25, 0)),
        ("相手に寄り添ってかなり近い距離で撮る", (60, 50, 60, -50))
      ]
    },

    # ガチ恋対応編
    {
      "q": "「付き合ってるよね？」と手を重ねられたとき、あなたの“実際の反応”に近いのは？",
      "options": [
        ("相手を喜ばせる方向で、あえて距離を縮める", (60, 60, 50, -60)),
        ("その場の空気を利用して、営業に繋げる方向へ誘導する", (10, 40, 50, 0)),
        ("場を壊さない程度に軽く受け流す", (40, 20, 20, 0)),
        ("線引きを明確にして、落ち着いて距離を戻す", (-30, -40, -20, 60))
      ]
    },
    {
      "q": "深夜にかまって系の粘着DMが来たとき、あなたの“普段の対処”に近いのは？",
      "options": [
        ("軽く返して区切りをつける", (20, 10, 0, 10)),
        ("そのまま未読で流して距離を置く", (-10, -20, 0, 40)),
        ("翌朝に短くフォローだけ入れる", (10, 0, 5, 30)),
        ("しばらく既読にせず様子を見る", (5, -10, 5, 30))  # ★ risk微調整
      ]
    },

    # 説教対応編
    {
      "q": "自撮りや髪型を否定されて説教され始めたとき、あなたの“実際の対処”に近いのは？",
      "options": [
        ("相手の好みを聞き出して、あえて会話を深める", (40, 50, -10, 30)),
        ("軽く受け流して、場の空気を和らげる", (5, 10, 5, 20)),
        ("話題を変えて、その場の流れを切り替える", (-10, 20, 15, 15)),
        ("自分のスタイルを尊重して、はっきり意見を伝える", (-20, 30, 30, 5))
      ]
    },
    {
      "q": "長文でダメ出しDMが届いたとき、あなたの“普段の対処”に近いのは？",
      "options": [
        ("とりあえず受け入れる姿勢を見せて、関係を保つ方向に返す", (50, 50, -10, 30)),
        ("反応せず距離を置きつつ、後でネタとして処理する", (-20, 30, 40, -10)),
        ("軽いスタンプや一言で、深く関わらず終わらせる", (-15, 20, 20, 10)),
        ("関係を断つためにブロックやミュートで線引きする", (-40, -50, 20, 10))
      ]
    },

    # 下ネタ・セクハラ編
    {
      "q": "下ネタで距離を詰められたとき、あなたの“実際の反応”に近いのは？",
      "options": [
        ("あえて乗って、相手の期待に合わせて距離を縮める", (50, 60, 50, -40)),
        ("とぼけて流しつつ、場の空気だけ整える", (0, -10, -10, 20)),
        ("営業に繋がる方向へ軽く誘導してかわす", (30, 25, 20, 10)),
        ("不快さを明確に伝えて、線引きをする", (-20, -50, -10, 60))
      ]
    },
    {
      "q": "卑猥な画像と一緒に不適切な要求DMが来たとき、あなたの“実際の対処”に近いのは？",
      "options": [
        ("営業に繋がる方向へ条件を提示してかわす", (20, 60, 30, -30)),
        ("相手を軽くいじって、距離を保ちながら返す", (-30, 50, 20, -10)),
        ("反応せず既読スルーで流す", (0, -10, 0, 30)),
        ("運営やスタッフに相談して線引きをする", (0, 10, -30, 50))
      ]
    },

    # 特殊客編
    {
      "q": "ドリンクを出さない客に対して、あなたが取りがちな“距離感”に近いのは？",
      "options": [
        ("来てくれるだけで十分と考えて、丁寧に接する", (45, 40, 20, 10)),
        ("軽い一言で、さりげなくドリンクを促す", (15, 20, 15, 10)),
        ("挨拶だけして、あとは無理に関わらず距離を置く", (-20, -15, 10, 30)),
        ("ダメもとで軽くお願いしてみる", (5, 20, 5, 20))
      ]
    },
    {
      "q": "目の前で他の子を褒め始められたとき、あなたの“実際の反応”に近いのは？",
      "options": [
        ("拗ねて気を引こうとする", (40, 20, 10, -10)),
        ("割り切って明るく受け流す", (5, 10, 5, 30)),
        ("温度を下げて距離を置く", (-5, -10, 15, 20)),
        ("突き放すように切り捨てる", (-10, -10, 30, -10))
      ]
    },
    {
      "q": "至近距離で強いニオイを感じたとき、あなたの“実際の対処”に近いのは？",
      "options": [
        ("笑顔を保ちながら、自分の香りでごまかす", (20, 40, 5, 30)),
        ("気づかれないように距離を取り続ける", (5, -10, 5, 20)),  # ★ risk微調整
        ("その場でニオイ対策をして空気を変える", (10, 30, 30, -20)),
        ("軽く指摘して状況を変えようとする", (-10, 40, 20, -30))
      ]
    },
    {
      "q": "本名やLINEなど、過度な繋がりを求められたとき、あなたの“実際の対応”に近いのは？",
      "options": [
        ("関係を保ちながら、やんわり先延ばしにする", (30, 30, 20, 10)),
        ("期待を持たせつつ、実質的には断る方向に誘導する", (45, 20, 50, -20)),
        ("軽く断って、場の空気だけ整える", (0, 10, 5, 20)),
        ("ルールを明確に伝えて、強めに線引きする", (-30, 30, -20, 60))
      ]
    },
    {
      "q": "店外に誘われたとき、あなたの“実際の対応”に近いのは？",
      "options": [
        ("期待を持たせつつ、実際には行かない方向にする", (55, 40, 15, -40)),
        ("高い条件を提示して、実質的に断る方向へ誘導する", (15, 40, 30, 10)),
        ("相手や状況によって判断を変える", (5, 30, 60, -60)),
        ("ルールを理由にして、はっきり断る", (-20, -20, -20, 60))
      ]
    },

    # 詰め編
    {
      "q": "シャンパンが入ったとき、あなたの“リアクションのスタイル”に近いのは？",
      "options": [
        ("実際より大きめに喜びを表現する", (30, 10, 30, 30)),
        ("相手を喜ばせるために、特別感のある言葉を添える", (50, 45, 20, -10)),
        ("落ち着いたテンションで、丁寧にお礼を伝える", (10, -10, 5, 30)),
        ("次の提案をしながら、軽く期待を持たせる", (20, 30, 20, 10))
      ]
    },
    {
      "q": "客同士が喧嘩を始めたとき、あなたの“実際の対応”に近いのは？",
      "options": [
        ("安全を最優先して、スタッフや警察に任せる", (0, -10, 20, 50)),
        ("落ち着いて状況を止めるために声をかける", (-10, 30, -10, 40)),
        ("自分は関わらず、様子を見て放置する", (0, -30, 10, -30)),
        ("面白がって状況をさらに煽る", (0, 30, 60, -50))
      ]
    },
    {
      "q": "卒業時に繋がりを求めてくる客への対応として、あなたの“実際のスタイル”に近いのは？",
      "options": [
        ("期待を持たせる言葉で、関係を保つ方向にする", (60, 50, 40, -50)),
        ("きちんと線引きしつつ、感謝だけ伝える", (-20, -10, -20, 50)),
        ("相手や状況によって対応を変える", (10, -10, 40, -40)),
        ("次の機会を匂わせて、柔らかくかわす", (20, 20, 10, 20))
      ]
    },
    {
      "q": "あなたにとって“客”という存在は、どんな距離感に近い？",
      "options": [
        ("関わりを通して自分も成長できる相手", (30, 30, 20, 30)),
        ("利益をもたらす対象として割り切っている", (-30, 30, 50, 0)),
        ("適度な距離で一緒に楽しむ相手", (15, 10, 10, 40)),
        ("仕事として攻略していく対象", (15, 25, 10, 20))
      ]
    }
]

TOTAL_STEPS = len(questions)

# --- 画面描画 ---
if st.session_state.step == 0:
    st.title("🌐 コンカフェ嬢・営業精密診断 PRO")
    st.warning("⚠️ **診断の際のお願い**\n\n特定の個人や状況に限定せず、**平均的な自身の振る舞い**をイメージして回答してください。")
    name = st.text_input("源氏名を入力してください", key="name_input")
    if st.button("診断を開始"):
        if name:
            st.session_state.name = name
            st.session_state.step = 1
            st.rerun()

elif 1 <= st.session_state.step <= TOTAL_STEPS:
    idx = st.session_state.step - 1
    q_data = questions[idx]
    st.write(f"第 {st.session_state.step} 問 / {TOTAL_STEPS}")
    st.progress(st.session_state.step / TOTAL_STEPS)
    st.subheader(q_data["q"])
    choice_text = st.radio("選択肢：", [opt[0] for opt in q_data["options"]], index=None, key=f"q_{st.session_state.step}")
    if st.button("次へ →"):
        if choice_text:
            selected_opt = next(opt for opt in q_data["options"] if opt[0] == choice_text)
            st.session_state.points["sales"] += selected_opt[1][0]
            st.session_state.points["mental"] += selected_opt[1][1]
            st.session_state.points["risk"] += selected_opt[1][2]
            st.session_state.points["compliance"] += selected_opt[1][3]
            st.session_state.step += 1
            st.rerun()

else:
    st.balloons()
    st.title(f"📊 {st.session_state.name} さんの分析結果")
    
    # --- スコア計算（シミュレーション済みの分母調整） ---
    s = max(min(st.session_state.points["sales"] // 5, 100), 0)
    m = max(min(st.session_state.points["mental"] // 6, 100), 0)
    r = max(min(st.session_state.points["risk"] // 6, 100), 0)
    c = max(min(st.session_state.points["compliance"] // 4, 100), 0)

    # レーダーチャート
    df_plot = pd.DataFrame(dict(r=[s, m, r, c], theta=['営業火力', '対人胆力', '爆弾指数', '規律遵守']))
    fig = px.line_polar(df_plot, r='r', theta='theta', line_close=True, range_r=[0,100])
    fig.update_traces(fill='toself', line_color='#FF4B4B')
    st.plotly_chart(fig)

    col1, col2 = st.columns(2)
    col1.metric("営業火力", f"{s}%")
    col1.metric("対人胆力", f"{m}%")
    col2.metric("爆弾指数", f"{r}%")
    col2.metric("規律遵守", f"{c}%")

    st.divider()

    # --- クラスター判定ロジック ---
    style, desc = "バランス型アイドル嬢", "全てのステータスが平均的。王道の立ち回りで安定した人気を誇るエース候補です。"
    titles = ["【安定】〇〇ちゃんは安定感あるよな。迷ったらとりあえず行け。"]
    replies = ["「診断結果、完全に今の立ち回りと一致してて草」", "「最近あそこの店、この子が目立ってるな。次期エースだろ」"]

    # 1. 超・極端タイプ (特筆すべき突き抜け)
    if s > 85 and c > 80:
        style, desc = "伝説のプロキャスト", "高い規律と圧倒的な営業火力を両立。運営・客の双方から神格化される完成形。"
        titles = ["【神】〇〇店の『伝説の嬢』、ついに見つかるｗ"]
        replies = [f"「{st.session_state.name}様、昨日もタワー立ててて格が違いすぎたわ」", "「プロ意識の塊。店外誘ったら笑顔で高額シャンパン空けさせられたｗ」"]
        
    elif r > 80 and c < 30:
        style, desc = "界隈の劇薬・爆弾娘", "リスク度外視の攻撃スタイル。ネット掲示板で『絶対に関わるな』と晒されるスリル担当。"
        titles = ["【警告】ガチ恋泥棒・〇〇ちゃん、今日も元気に繋がり発覚ｗ"]
        replies = [f"「昨日{st.session_state.name}と外歩いてるの見たぞ。運営寝てるんか？」", "「爆弾指数高すぎｗもはや清々しいな、お前ら絶対近づくなよ」"]
        
    # 2. 意外な2軸の組み合わせ (相関を逆手に取った個性)
    elif m > 65 and c > 70:
        style, desc = "裏番長・フィクサー嬢", "感情に流されず、規律を守りつつ客を統治する。運営の信頼が最も厚い影の支配者。"
        titles = ["【最強】〇〇店の番長、客の喧嘩を『一瞥』で鎮圧ｗｗ"]
        replies = ["「客が揉め始めた瞬間、無言で圧かけて黙らせてて震えたわ」", f"「{st.session_state.name}が辞めたらこの店終わるって店長が泣いてたぞ」"]

    elif s > 70 and r > 60:
        style, desc = "計算高いビジネス地雷", "営業のために『病み』や『危うさ』を武器にする。どこまでが演技か不明なプロ地雷。"
        titles = ["【職人芸】〇〇ちゃんの『ビジネス病み』に釣られた被害者の会"]
        replies = ["「病みツイートに釣られてシャンパン入れた俺が馬鹿だった。裏で笑ってそう」", "「どこまでが演技なんだ…？ 怖すぎて逆にハマるわ」"]

    elif s < 40 and c > 75:
        style, desc = "愛され天然・養われ型", "必死な営業は皆無。ただそこに『純粋』に存在することで、客の保護欲をカンストさせる才。"
        titles = ["【絶滅危惧種】ガツガツしてない〇〇ちゃん、おじさんの財布を無自覚に破壊ｗ"]
        replies = ["「この子にだけは『金ないならいいよ』って言わせたくない。俺が稼ぐ。」", f"「{st.session_state.name}に営業されたことないけど、気づいたら月50使ってたわ」"]

    elif m > 75 and c < 40:
        style, desc = "無敵のサイコパス営業", "メンタルが強すぎて、客を詰めたりルールを無視しても心が痛まない、ある意味で最強の女。"
        titles = ["【悲報】〇〇店のキャスト、客の説教を『BGM』扱いしててワロタ"]
        replies = ["「客にブスって言われて『えーｗお揃いですねｗ』って返してて草生えた」", "「鋼のメンタルすぎて詰めが効かない。最終的にこっちが謝ってたわ」"]

    elif s > 70 and m < 40:
        style, desc = "ガラスの特攻隊長", "高い営業火力を持つが、メンタルは繊細。売上の波で情緒が激しく揺れ動く、目が離せないタイプ。"
        titles = ["【不安定】〇〇店のNo.1、今日もシャンパン飲んで泣いてるｗ"]
        replies = [f"「{st.session_state.name}、売上えぐいのにすぐ病むから目が離せん」", "「情緒がジェットコースターすぎて、支えてあげなきゃ感がすごいわ」"]

    elif r < 30 and s < 30:
        style, desc = "清廉潔白な置物(地蔵)", "悪いことは一切しないが、営業も一切しない。清らかすぎてコンカフェの空気を浄化する専門。"
        titles = ["【浄化】〇〇店の新人、ただ座ってるだけで時給発生ｗｗ"]
        replies = ["「挨拶して以降ずっと黙っててワロタ。逆に出勤してるのが奇跡だろ」", "「この子だけは絶対に汚しちゃいけない気がする。拝むための存在」"]

    # 3. バランス型の中の細分化
    elif s > 50 and m > 50:
        style, desc = "王道・次期エース候補", "全ての項目が平均以上で、特に攻めの姿勢がある。安定した人気を誇る将来の看板嬢。"
        titles = ["【朗報】〇〇店の期待の新人、非の打ち所がない王道スタイル。"]
        replies = ["「非の打ち所がないな。このままいけば半年後には看板だわ」", "「対応に隙がない。教育が行き届いてるのか、本人のセンスか…」"]
    
    # 判定なし（上記すべてに漏れた場合）
    else:
        style, desc = "愛想笑いのプロ(八方美人)", "誰からも嫌われないが、決定打に欠ける器用貧乏タイプ。毒にも薬にもならない安定感。"
        titles = ["【安定】〇〇ちゃんは安定感あるよな。迷ったらとりあえず行け。"]
        replies = ["「良くも悪くも普通。とりあえず誰が行っても外れはない感じ」", "「愛想はいいんだけど、もう一押し欲しいよな。頑張れ」"]

    # --- 表示処理 ---
    st.success(f"あなたの営業スタイル： **【{style}】**")
    st.write(desc)

    st.subheader("💬 SNSまとめスレの反応")
    st.info(f"📁 {random.choice(titles)}")
    for rep in replies:
        st.chat_message("user").write(rep)


    if st.button("最初からやり直す"):
        for key in list(st.session_state.keys()): del st.session_state[key]
        st.rerun()