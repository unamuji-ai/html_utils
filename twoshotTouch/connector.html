<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2På¯¾æˆ¦ï¼šèƒŒæ™¯åŒæœŸ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; background: #f0f2f5; margin: 0; }
        .box { background: white; border-radius: 12px; padding: 15px; margin: 5px; width: 95%; max-width: 400px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        .game-container { display: flex; flex-direction: column; gap: 10px; width: 100%; align-items: center; }
        .canvas-wrapper { position: relative; width: 100%; max-width: 280px; }
        .canvas-label { font-size: 12px; font-weight: bold; margin-bottom: 2px; color: #555; }
        
        canvas { border: 2px solid #ddd; background: #fff; touch-action: none; width: 100%; height: 150px; border-radius: 8px; background-size: cover; background-position: center; }
        #myCanvas { border-color: #4444ff; } /* è‡ªåˆ†ã®æ  */
        #opponentCanvas { border-color: #ff4444; pointer-events: none; } /* ç›¸æ‰‹ã®æ  */

        .emoji-selector { display: flex; justify-content: center; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .emoji-selector label { cursor: pointer; font-size: 20px; padding: 5px; border: 1px solid #eee; border-radius: 5px; }
        .emoji-selector input { display: none; }
        .emoji-selector input:checked + span { background: #e3f2fd; border-bottom: 2px solid #2196f3; }

        #log { width: 100%; height: 60px; border: 1px solid #eee; overflow-y: auto; font-size: 11px; margin-top: 10px; text-align: left; background: #fafafa; padding: 5px; box-sizing: border-box; }
        .hidden { display: none; }
        #status { font-size: 14px; color: #2196f3; font-weight: bold; }
        button { cursor: pointer; background: #2196f3; color: white; border: none; padding: 8px 12px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="box">
        <div id="status">é€šä¿¡æº–å‚™ä¸­...</div>
        <div id="setup-area">
            <div id="invite-link-display">URLç”Ÿæˆä¸­...</div>
        </div>
    </div>

		<div id="game-area" class="game-container hidden">
		    
		    <div style="width: 95%; max-width: 400px; text-align: right; margin-bottom: 5px;">
		        <button onclick="quitGame()" style="background: #ff4444; font-size: 12px; padding: 8px 15px; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
		            å¯¾æˆ¦ã‚’çµ‚äº†ã™ã‚‹
		        </button>
		    </div>

		    <div class="canvas-wrapper">
		        <div class="canvas-label">ç›¸æ‰‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (ç›¸æ‰‹ãŒé¸ã‚“ã èƒŒæ™¯)</div>
		        <canvas id="opponentCanvas" width="280" height="150"></canvas>
		    </div>

		    <div class="box">
		        <div class="canvas-label">ã‚ãªãŸã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (è‡ªåˆ†ãŒé¸ã‚“ã èƒŒæ™¯)</div>
		        
		        <div style="margin: 10px 0; padding: 10px; border: 1px dashed #ccc; border-radius: 8px;">
		            <span style="font-size: 11px;">è‡ªåˆ†ã®èƒŒæ™¯ã‚’è¨­å®šãƒ»é€ä¿¡ï¼š</span><br>
		            <input type="file" id="bgInput" accept="image/*" style="font-size: 11px; width: 100%;">
		        </div>

		        <div class="emoji-selector">
		            <label><input type="radio" name="emoji" value="ğŸ¤š" checked onchange="changeEmoji(this.value)"><span>ğŸ¤š</span></label>
		            <label><input type="radio" name="emoji" value="ğŸ‘" onchange="changeEmoji(this.value)"><span>ğŸ‘</span></label>
		            <label><input type="radio" name="emoji" value="ğŸ‘ƒ" onchange="changeEmoji(this.value)"><span>ğŸ‘ƒ</span></label>
		            <label><input type="radio" name="emoji" value="ğŸ‘…" onchange="changeEmoji(this.value)"><span>ğŸ‘…</span></label>
		            <label><input type="radio" name="emoji" value="ğŸ‘„" onchange="changeEmoji(this.value)"><span>ğŸ‘„</span></label>
		        </div>
		        
		        <div class="canvas-wrapper">
		            <canvas id="myCanvas" width="280" height="150"></canvas>
		        </div>
		        <div id="log"></div>
		    </div>
		</div>

		<div id="exit-area" class="box hidden">
		    <h2 style="color: #ff4444;">ä¼ç¥¨ï¼šãŠä¼šè¨ˆ</h2>
		    <p id="exit-message" style="font-size: 14px; margin-bottom: 10px;"></p>
		    <div style="background: #fff9c4; padding: 15px; border: 2px dashed #fbc02d; border-radius: 8px; margin: 10px 0;">
		        <span style="font-size: 12px; color: #666;">ãƒ—ãƒ¬ã‚¤æ–™é‡‘</span><br>
		        <span id="final-bill" style="font-size: 28px; font-weight: bold; color: #d32f2f;">0</span><br>
		        <span style="font-size: 16px; font-weight: bold;">ã‚’ãŠç›¸æ‰‹ã«è«‹æ±‚ã—ã¦ãã ã•ã„</span>
		    </div>
		    <div style="margin-top: 20px;">
		        <button onclick="location.href=location.pathname" style="background: #2196f3;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
		    </div>
		</div>

    <script>
        const peer = new Peer({ debug: 2 });
        let conn = null;
        let myPos = { x: 0.5, y: 0.5 };
        let opponentPos = { x: 0.5, y: 0.5 };
        let myEmoji = "ğŸ¤š";
        let opponentEmoji = "ğŸ¤š";

				let myScore = 0;
				let opponentScore = 0;
				let lastTouchPos = { x: 0, y: 0 };
				let comboCount = 0;

				// çµµæ–‡å­—ã”ã¨ã®ãƒã‚¤ãƒ³ãƒˆè¨­å®š
				const emojiPower = {
				    "ğŸ¤š": 500,
				    "ğŸ‘": 300,
				    "ğŸ‘ƒ": 800,
				    "ğŸ‘…": 1500,
				    "ğŸ‘„": 1000
				};
				let myCounts = { "ğŸ¤š": 0, "ğŸ‘": 0, "ğŸ‘ƒ": 0, "ğŸ‘…": 0, "ğŸ‘„": 0 };
				let opponentCounts = { "ğŸ¤š": 0, "ğŸ‘": 0, "ğŸ‘ƒ": 0, "ğŸ‘…": 0, "ğŸ‘„": 0 };

				// --- è¿½åŠ ï¼šã‚¨ãƒ•ã‚§ã‚¯ãƒˆç®¡ç†ç”¨å¤‰æ•° ---
				let myEffectTimer = 0;
				let oppEffectTimer = 0;

        const myCanvas = document.getElementById("myCanvas");
        const oppCanvas = document.getElementById("opponentCanvas");
        const myCtx = myCanvas.getContext("2d");
        const oppCtx = oppCanvas.getContext("2d");
        const logDiv = document.getElementById("log");

				const scoreBoard = document.createElement("div");
				scoreBoard.style = "display:flex; justify-content:around; width:100%; font-weight:bold; margin:10px 0; font-size:18px;";
				scoreBoard.innerHTML = `
				    <div style="color:blue;">ã‚ãªãŸ: <span id="my-score">0</span></div>
				    <div style="margin:0 20px;">VS</div>
				    <div style="color:red;">ç›¸æ‰‹: <span id="opp-score">0</span></div>
				`;
				document.getElementById("game-area").prepend(scoreBoard);

        function addLog(text) {
            const div = document.createElement("div");
            div.textContent = text;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('room');

        peer.on('open', (id) => {
            document.getElementById('status').textContent = "IDç™ºè¡Œå®Œäº†";
            if (roomID) {
                conn = peer.connect(roomID, { reliable: true });
                setupDataChannel();
            } else {
                generateInviteLink(id);
            }
        });

        peer.on('connection', (c) => {
            conn = c;
            setupDataChannel();
        });

        function setupDataChannel() {
            conn.on('open', () => {
                document.getElementById('setup-area').classList.add('hidden');
                document.getElementById('game-area').classList.remove('hidden');
                document.getElementById('status').textContent = "æ¥ç¶šæˆåŠŸï¼";
                addLog("ã‚·ã‚¹ãƒ†ãƒ : é€šä¿¡ãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸ");
                render();
            });

						conn.on('data', (payload) => {
								if (payload.type === 'MOVE') {
						        opponentPos = { x: payload.x, y: payload.y };
						        // ç›¸æ‰‹ãŒã‚¯ãƒªãƒƒã‚¯ï¼ˆæ”»æ’ƒï¼‰ã—ãŸæ™‚ã®æ¼”å‡º
						        if (payload.isClick) {
						            oppEffectTimer = 10;
						            showAttackEffect(oppCtx, opponentPos, opponentEmoji);
						        }
						    } else if (payload.type === 'SCORE') {
						        opponentScore = payload.data;
						        document.getElementById("opp-score").textContent = opponentScore;
						    } else if (payload.type === 'EMOJI') {
						        opponentEmoji = payload.data;
								} else if (payload.type === 'QUIT') {
										// ç›¸æ‰‹ã‹ã‚‰QUITãŒå±Šã„ãŸï¼ç›¸æ‰‹ã®æœ€çµ‚ã‚¹ã‚³ã‚¢ãŒç¢ºå®š
						        opponentFinalScore = payload.score;
										opponentCounts = payload.counts; // ç›¸æ‰‹ã®å†…è¨³ã‚’ä¿å­˜
						        // 1. ã‚‚ã—è‡ªåˆ†ãŒã¾ã ã‚²ãƒ¼ãƒ ä¸­ãªã‚‰ã€è‡ªåˆ†ã®æœ€çµ‚ã‚¹ã‚³ã‚¢ã‚’ç›¸æ‰‹ã«è¿”ã—ã¦ã‚ã’ã‚‹
						        if (conn && conn.open && !document.getElementById('game-area').classList.contains('hidden')) {
												conn.send({ 
						                type: 'QUIT_RESPONSE', 
						                score: myScore,
						                counts: myCounts // â˜…ã“ã“ãŒæŠœã‘ã¦ã„ã¾ã—ãŸï¼
						            });
						        }
						        showExitScreen("ç›¸æ‰‹ãŒãƒã‚§ãƒƒã‚¯ï¼ˆãŠä¼šè¨ˆï¼‰ã—ã¾ã—ãŸã€‚", "opponent");
						    } else if (payload.type === 'QUIT_RESPONSE') {
						        // è‡ªåˆ†ãŒQUITã‚’é€ã£ãŸå¾Œã€ç›¸æ‰‹ã‹ã‚‰è¿”ã£ã¦ããŸæœ€çµ‚ã‚¹ã‚³ã‚¢
						        opponentFinalScore = payload.score;
										opponentCounts = payload.counts; // ç›¸æ‰‹ã®å†…è¨³ã‚’ä¿å­˜
						        showExitScreen("ã‚ãªãŸãŒãƒã‚§ãƒƒã‚¯ï¼ˆãŠä¼šè¨ˆï¼‰ã—ã¾ã—ãŸã€‚", "opponent");
						        peer.destroy();

						    } else if (payload.type === 'IMAGE') {
						        // â˜…ã€é‡è¦ã€‘ç›¸æ‰‹ã‹ã‚‰ç”»åƒãŒå±Šã„ãŸã‚‰ã€è‡ªåˆ†ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆmyCanvasï¼‰ã®èƒŒæ™¯ã«ã™ã‚‹
						        const blob = new Blob([payload.data], { type: payload.mime });
						        const url = URL.createObjectURL(blob);
						        myCanvas.style.backgroundImage = `url(${url})`;
						        addLog("ã‚·ã‚¹ãƒ†ãƒ : ç›¸æ‰‹ãŒã‚ãªãŸã®èƒŒæ™¯ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
						    }
						    render();
						});

				    // ç›¸æ‰‹ãŒãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã€ã¾ãŸã¯peer.destroy()ã—ãŸã¨ã
				    conn.on('close', () => {
				        showExitScreen("é€šä¿¡ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚");
				    });
        }


				// æ”»æ’ƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆä¸€ç¬ã ã‘å¤§ããè¡¨ç¤ºã™ã‚‹ãªã©ï¼‰
				function showAttackEffect(ctx, pos, emoji) {
				    ctx.font = "80px serif"; // å·¨å¤§åŒ–
				    ctx.globalAlpha = 0.5;
				    ctx.fillText(emoji, pos.x * oppCanvas.width, pos.y * oppCanvas.height);
				    ctx.globalAlpha = 1.0;
				}

        // ç”»åƒé¸æŠãƒ»é€ä¿¡å‡¦ç†
				document.getElementById('bgInput').addEventListener('change', (e) => {
				    const file = e.target.files[0];
				    if (!file || !conn || !conn.open) return;
				    
				    // 1. è‡ªåˆ†ã®ç”»é¢ã§ã¯ã€Œç›¸æ‰‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆoppCanvasï¼‰ã€ã«åæ˜ ï¼ˆç›¸æ‰‹ã¸ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çš„ãªæ„å‘³åˆã„ï¼‰
				    const previewUrl = URL.createObjectURL(file);
				    oppCanvas.style.backgroundImage = `url(${previewUrl})`;

				    // 2. ç›¸æ‰‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡ï¼ˆç›¸æ‰‹ã®myCanvasã‚’æ›¸ãæ›ãˆã‚‹ãŸã‚ï¼‰
				    conn.send({
				        type: 'IMAGE',
				        data: file,
				        mime: file.type
				    });
				    addLog("ã‚·ã‚¹ãƒ†ãƒ : ç›¸æ‰‹ã®èƒŒæ™¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
				});

        function changeEmoji(val) {
            myEmoji = val;
            if (conn && conn.open) conn.send({ type: 'EMOJI', data: val });
            render();
        }

				// --- å…¥åŠ›å‡¦ç†ã®æ‹¡å¼µï¼ˆhandleInputã‚’å¼·åŒ–ï¼‰ ---
				function handleInput(clientX, clientY, isClick = false) {
				    if (!conn || !conn.open) return;
				    const rect = myCanvas.getBoundingClientRect();
				    const x = (clientX - rect.left) / rect.width;
				    const y = (clientY - rect.top) / rect.height;
				    
				    myPos = { x, y };
				    
				    if (isClick) {
				        calculatePoint(x, y);
				        // è‡ªåˆ†ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ã‚»ãƒƒãƒˆï¼ˆä¾‹ï¼š10ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†ï¼‰
				        myEffectTimer = 10; 
				    }

				    conn.send({ type: 'MOVE', x: myPos.x, y: myPos.y, isClick: isClick });
				    render();
				}

				function calculatePoint(x, y) {
				    // å‰å›ã®å ´æ‰€ã‹ã‚‰è¿‘ã„ï¼ˆ0.05æ¯”ç‡ä»¥å†…ï¼‰ã‹åˆ¤å®š
				    const dist = Math.sqrt(Math.pow(x - lastTouchPos.x, 2) + Math.pow(y - lastTouchPos.y, 2));
				    
				    if (dist < 0.05) {
				        comboCount++;
				    } else {
				        comboCount = 1;
				    }
				    
				    lastTouchPos = { x, y };

						// ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
				    if (myCounts[myEmoji] !== undefined) {
				        myCounts[myEmoji]++;
				    }

				    // ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ï¼šåŸºç¤ç‚¹ Ã— ã‚³ãƒ³ãƒœå€ç‡
				    const basePower = emojiPower[myEmoji] || 10;
				    const comboMultiplier = 1 + (comboCount * 0.2); // 1å›ã”ã¨ã«20%ã‚¢ãƒƒãƒ—
				    const earned = Math.floor(basePower * comboMultiplier);
				    
				    myScore += earned;
				    document.getElementById("my-score").textContent = myScore;

				    // ç›¸æ‰‹ã«ã‚¹ã‚³ã‚¢ã‚’é€šçŸ¥
				    conn.send({ type: 'SCORE', data: myScore });

				    // æ¼”å‡ºï¼šãƒ­ã‚°ã«å‡ºã™
				    if (comboCount > 2) addLog(`ã‚³ãƒ³ãƒœï¼ ${comboCount}é€£æ’ƒ (+${earned}ç‚¹)`);
				}

				myCanvas.addEventListener("mousedown", (e) => handleInput(e.clientX, e.clientY, true));
				myCanvas.addEventListener("touchstart", (e) => {
				    handleInput(e.touches[0].clientX, e.touches[0].clientY, true);
				    e.preventDefault();
				}, { passive: false });

				function render() {
				    // 1. è‡ªåˆ†ã®ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»
				    myCtx.clearRect(0, 0, myCanvas.width, myCanvas.height);
				    
				    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä¸­ãªã‚‰å¤§ããã€ãã†ã§ãªã‘ã‚Œã°æ™®é€šã«æç”»
				    if (myEffectTimer > 0) {
				        drawEmoji(myCtx, myEmoji, myPos, myCanvas, 80, 0.5); // å·¨å¤§
				        myEffectTimer--; // ã‚¿ã‚¤ãƒãƒ¼ã‚’æ¸›ã‚‰ã™
				        // ã‚¿ã‚¤ãƒãƒ¼ãŒæ®‹ã£ã¦ã„ã‚‹é–“ã€è‡ªå‹•ã§å†æç”»ã‚’äºˆç´„ã—ã¦ã€Œæ¶ˆãˆã‚‹ã€ã®ã‚’é…ã‚‰ã›ã‚‹
				        requestAnimationFrame(render); 
				    } else {
				        drawEmoji(myCtx, myEmoji, myPos, myCanvas, 40, 1.0); // é€šå¸¸
				    }
				    
				    // 2. ç›¸æ‰‹ã®ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»
				    oppCtx.clearRect(0, 0, oppCanvas.width, oppCanvas.height);
				    if (oppEffectTimer > 0) {
				        drawEmoji(oppCtx, opponentEmoji, opponentPos, oppCanvas, 80, 0.5);
				        oppEffectTimer--;
				        requestAnimationFrame(render);
				    } else {
				        drawEmoji(oppCtx, opponentEmoji, opponentPos, oppCanvas, 40, 1.0);
				    }
				}

				// å¼•æ•°ã«ã‚µã‚¤ã‚ºã¨é€æ˜åº¦ã‚’è¿½åŠ 
				function drawEmoji(ctx, emoji, pos, cv, size, alpha) {
				    ctx.save(); // çŠ¶æ…‹ã‚’ä¿å­˜
				    ctx.globalAlpha = alpha;
				    ctx.font = `${size}px serif`;
				    ctx.textAlign = "center";
				    ctx.textBaseline = "middle";
				    ctx.fillText(emoji, pos.x * cv.width, pos.y * cv.height);
				    ctx.restore(); // çŠ¶æ…‹ã‚’å¾©å…ƒ
				}

        function generateInviteLink(id) {
            const url = window.location.origin + window.location.pathname + "?room=" + id;
            const displayArea = document.getElementById('invite-link-display');
            if (displayArea) {
                displayArea.innerHTML = `
                    <p style="font-size:11px;">æ‹›å¾…ç”¨URL:</p>
                    <input type="text" value="${url}" id="inviteURL" readonly style="width:80%; padding:5px;">
                    <button onclick="copyURL()">ã‚³ãƒ”ãƒ¼</button><br>
										ç›¸æ‰‹ã«ã“ã®URLã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„
                `;
            }
        }

        function copyURL() {
            const target = document.getElementById("inviteURL");
            target.select();
            document.execCommand("Copy");
            alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
        }

				// --- 0. ç›¸æ‰‹ã®æœ€çµ‚ã‚¹ã‚³ã‚¢ã‚’ä¿æŒã™ã‚‹å¤‰æ•°ã‚’è¿½åŠ  ---
				let opponentFinalScore = 0; 


				// --- 2. çµ‚äº†ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç† ---
				function quitGame() {
				    if (confirm("ãƒ—ãƒ¬ã‚¤ã‚’çµ‚äº†ï¼ˆãŠä¼šè¨ˆï¼‰ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
				        if (conn && conn.open) {
				            // è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢ã‚’é€ã‚Šã¤ã¤ã€ç›¸æ‰‹ã«ã€Œçµ‚ã‚ã‚‹ã‚ˆã€ã¨ä¼ãˆã‚‹
				            conn.send({ 
				                type: 'QUIT', 
				                score: myScore, 
												counts: myCounts // è‡ªåˆ†ã®å†…è¨³ã‚’é€ã‚‹
				            });
				            
				            // ç›¸æ‰‹ã‹ã‚‰ã® 'QUIT_RESPONSE' ã‚’å¾…ã¤ãŸã‚ã«ã€ã“ã“ã§ã¯ã™ã destroy ã—ãªã„
				            // ä¸‡ãŒä¸€ç›¸æ‰‹ãŒåå¿œã—ãªã„æ™‚ã®ãŸã‚ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚‚è¨­å®š
				            setTimeout(() => {
				                if (!document.getElementById('game-area').classList.contains('hidden')) {
				                    showExitScreen("é€šä¿¡å¾…æ©Ÿã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼šãŠä¼šè¨ˆã‚’çµ‚äº†ã—ã¾ã™ã€‚", "opponent");
				                    peer.destroy();
				                }
				            }, 2000); 
				        } else {
				            showExitScreen("ãƒ—ãƒ¬ã‚¤ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚", "me");
				        }
				    }
				}

				// --- 3. çµ‚äº†ç”»é¢ã¸ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ï¼‰ ---
				function showExitScreen(msg, who) {
				    document.getElementById('setup-area').classList.add('hidden');
				    document.getElementById('game-area').classList.add('hidden');
				    const exitArea = document.getElementById('exit-area');
				    exitArea.classList.remove('hidden');
				    document.getElementById('exit-message').textContent = msg;

				    const targetScore = (who === "me") ? myScore : opponentFinalScore;
				    const targetCounts = (who === "me") ? myCounts : opponentCounts;

				    document.getElementById('final-bill').textContent = `ï¿¥${targetScore.toLocaleString()}`;
            document.getElementById('status').textContent = "æ¸…ç®—ä¸­â€¦";

				    // å†…è¨³è¡¨ç¤ºã®ç”Ÿæˆ
				    let detailHtml = '<div style="text-align:left; font-size:12px; font-family:monospace; border-top:1px solid #ccc; padding-top:10px; margin-top:10px;">';
				    detailHtml += '<b>ã€ã‚ªãƒ¼ãƒ€ãƒ¼å†…è¨³ã€‘</b><br>';
				    
				    for (let key in targetCounts) {
				        if (targetCounts[key] > 0) {
				            const price = emojiPower[key] || 0;
				            detailHtml += `${key} Ã— ${targetCounts[key]}å› â€¦ ï¿¥${(price * targetCounts[key]).toLocaleString()}<br>`;
				        }
				    }
				    detailHtml += '</div>';

				    // æ—¢å­˜ã®billElementã®å¾Œã«æŒ¿å…¥ã€ã¾ãŸã¯å°‚ç”¨ã®divã‚’HTMLã«è¿½åŠ ã—ã¦ãã ã•ã„
				    const billElement = document.getElementById('final-bill');
				    // ã™ã§ã«å†…è¨³ãŒã‚ã‚‹å ´åˆã¯æ¶ˆã—ã¦ã‹ã‚‰è¿½åŠ 
				    const oldDetail = document.getElementById('bill-detail');
				    if (oldDetail) oldDetail.remove();
				    
				    const detailDiv = document.createElement('div');
				    detailDiv.id = 'bill-detail';
				    detailDiv.innerHTML = detailHtml;
				    billElement.parentNode.appendChild(detailDiv);
				}

    </script>
</body>
</html>