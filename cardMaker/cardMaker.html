<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚³ãƒ³ã‚«ãƒ•ã‚§å¬¢ãƒãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ</title>
    <style>
        :root {
            --primary-color: #801e63;
            --bg-color: #fce4ec;
        }
        body { 
            padding: 10px; 
            margin: 0; 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            background-color: var(--bg-color); 
            text-align: center;
            color: #333;
        }
        h1 { color: var(--primary-color); font-size: 1.4rem; margin: 15px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        
        .upload-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        input[type="file"] { margin: 10px 0; width: 100%; font-size: 0.9rem; }

        /* Canvasã¯è¨ˆç®—ç”¨ãªã®ã§éš ã™ */
        #cardCanvas { display: none; }

        /* ã‚¹ãƒãƒ›ã§é•·æŠ¼ã—ä¿å­˜ã§ãã‚‹ãƒ¡ã‚¤ãƒ³ç”»åƒ */
        #outputImage {
            width: 100%;
            max-width: 350px;
            height: auto;
            margin: 10px auto;
            display: none; /* ç”Ÿæˆã•ã‚Œã‚‹ã¾ã§éš ã™ */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 4px solid white;
        }

        .hint-text {
            display: none;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 10px auto;
            max-width: 280px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        button {
            width: 90%;
            max-width: 300px;
            padding: 14px;
            margin: 15px auto;
            display: block;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 0 #5a1446;
            transition: 0.2s;
        }
        button:active { transform: translateY(2px); box-shadow: 0 2px 0 #5a1446; }

        .footer-text { font-size: 0.7rem; color: #888; margin-top: 20px; }
    </style>
</head>
<body>

<h1>âœ¨ ã‚³ãƒ³ã‚«ãƒ•ã‚§å¬¢ãƒãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ âœ¨</h1>

<div class="upload-container">
    <p style="font-size: 0.9rem; font-weight: bold; color: #801e63;">ç”»åƒã‚’é¸ã‚“ã§ã‚«ãƒ¼ãƒ‰ã‚’ç”ŸæˆğŸ’•</p>
    <input type="file" id="imageInput" accept="image/*" onchange="generateCard()">
</div>

<div id="saveHint" class="hint-text">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œ"å†™çœŸ"ã«ä¿å­˜ã€ã—ã¦ãƒğŸ“¸</div>

<img id="outputImage">

<canvas id="cardCanvas" width="300" height="1000"></canvas>

<button onclick="downloadCard()">ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ï¼ˆPCæ¨å¥¨ï¼‰</button>

<p class="footer-text">â€»ç”Ÿæˆã•ã‚ŒãŸç”»åƒã¯é•·æŠ¼ã—ã§ã‚¹ãƒãƒ›ã«ä¿å­˜ã§ãã¾ã™ã€‚</p>

<script>
const positiveAttributes = ["å…ƒæ°—","ç™’ã—","æ„›å¬Œ","é¢ç™½ã•","æ©Ÿè»¢","å¿ƒå°½ãã—","ã‚³ãƒŸãƒ¥åŠ›"];
const negativeAttributes = ["æ‚ªãƒãƒª","ä¸‹ãƒã‚¿","Pæ´»","åº—å¤–","ã‚°ãƒªä¸‹","ä¹é£Ÿ","é¬¼ç•œ","è‰²å–¶","ã‚ªãƒ©å–¶","ã‚¢ãƒ«ãƒãƒ©","é…’é›‘é­š","ãƒ›ã‚¹ç‹‚","å½¼æ°æŒã¡","é¢¨æ›ã‘æŒã¡"];

const listA = [
    "è™šé£¾ã®æœˆãŒç³ã«æ²ˆã‚€ã¨ã",
    "åƒå¹´ã®å­¤ç‹¬ã‚’ç´…ã„ãƒ‰ãƒ¬ã‚¹ã«çºã„",
    "ç†æ€§ã®é–ãŒéŸ³ã‚’ç«‹ã¦ã¦å´©ã‚Œå»ã‚‹",
    "éŠ€ã®é›¨ã«æ¿¡ã‚ŒãŸç¾½æ ¹ã‚’ä¼‘ã‚ã¦",
    "é­‚ã‚’åˆ‡ã‚Šåˆ»ã‚€ã‚ˆã†ãªæ—‹å¾‹ã®ä¸­ã§",
    "ç¦å¿Œã®æœå®Ÿã‚’ãã®å”‡ã§æ±šã—",
    "å¥ˆè½ã®åº•ã‹ã‚‰é€™ã„å¯„ã‚‹å½±ã®ã‚ˆã†ã«",
    "æ·±ç´…ã®è¨˜æ†¶ãŒè¡€ç®¡ã‚’é§†ã‘å·¡ã‚Š",
    "é¡ã®ä¸­ã«é–‰ã˜è¾¼ã‚ãŸçœŸå®Ÿã¨å…±ã«",
    "ç¥ˆã‚Šã•ãˆå±Šã‹ã¬æš—é»’ã®è–åŸŸã§"
];

const listB = [
    "ç”˜ç¾ãªæ¯’ã‚’æ³¨ãè¾¼ã¿ç¶šã‘ã¦ã„ã‚‹",
    "çµ‚ã‚ã‚‰ãªã„è¼ªå»»ã®èºæ—‹ã‚’è¸Šã‚‹",
    "çµ¶æœ›ã¨ã„ã†åã®æ•‘æ¸ˆã‚’å¾…ã£ã¦ã„ã‚‹",
    "é‹å‘½ã®æ­¯è»Šã‚’ç‹‚ã‚ã›ã‚ˆã†ã¨ã—ã¦ã„ã‚‹",
    "å†·ãˆåˆ‡ã£ãŸå¿ƒè‡“ã‚’é™ã‹ã«ç„¦ãŒã™",
    "åå‰ã®ãªã„æ‚ªå¤¢ã‚’é£¼ã„æ…£ã‚‰ã—ã¦ã„ã‚‹",
    "ç¡å­ã®æª»ã®ä¸­ã§ç¾½æ’ƒãã‚’å¿˜ã‚ŒãŸ",
    "èƒŒå¾³ã®é¦™ã‚Šã«ãã®èº«ã‚’å§”ã­ã¦ã„ã‚‹",
    "å¤±ã‚ã‚ŒãŸç¥è¨—ã‚’ã²ã¨ã‚Šå‘Ÿã„ã¦ã„ã‚‹",
    "æ®‹é…·ãªã¾ã§ã«ç¾ã—ã„å˜˜ã‚’ç´¡ã"
];

const listC = [
    "ã•ã‚ã€ç§ã¨å…±ã«å •ã¡ã‚‹ã¨ã“ã‚ã¾ã§å •ã¡ã‚ˆã†ã€‚",
    "ã“ã®å¤œãŒæ˜ã‘ã‚‹ã¨ãã€è²´æ–¹ã¯ç§ã®ä¸€éƒ¨ã¨ãªã‚‹ã€‚",
    "æ°¸é ã¨ã„ã†åã®å‘ªã„ã‚’å—ã‘ã¦ã‚‚æ§‹ã‚ãªã„ã€‚",
    "æ„›ãªã©ã¨ã„ã†æˆ¯è¨€ã€ã“ã®é—‡ã§æ»ãæ¶ˆã—ã¦ã‚ã’ã‚‹ã€‚",
    "è²´æ–¹ã®çµ¶æœ›ãŒã€ç§ã®æœ€é«˜ã®ç³§ã«ãªã‚‹ã‚ã€‚",
    "å†ä¼šã®ç´„æŸã¯ã€åœ°ç„ã®é–€ã§äº¤ã‚ã—ã¾ã—ã‚‡ã†ã€‚",
    "æœˆãŒæœ½ã¡æœã¦ã‚‹ã¾ã§ã€ç§ã‚’è¦‹ã¤ã‚ã¦ã„ã¦ã€‚",
    "æ¬¡ã«ç›®è¦šã‚ã‚‹æ™‚ã€ãã“ã¯ã‚‚ã†ç•°ç•Œã®å…¥ã‚Šå£ã‚ˆã€‚",
    "éœ‡ãˆã‚‹æŒ‡å…ˆã§ã€ç§ã®æ·±æ·µã«è§¦ã‚Œã¦ã”ã‚‰ã‚“ãªã•ã„ã€‚",
    "å‡ºå£ã®ãªã„è¿·å®®ã§ã€æ°¸é ã«å½·å¾¨ã„ç¶šã‘ã‚‹ãŒã„ã„ã‚ã€‚"
];

async function hashImage(file) {
    const buffer = await file.arrayBuffer();
    const hash = await crypto.subtle.digest("SHA-256", buffer);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
}

function seededRandom(seed) {
    let h = 0;
    for (let i = 0; i < seed.length; i++) { h = Math.imul(31, h) + seed.charCodeAt(i) | 0; }
    return () => { h = Math.imul(48271, h) % 0x7fffffff; return (h & 0xfffffff) / 0x10000000; };
}

function randomStatsFromSeed(seed) {
    const rand = seededRandom(seed);
    return { beauty: Math.floor(rand() * 101), intelligence: Math.floor(rand() * 101), stamina: Math.floor(rand() * 101), guts: Math.floor(rand() * 101), mental: Math.floor(rand() * 101) };
}

function randomAttributesFromSeed(seed) {
    const rand = seededRandom(seed);
    const pos = [...positiveAttributes].sort(() => rand() - 0.5).slice(0, 2);
    const neg = [...negativeAttributes].sort(() => rand() - 0.5).slice(0, 1);
    return [...pos, ...neg];
}

function randomCaptionFromSeed(seed) {
    const rand = seededRandom(seed);
    const pick = arr => arr[Math.floor(rand() * arr.length)];
    return pick(listA) + "ã€" + pick(listB) + "ã€‚" + pick(listC);
}

function calcRarity(stats) {
    const values = Object.values(stats);
    const total = values.reduce((a, b) => a + b, 0);
    const minVal = Math.min(...values);
    if (total >= 420 && minVal >= 64) return "UR";
    if (total >= 400 && minVal >= 55) return "SSR";
    if (total >= 350 && minVal >= 40) return "SR";
    if (total >= 300) return "R";
    return "N";
}

const rarityColor = { "UR": "#4fc", "SSR": "#d3e", "SR": "#ca2", "R": "#e82", "N": "#27f" };

async function generateCard() {
    const file = document.getElementById("imageInput").files[0];
    if (!file) return;

    const seed = await hashImage(file);
    const stats = randomStatsFromSeed(seed);
    const attrs = randomAttributesFromSeed(seed);
    const caption = randomCaptionFromSeed(seed);

    const reader = new FileReader();
    reader.onload = e => {
        const img = new Image();
        img.onload = () => drawCard(img, stats, attrs, caption);
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function drawCard(userImage, stats, attrs, caption) {
    const canvas = document.getElementById("cardCanvas");
    const ctx = canvas.getContext("2d");
    const rarity = calcRarity(stats);

    const frameImg = new Image();
    frameImg.crossOrigin = "anonymous";
    frameImg.src = rarity.toLowerCase() + ".png"; 

    frameImg.onload = () => {
        ctx.fillStyle = "#404060";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const targetW = 260, targetH = 460;
        const x = 20, y = 70;
        const ratio = Math.max(targetW / userImage.width, targetH / userImage.height);
        const w = userImage.width * ratio;
        const h = userImage.height * ratio;
        const cropX = (w - targetW) / 2;
        const cropY = (h - targetH) / 2;

        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = targetW;
        tempCanvas.height = targetH;
        const tempCtx = tempCanvas.getContext("2d");
        tempCtx.drawImage(userImage, -cropX, -cropY, w, h);

        ctx.drawImage(tempCanvas, x, y);
        ctx.drawImage(frameImg, 0, 0, 300, 600);
        drawStatusAndText(ctx, stats, attrs, rarity, caption, 610);

        // ã€ä¿®æ­£ã€‘Canvasã‚’imgã«å¤‰æ›ã—ã¦è¡¨ç¤º
        const outputImage = document.getElementById("outputImage");
        outputImage.src = canvas.toDataURL("image/png");
        outputImage.style.display = "block";
        document.getElementById("saveHint").style.display = "block";
    };
}

function drawStatusAndText(ctx, stats, attrs, rarity, caption, offsetY) {
    ctx.font = "bold 20px sans-serif";
    ctx.fillStyle = rarityColor[rarity];
    ctx.fillText(rarity, 230, offsetY + 20);

    ctx.fillStyle = "#fff";
    ctx.font = "bold 18px sans-serif";
    ctx.fillText("ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€‘", 20, offsetY + 20);

    const drawBar = (label, value, y) => {
        ctx.fillStyle = "#fff"; ctx.font = "14px sans-serif";
        ctx.fillText(`${label}: ${value}`, 20, y);
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.fillRect(100, y - 10, 150, 8);
        ctx.fillStyle = "#f20";
        ctx.fillRect(100, y - 10, (value / 100) * 150, 8);
    };

    drawBar("å®¹å§¿", stats.beauty, offsetY + 45);
    drawBar("çŸ¥åŠ›", stats.intelligence, offsetY + 70);
    drawBar("ä½“åŠ›", stats.stamina, offsetY + 95);
    drawBar("æ ¹æ€§", stats.guts, offsetY + 120);
    drawBar("ç²¾ç¥åŠ›", stats.mental, offsetY + 145);

    ctx.fillStyle = "#fff"; ctx.font = "bold 18px sans-serif";
    ctx.fillText("ã€ç‰¹æ€§ã€‘", 20, offsetY + 185);

    let ax = 20, ay = offsetY + 210;
    attrs.forEach(attr => {
        ctx.fillStyle = positiveAttributes.includes(attr) ? "#ff80ab" : "#80d8ff";
        ctx.font = "bold 16px sans-serif";
        ctx.fillText(attr, ax, ay);
        ax += ctx.measureText(attr).width + 15;
    });

    ctx.font = "italic 14px sans-serif"; ctx.fillStyle = "#ddd";
    const lines = caption.match(/.{1,18}/g) || [];
    let cy = ay + 35;
    lines.forEach(line => { ctx.fillText(line, 20, cy); cy += 18; });
}

function downloadCard() {
    const canvas = document.getElementById("cardCanvas");
    const link = document.createElement("a");
    link.download = "battle_card.png";
    link.href = canvas.toDataURL();
    link.click();
}
</script>
</body>
</html>