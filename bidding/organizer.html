<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主催者管理 - オークションシステム</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f9; color: #333; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: #1a73e8; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #qr-section { display: none; text-align: center; background: #eef; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px dashed #1a73e8; }
        #item-form-section { display: none; border-top: 2px solid #eee; padding-top: 20px; }
        hr { border: 0; border-top: 1px solid #eee; margin: 30px 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>主催者コントロールパネル</h1>
    
    <button id="setup-btn" class="btn" onclick="setupAuction()" style="background:#34a853;">① 会場を作成・開始する</button>
		<div id="recovery-section" style="margin-top: 10px; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
		    <label style="font-size: 0.8rem;">既存の会場IDで復帰する:</label>
		    <input type="text" id="recovery-id" placeholder="例: ABCD1234" style="width: 120px; padding: 5px;">
		    <button onclick="recoverAuction()" style="padding: 5px 10px; cursor: pointer;">復帰</button>
		</div>


    <div id="qr-section">
        <p>会場ID: <strong id="display-id" style="font-size: 1.2rem; color: #1a73e8;"></strong></p>
        <img id="qr-code" src="" alt="QR Code" style="width:150px;"><br>
        <a id="join-link" href="" target="_blank" style="color: #1a73e8; text-decoration: none; font-weight: bold;">参加用ページを別タブで開く</a>
    </div>

    <div id="item-form-section">
        <h2>② 商品を出品する</h2>
        
        <div class="form-group">
            <label>商品名</label>
            <input type="text" id="item-title" placeholder="商品名を入力">
        </div>

        <div class="form-group">
            <label>商品画像 (最大3枚)</label>
            <div style="display: flex; gap: 10px; flex-direction: column;">
                <div>
                    <input type="file" class="item-image-input" accept="image/*" onchange="previewIndividual(this, 0)">
                    <img class="img-mini-preview" style="width:50px; height:50px; display:none; margin-top:5px; border-radius:4px; object-fit:cover;">
                </div>
                <div>
                    <input type="file" class="item-image-input" accept="image/*" onchange="previewIndividual(this, 1)">
                    <img class="img-mini-preview" style="width:50px; height:50px; display:none; margin-top:5px; border-radius:4px; object-fit:cover;">
                </div>
                <div>
                    <input type="file" class="item-image-input" accept="image/*" onchange="previewIndividual(this, 2)">
                    <img class="img-mini-preview" style="width:50px; height:50px; display:none; margin-top:5px; border-radius:4px; object-fit:cover;">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>初期価格 (¥)</label>
            <input type="number" id="item-price" value="1000">
        </div>

        <div class="form-group">
            <label>オークション形式</label>
            <select id="auction-type">
                <option value="normal">通常入札 (競り合い・価格公開)</option>
                <option value="blind">密封入札 (一発勝負・価格非公開)</option>
            </select>
        </div>

        <div class="form-group">
            <label id="duration-label">終了までの時間 (分)</label>
            <input type="number" id="item-duration" value="60">
        </div>

        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="auto-extend" style="width: auto;" checked>
            <label for="auto-extend" id="auto-extend-label" style="margin: 0;">終了5分前の入札で5分自動延長</label>
        </div>

        <button id="submit-btn" class="btn" onclick="submitItem()">この内容で出品する</button>
    </div>

    <hr>

    <div id="status-section">
        <h2>会場ステータス</h2>
        <p>現在の参加者: <strong id="participant-count">0</strong> 名</p>
        <div id="participant-list" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.85rem; color: #666; margin-bottom: 20px;">
            参加者を待機中...
        </div>

        <h2>出品物のリアルタイム状況</h2>
        <div id="admin-items-list"></div>
    </div>
</div>

<script>
    // --- Firebase設定 ---
    const firebaseConfig = {
        apiKey: "AIzaSyAv_eQX0TeXEWWY6DlWt_8cbKVSsL8T2m4",
        authDomain: "bidding-75c1f.firebaseapp.com",
        projectId: "bidding-75c1f",
        storageBucket: "bidding-75c1f.firebasestorage.app",
        messagingSenderId: "790924245144",
        appId: "1:790924245144:web:c69ba31b34b53e8e2a78ed"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let ROOM_ID = "";
    let adminItemsCache = [];

    // --- UI連動処理 ---
    const typeSelect = document.getElementById('auction-type');
    const autoExtendCheck = document.getElementById('auto-extend');
    const autoExtendLabel = document.getElementById('auto-extend-label');

    // 形式変更時の自動延長制御
    typeSelect.addEventListener('change', function() {
        if (this.value === 'blind') {
            autoExtendCheck.checked = false;
            autoExtendCheck.disabled = true;
            autoExtendLabel.style.color = '#ccc';
        } else {
            autoExtendCheck.disabled = false;
            autoExtendLabel.style.color = '#333';
            autoExtendCheck.checked = true;
        }
    });

    // --- メインロジック ---

    async function setupAuction() {
        ROOM_ID = Math.random().toString(36).substring(2, 10).toUpperCase();
        const joinUrl = window.location.href.replace('organizer.html', 'participant.html') + '?id=' + ROOM_ID;

        await db.collection("auctions").doc(ROOM_ID).set({ 
            status: "active", 
            createdAt: firebase.firestore.FieldValue.serverTimestamp() 
        });

        document.getElementById('display-id').innerText = ROOM_ID;
        document.getElementById('qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(joinUrl)}`;
        document.getElementById('join-link').href = joinUrl;
        
        document.getElementById('qr-section').style.display = 'block';
        document.getElementById('item-form-section').style.display = 'block';
        document.getElementById('setup-btn').style.display = 'none';

        startAdminMonitoring();
    }

		async function recoverAuction() {
		    const id = document.getElementById('recovery-id').value.trim().toUpperCase();
		    if (!id) return alert("会場IDを入力してください");

		    // その会場がFirestoreに存在するか確認
		    const doc = await db.collection("auctions").doc(id).get();
		    if (doc.exists) {
		        ROOM_ID = id;
		        const joinUrl = window.location.href.replace('organizer.html', 'participant.html') + '?id=' + ROOM_ID;

		        document.getElementById('display-id').innerText = ROOM_ID;
		        document.getElementById('qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(joinUrl)}`;
		        document.getElementById('join-link').href = joinUrl;
		        
		        document.getElementById('qr-section').style.display = 'block';
		        document.getElementById('item-form-section').style.display = 'block';
		        document.getElementById('setup-btn').style.display = 'none';
		        document.getElementById('recovery-section').style.display = 'none';

		        startAdminMonitoring(); // 監視を再開
		        alert("会場ID: " + ROOM_ID + " に復帰しました");
		    } else {
		        alert("指定された会場IDは見つかりませんでした");
		    }
		}

    async function submitItem() {
        const title = document.getElementById('item-title').value;
        const startPrice = parseInt(document.getElementById('item-price').value);
        const durationMin = parseInt(document.getElementById('item-duration').value);
        const auctionType = typeSelect.value;
        const autoExtend = autoExtendCheck.checked;
        
        // 【重要】クラスですべての入力欄を取得
        const imageInputs = document.querySelectorAll('.item-image-input');

        if (!title || isNaN(startPrice) || isNaN(durationMin)) {
            return alert("入力項目を確認してください");
        }

        const btn = document.getElementById('submit-btn');
        const originalText = btn.innerText;
        btn.disabled = true;

        try {
            let imageUrls = [];
            const apiKey = "7577d6c8b0e0168ad78366962496db5a";

            // 3つの入力欄をループして画像があればアップロード
            for (let i = 0; i < imageInputs.length; i++) {
                const file = imageInputs[i].files[0];
                if (file) {
                    btn.innerText = `画像${i + 1}枚目を送信中...`;
                    const formData = new FormData();
                    formData.append("image", file);

                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                        method: "POST",
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        imageUrls.push(result.data.url);
                    }
                }
            }

            // 1枚も選ばれていなければ noimage.png
            if (imageUrls.length === 0) {
                imageUrls.push("noimage.png");
            }

            const now = new Date();
            const endTimeDate = new Date(now.getTime() + durationMin * 60000);

            btn.innerText = "データを保存中...";
            await db.collection("auctions").doc(ROOM_ID).collection("items").add({
                title: title,
                startPrice: startPrice,
                currentPrice: startPrice,
                maxBid: startPrice,
                highestBidder: "なし",
                auctionType: auctionType,
                autoExtend: autoExtend,
                imageUrls: imageUrls, 
                endTime: firebase.firestore.Timestamp.fromDate(endTimeDate),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert("出品が完了しました！");
            
            // フォームリセット
            document.getElementById('item-title').value = "";
            imageInputs.forEach(input => input.value = "");
            document.querySelectorAll('.img-mini-preview').forEach(img => img.style.display = 'none');

        } catch (e) {
            console.error(e);
            alert("エラー: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    async function deleteItem(itemId, title) {
        if (!confirm(`「${title}」を削除してもよろしいですか？`)) return;
        try {
            await db.collection("auctions").doc(ROOM_ID).collection("items").doc(itemId).delete();
            alert("削除しました");
        } catch (e) {
            alert("削除エラー: " + e.message);
        }
    }

    function previewIndividual(input, index) {
        const previews = document.querySelectorAll('.img-mini-preview');
        const file = input.files[0];
        if (file && previews[index]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previews[index].src = e.target.result;
                previews[index].style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    function startAdminMonitoring() {
        db.collection("auctions").doc(ROOM_ID).collection("participants")
          .onSnapshot(snapshot => {
              const listEl = document.getElementById('participant-list');
              const countEl = document.getElementById('participant-count');
              const names = [];
              snapshot.forEach(doc => names.push(doc.id));
              countEl.innerText = names.length;
              listEl.innerText = names.length > 0 ? names.join(', ') : "まだ誰もいません";
          });

        db.collection("auctions").doc(ROOM_ID).collection("items")
          .orderBy("createdAt", "asc")
          .onSnapshot(snapshot => {
              adminItemsCache = [];
              snapshot.forEach(doc => adminItemsCache.push({ id: doc.id, ...doc.data() }));
              renderAdminList();
          });

        setInterval(() => {
            if (adminItemsCache.length > 0) renderAdminList();
        }, 1000);
    }

    function renderAdminList() {
        const listEl = document.getElementById('admin-items-list');
        if (!listEl) return;
        listEl.innerHTML = '';
        const now = new Date();

        adminItemsCache.forEach(data => {
            const itemCard = document.createElement('div');
            const endTimeDate = data.endTime?.toDate ? data.endTime.toDate() : new Date();
            const isEnded = endTimeDate <= now;
            const timeStr = endTimeDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const isBlind = data.auctionType === 'blind';
            const priceVal = isBlind ? (data.maxBid || data.startPrice) : data.currentPrice;

            itemCard.style = `
                background: ${isEnded ? '#f8f9fa' : 'white'};
                border: 2px solid ${isEnded ? '#ccc' : '#1a73e8'};
                padding: 15px; margin-bottom: 12px; border-radius: 8px;
                display: flex; gap: 15px; align-items: center;
            `;

            const imgUrl = (data.imageUrls && data.imageUrls.length > 0) ? data.imageUrls[0] : "noimage.png";
            
            itemCard.innerHTML = `
                <img src="${imgUrl}" style="width:60px; height:60px; object-fit:cover; border-radius:4px; background:#eee;">
                <div style="flex: 1;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <strong>${data.title}</strong>
                        <span style="background:${isEnded ? '#666' : '#34a853'}; color:white; font-size:0.7rem; padding:2px 6px; border-radius:10px;">
                            ${isEnded ? '終了' : '進行中'}
                        </span>
                    </div>
                    <div style="font-size: 0.85rem; color: #555;">落札候補: ${data.highestBidder}</div>
                    <div style="font-size: 0.8rem; color: ${isEnded ? '#999' : '#d93025'};">
                        ${isEnded ? '終了時刻' : '終了予定'}: ${timeStr}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.1rem; font-weight: bold; color: #e67e22;">¥${priceVal.toLocaleString()}</div>
                    <button onclick="deleteItem('${data.id}', '${data.title}')" 
                        style="margin-top: 10px; padding: 4px 8px; background: #ff4d4d; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                        削除
                    </button>
                </div>
            `;
            listEl.appendChild(itemCard);
        });
    }
</script>
</body>
</html>