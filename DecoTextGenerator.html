<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Combining Decorator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; background: #111; color: #ddd; font-family: 'Noto Sans', 'Segoe UI Symbol', 'Noto Sans Symbols', sans-serif; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 16px; }
    .row.grid { grid-template-columns: 1fr 1fr; }
    textarea, input, select, button {
      background: #1a1a1a; color: #eee; border: 1px solid #444; padding: 8px; border-radius: 6px;
    }
    textarea { min-height: 110px; resize: vertical; }
    .preview { white-space: pre-wrap; border: 1px dashed #444; padding: 10px; border-radius: 6px; word-break: break-word; }
    .hint { font-size: 12px; color: #aaa; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
    .toolbar > * { flex: 1 1 160px; }
    .status { font-size: 12px; color: #9aa; margin-top: 8px; }
    .small { font-size: 12px; }
    .inline { display: inline-block; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Abuse Mitigation Generator</h1>
  <div class="row">
      入力文字列
      <textarea id="input" placeholder="ここにテキストを入力してください。"></textarea>
    <div class="hint">暴言や強い言葉に半モザイクを掛けたり、濁音半濁音を付けて柔らかにします。</div>
  </div>

  <div class="toolbar">
    <label class="inline">プリセット
      <select id="preset">
        <option value="none">なし（素の文字）</option>
        <option value="mold">半モザイク</option>
        <option value="semi_letter" selected>濁点、半濁点</option>
        <option value="all">混合</option>
      </select>
    </label>
    <label class="inline">濃さ
      <select id="density">
        <option value="1" selected>1</option>
        <option value="2">2</option>
        <option value="4">4</option>
      </select>
    </label>
    <label class="inline">正規化
      <select id="norm">
        <option value="NFC">NFC</option>
        <option value="NFD" selected>NFD</option>
        <option value="NFKC">NFKC</option>
        <option value="NFKD">NFKD</option>
      </select>
    </label>
  </div>

  <div class="row">
    <label>
      出力
      <textarea id="output" readonly style="display: none;"></textarea>
    </label>
    <div id="preview" class="preview"></div>
  <div class="row grid">
    <button id="copy">出力をコピー</button>
  </div>
  <div class="row grid">
    <button id="apply">やり直し</button>
  </div>
    <div id="status" class="status">Ready</div>

  </div>
</div>

<script>
  const ZERO_WIDTH = new Set(["\u200B","\u200C","\u200D","\u2060","\uFEFF"]);

  // 日本語対応結合文字セット
	const MOLD=["\u0488","\u0489"];
	const SEMI_LETTER=["\u3099","\u309A"]
  const SAFE_JAPANESE = ["\u0488","\u0489","\u3099","\u309A"]; // ҈ ҉ ゙ ゚

  const inputEl = document.getElementById('input');
  const outputEl = document.getElementById('output');
  const previewEl = document.getElementById('preview');
  const statusEl = document.getElementById('status');
  const presetEl = document.getElementById('preset');
  const normEl = document.getElementById('norm');
  const densityEl = document.getElementById('density');
  const applyBtn = document.getElementById('apply');
  const copyBtn = document.getElementById('copy');

  function normalize(str) {
    try { return str.normalize(normEl.value); } catch { return str; }
  }

  function sanitizeBase(ch) {
    const cp = ch.codePointAt(0);
    if ((cp <= 0x1F && ch !== "\n" && ch !== "\t") || (cp >= 0x7F && cp <= 0x9F)) return "";
    if (ZERO_WIDTH.has(ch)) return "";
    return ch;
  }

  function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }


	function decorateChar(ch, mode, dens) {
	  const base = sanitizeBase(ch);
	  if (!base) return "";

	  let marks = [];

	  switch (mode) {
	    case "none":
	      return base;

	    case "mold":
	      for (let i = 0; i < dens; i++) marks.push(pick(MOLD));
	      break;

	    case "semi_letter":
	      // 濁点・半濁点は最大1個
	      marks.push(pick(SEMI_LETTER));
	      break;

	    case "all":
	      let usedDakuten = false;
	      for (let i = 0; i < dens + 1; i++) {
	        const m = pick(SAFE_JAPANESE);
	        if ((m === "\u3099" || m === "\u309A") && usedDakuten) continue;
	        if (m === "\u3099" || m === "\u309A") usedDakuten = true;
	        marks.push(m);
	      }
	      break;

	    default:
	      return base;
	  }

	  return base + marks.join("");
	}


  function decorateText(text) {
    const normalized = normalize(text);
    let out = "";
    for (const ch of normalized) {
      if (ch === "\n") { out += "\n"; continue; }
      out += decorateChar(ch, presetEl.value, Number(densityEl.value));
    }
    return out;
  }

  function render() {
    const src = inputEl.value || "";
    const decorated = decorateText(src);
    outputEl.value = decorated;
    previewEl.textContent = decorated;
    statusEl.textContent = `norm=${normEl.value} preset=${presetEl.value} density=${densityEl.value}`;
  }

  applyBtn.onclick = render;
  inputEl.addEventListener('input', render);
  presetEl.addEventListener('change', render);
  normEl.addEventListener('change', render);
  densityEl.addEventListener('change', render);

  copyBtn.onclick = async () => {
    try {
      await navigator.clipboard.writeText(outputEl.value);
      statusEl.textContent = "コピー完了";
    } catch {
      statusEl.textContent = "コピー失敗（許可が必要な場合があります）";
    }
  };

  render();
</script>
</body>
</html>