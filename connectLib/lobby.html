<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Online Lobby</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: #eee; margin: 0; padding: 20px; }
        .box { background: #2a2a2a; border-radius: 12px; padding: 20px; margin: 10px auto; max-width: 400px; border: 1px solid #444; }
        #status { color: #ffd11a; font-weight: bold; }
        .btn { padding: 15px; font-size: 16px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 80%; transition: 0.2s; }
        .host-btn { background: #e63946; color: white; }
        .guest-btn { background: #457b9d; color: white; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        #qrcode { background: white; padding: 15px; display: inline-block; margin: 15px auto; border-radius: 8px; }
        video { width: 100%; max-width: 300px; border-radius: 8px; border: 2px solid #555; display: none; }
        #game-frame { display: none; width: 100%; height: 90vh; border: none; border-radius: 12px; background: #fff; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="lobby-ui">
        <h2>P2P Online Lobby</h2>
        <div class="box">Status: <span id="status">Ready</span></div>

        <div id="setup-ui">
            <button class="btn host-btn" onclick="initP2P(true)">1. ホストとして部屋を作る</button>
            <button class="btn guest-btn" onclick="initP2P(false)">2. ゲストとして参加する</button>
        </div>

        <div id="host-ui" style="display:none;">
            <p>ゲストにこのQRを読ませてください</p>
            <div id="qrcode"></div>
            <p id="room-id-display" style="font-size: 24px; font-weight: bold; letter-spacing: 4px;"></p>
        </div>

        <div id="guest-ui" style="display:none;">
            <p>ホストのQRをスキャンしてください</p>
            <video id="video" playsinline></video>
            <canvas id="qr-canvas" style="display:none;"></canvas>
            <div id="manual-entry">
                <p>またはIDを手入力：</p>
                <input type="text" id="manual-id" style="padding: 10px; border-radius: 4px; border: none; width: 100px; text-align: center;">
                <button class="btn guest-btn" style="width: auto; padding: 10px;" onclick="handleManualInput()">接続</button>
            </div>
        </div>
    </div>

    <iframe id="game-frame"></iframe>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- あなたのFirebase Configをここに貼り付け ---
				// For Firebase JS SDK v7.20.0 and later, measurementId is optional
				const firebaseConfig = {
				  apiKey: "AIzaSyBghe53eweW5j3zPe55skV8YXFMPpRwdjc",
				  authDomain: "connectp2p-1ba54.firebaseapp.com",
				  databaseURL: "https://connectp2p-1ba54-default-rtdb.firebaseio.com",
				  projectId: "connectp2p-1ba54",
				  storageBucket: "connectp2p-1ba54.firebasestorage.app",
				  messagingSenderId: "34700692828",
				  appId: "1:34700692828:web:b20ce75b17862e849f4599",
				  measurementId: "G-DZ6TVZBKBG"
				};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let pc, dataChannel, isHost, roomRef;
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        const gameFrame = document.getElementById('game-frame');

        // --- 初期化 ---
        window.initP2P = async (hostMode) => {
            isHost = hostMode;
            document.getElementById('setup-ui').style.display = 'none';
            pc = new RTCPeerConnection(config);

            if (isHost) {
                startHost();
            } else {
                startGuest();
            }
        };

        // --- ホストロジック ---
        async function startHost() {
            document.getElementById('host-ui').style.display = 'block';
            const roomId = Math.floor(10000 + Math.random() * 90000).toString();
            document.getElementById('room-id-display').innerText = roomId;
            roomRef = ref(db, 'rooms/' + roomId);

            // 非常に粗くて読みやすいQRを生成
            new QRCode(document.getElementById("qrcode"), {
                text: roomId,
                width: 180, height: 180,
                correctLevel: QRCode.CorrectLevel.L
            });

            dataChannel = pc.createDataChannel("gameChannel");
            setupDataEvents();

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            pc.onicecandidate = e => {
                if (!e.candidate) {
                    set(roomRef, { offer: { type: pc.localDescription.type, sdp: pc.localDescription.sdp } });
                    document.getElementById('status').innerText = "ゲスト待機中...";
                }
            };

            // Answerを監視
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.answer && !pc.remoteDescription) {
                    pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });
        }

        // --- ゲストロジック ---
        function startGuest() {
            document.getElementById('guest-ui').style.display = 'block';
            pc.ondatachannel = e => { dataChannel = e.channel; setupDataEvents(); };
            startScan();
        }

        async function connectByRoomId(id) {
            stopScan();
            document.getElementById('guest-ui').style.display = 'none';
            document.getElementById('status').innerText = `部屋 ${id} に接続中...`;
            roomRef = ref(db, 'rooms/' + id);

            onValue(roomRef, async (snapshot) => {
                const data = snapshot.val();
                if (data && data.offer && !pc.remoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    pc.onicecandidate = e => {
                        if (!e.candidate) {
                            update(roomRef, { answer: { type: pc.localDescription.type, sdp: pc.localDescription.sdp } });
                        }
                    };
                }
            });
        }

        // --- 共通：データ通信設定 ---
        function setupDataEvents() {
            dataChannel.onopen = () => {
                document.getElementById('status').innerText = "CONNECTED!";
                remove(roomRef); // 掃除
                setTimeout(() => {
                    document.getElementById('lobby-ui').style.display = "none";
                    gameFrame.src = "hitnblow.html?role=" + (isHost ? "host" : "guest");
                    gameFrame.style.display = "block";
                }, 800);
            };
            dataChannel.onmessage = e => {
                gameFrame.contentWindow.postMessage(JSON.parse(e.data), "*");
            };
        }

        window.addEventListener("message", (e) => {
            if (dataChannel && dataChannel.readyState === "open") {
                dataChannel.send(JSON.stringify(e.data));
            }
        });

        // --- ゲスト用：QRスキャンロジック ---
        const video = document.getElementById("video");
        const canvas = document.getElementById("qr-canvas");
        const ctx = canvas.getContext("2d");
        let scanReq;

        async function startScan() {
            video.style.display = 'inline-block';
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            video.play();
            scanReq = requestAnimationFrame(tick);
        }

        function stopScan() {
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            cancelAnimationFrame(scanReq);
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight; canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) { connectByRoomId(code.data); return; }
            }
            scanReq = requestAnimationFrame(tick);
        }

        window.handleManualInput = () => {
            const id = document.getElementById('manual-id').value;
            if (id) connectByRoomId(id);
        };
    </script>
</body>
</html>