<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle - ALL-100 Survival</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0b0e14; --card-bg: #16213e; --accent: #e94560; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; padding: 0; }
        .header { background: #1a1a2e; padding: 10px; border-bottom: 2px solid var(--accent); }
        .arena { display: flex; flex-direction: column; gap: 10px; padding: 10px; max-width: 500px; margin: 0 auto; }
        
				.card {
				    position: relative;
				    width: 200px;
				    height: 280px;
				    background: #1a1a1a;
				    border: 3px solid #444;
				    border-radius: 15px;
				    color: white;
				}

				.card-rank { position: absolute; top: 10px; left: 10px; font-weight: bold; color: gold; font-size: 1.2rem; }
				.card-icon { position: absolute; top: 35px; left: 50%; transform: translateX(-50%); font-size: 4rem; }
				.card-name { position: absolute; top: 10px; right: 10px; font-size: 0.9rem; color: #ddd; }
				        .rank-SSR { border-color: #ff00ff; animation: rainbow 2s linear infinite; }
				        @keyframes rainbow { 0%{border-color:#ff00ff} 33%{border-color:#00ffff} 66%{border-color:#ffff00} 100%{border-color:#ff00ff} }

        .rank-badge { position: absolute; top: -10px; right: -10px; padding: 2px 10px; border-radius: 6px; font-weight: bold; border: 2px solid #fff; z-index: 10; }
        .badge-N { background: #a0522d; } .badge-R { background: #c0c0c0; color: #000; } .badge-SR { background: #ffd700; color: #000; } .badge-SSR { background: linear-gradient(45deg, #ff00ff, #00ffff); }

        .hp-bar { background: #444; height: 16px; border-radius: 8px; margin: 8px 0; overflow: hidden; position: relative; }
        .hp-fill { background: #00ff44; height: 100%; transition: width 0.3s; }
        .hp-text { position: absolute; width: 100%; text-align: center; font-size: 0.8rem; line-height: 16px; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        
        .info-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 150px; margin-top: 10px; }
        .log-area { background: #16213e88; overflow-y: auto; padding: 8px; border-radius: 10px; font-size: 0.75rem; text-align: left; border: 1px solid #333; }
        
        #tap-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 100; cursor: pointer; align-items: center; justify-content: center; }
        #tap-msg { background: var(--accent); padding: 20px 40px; border-radius: 40px; font-weight: bold; box-shadow: 0 0 20px rgba(233,69,96,0.5); }
        #result-screen { display: none; padding: 40px 20px; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }

				/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡Œã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
				.stat-row {
				    padding: 0 15px;
				    margin-bottom: 6px;
				}

				.stat-label-container {
				    display: flex;
				    justify-content: space-between;
				    font-size: 0.65rem;
				    margin-bottom: 2px;
				    font-weight: bold;
				}

				.stat-label { color: #aaa; }
				.stat-value { color: #fff; }

				/* ãƒãƒ¼ã®å…±é€šè¨­å®š */
				.bar-bg {
				    height: 6px;
				    background: rgba(255,255,255,0.1);
				    border-radius: 3px;
				    overflow: hidden;
				}

				.stat-bar-fill {
				    height: 100%;
				    border-radius: 3px;
				    transition: width 0.3s ease;
				}

				/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã”ã¨ã®è‰² */
				.hp-bar-fill { height: 100%; background: linear-gradient(90deg, #ff4d4d, #ff944d); transition: width 0.3s ease; }
				.atk-color { background: #ff4757; } /* èµ¤ï¼šæ”»æ’ƒ */
				.def-color { background: #1e90ff; border: 1px solid #70a1ff; } /* é’ï¼šé˜²å¾¡ï¼ˆæ˜ã‚‹ã„ãƒ‰ã‚¸ãƒ£ãƒ¼ãƒ–ãƒ«ãƒ¼ï¼‰ */
				.spd-color { background: #2ed573; } /* ç·‘ï¼šç´ æ—©ã•ï¼ˆé®®ã‚„ã‹ãªã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚°ãƒªãƒ¼ãƒ³ï¼‰ */

				/* ã‚«ãƒ¼ãƒ‰å†…ã®çµ¶å¯¾é…ç½®ãƒ‘ãƒ¼ãƒ„ */
				.card-rank { position: absolute; top: 12px; left: 15px; font-size: 1.4rem; font-weight: 900; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
				.card-name { position: absolute; top: 15px; right: 15px; font-size: 0.8rem; color: rgba(255,255,255,0.8); font-weight: bold; }
				.card-icon { position: absolute; top: 35px; left: 50%; transform: translateX(-50%); font-size: 4.5rem; filter: drop-shadow(0 0 10px rgba(0,0,0,0.3)); }

    </style>
</head>
<body>

    <div id="tap-overlay" onclick="resolveTap()"><div id="tap-msg">Next</div></div>

    <div id="game-ui">
        <div class="header"><b>ALL-100 Survival</b></div>
        <div class="arena">
            <div id="enemy-view"></div>
            <div id="battle-msg" style="height:60px; font-size:1.1rem; color:#f9d423; font-weight:bold; display:flex; align-items:center; justify-content:center;">å¯¾æˆ¦ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
            <div id="player-view"></div>
            <div class="info-section">
                <div id="wait-list" class="log-area"><h3>ğŸ‘¥ ç”Ÿå­˜</h3><div id="wait-content"></div></div>
                <div id="log-view" class="log-area"><h3>ğŸ“ ãƒ­ã‚°</h3><div id="log-content"></div></div>
            </div>
        </div>
    </div>

    <div id="result-screen">
        <h2>ğŸ† æœ€çµ‚é †ä½ ğŸ†</h2>
        <div id="rank-list" style="max-width:300px; margin: 0 auto; background:#1a1a2e; padding:20px; border-radius:15px; border:2px solid var(--accent);"></div>
        <button class="btn" style="margin-top:20px;" onclick="location.href='lobby.html'">ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚‹</button>
    </div>

<script>
    // --- Firebaseè¨­å®š (Lobbyã¨åŒã˜ã‚‚ã®ã‚’è²¼ã‚Šä»˜ã‘) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBIWXpu0NjMHZnAEYItt-AQ35JOpMOt3Sk",
        authDomain: "cardbattle-86925.firebaseapp.com",
        databaseURL: "https://cardbattle-86925-default-rtdb.firebaseio.com",
        projectId: "cardbattle-86925",
        storageBucket: "cardbattle-86925.firebasestorage.app",
        messagingSenderId: "1014522332791",
        appId: "1:1014522332791:web:d515e72f3547744ef06872"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const ELEMENTS = [{name:"ç«", icon:"ğŸ”¥"}, {name:"æ°´", icon:"ğŸ’§"}, {name:"æœ¨", icon:"ğŸƒ"}, {name:"åœŸ", icon:"â›°ï¸"}];
    const MATRIX = [[1.0, 0.7, 2.0, 1.2], [1.5, 1.0, 0.7, 1.0], [0.7, 1.5, 1.0, 1.5], [1.0, 1.0, 0.7, 1.0]];

    let roomId = localStorage.getItem('multi_roomId');
    let myName = localStorage.getItem('multi_myName');
    let players = [];
    let isHost = false;
		let currentResolve = null;

		async function hostWaitNext(btnText) {
		    const overlay = document.getElementById('tap-overlay');
		    const msg = document.getElementById('tap-msg');

		    if (!overlay || !msg) return Promise.resolve();

		    // ğŸ’¡ ç”»é¢è¡¨ç¤ºã®æ›´æ–°
		    msg.innerText = btnText; 
		    overlay.style.display = 'flex'; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º

		    return new Promise(resolve => {
		        // resolve ã‚’å¤–éƒ¨ï¼ˆresolveTapï¼‰ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ä¿å­˜
		        currentResolve = resolve;
		    });
		}

		// ğŸ’¡ HTMLã® onclick="resolveTap()" ã‹ã‚‰å‘¼ã°ã‚Œã‚‹é–¢æ•°
		async function resolveTap() {
		    if (!isHost || !currentResolve) return;

		    console.log("NextãŒã‚¿ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚Firebaseã«é€šçŸ¥ã—ã¾ã™ã€‚");

		    // 1. Firebaseã«ã€Œæ¬¡ã¸ã€ã‚’é€šçŸ¥ï¼ˆã“ã‚Œã§è‡ªåˆ†ã‚’å«ã‚€å…¨å“¡ã® updateUI ãŒèµ°ã‚Šã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒæ¶ˆãˆã‚‹ï¼‰
		    await db.ref(`rooms/${roomId}/sync`).set({ 
		        type: 'next',
		        time: Date.now() 
		    });

		    // 2. ãƒ—ãƒ­ãƒŸã‚¹ã‚’è§£æ±ºã—ã¦ã€runHostLogic ã®ãƒ«ãƒ¼ãƒ—ã‚’å†é–‹ã•ã›ã‚‹
		    const resolve = currentResolve;
		    currentResolve = null;
		    resolve();
		}

		// --- 1. åˆæœŸåŒ–å‡¦ç† ---
		async function init() {
		    roomId = localStorage.getItem('multi_roomId');
		    myName = localStorage.getItem('multi_myName');

		    if (!roomId || !myName) {
		        alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚");
		        window.location.href = 'lobby.html';
		        return;
		    }

		    const snap = await db.ref(`rooms/${roomId}`).once('value');
		    const data = snap.val();
		    
		    if (!data || !data.members) {
		        document.getElementById('battle-msg').innerText = "ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
		        return;
		    }

		    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã®æ§‹ç¯‰ï¼ˆæ·±ã„ã‚³ãƒ”ãƒ¼ã§å‚ç…§ã‚’åˆ‡ã‚‹ï¼‰
		    players = Object.values(data.members).map(m => {
		        const p = {
		            name: m.name,
		            isHost: m.isHost || false,
		            cards: Array.isArray(m.cards) ? JSON.parse(JSON.stringify(m.cards)) : []
		        };
		        if (p.name === myName && p.isHost === true) isHost = true;

		        p.cards.forEach(c => {
		            let hpF = c.elmIdx === 3 ? 3.0 : 2.5; 
		            c.atk = c.raw.atk * 0.6;
		            c.maxHp = Math.floor(c.raw.hp * hpF);
		            c.currentHp = c.maxHp;
		            c.spd = c.raw.spd;
		            c.def = c.raw.def * 0.3;
		        });
		        return p;
		    });

		    updateWaitList();

		    // ğŸŒŸ ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã¨æç”»ã®å¸ä»¤å¡”
		    const syncRef = db.ref(`rooms/${roomId}/sync`);
		    syncRef.off(); 
		    syncRef.on('value', snap => {
		        const syncData = snap.val();
		        if (syncData) {
		            // ğŸ’¡ æ‰‹é †: 1.ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹ -> 2.ãã®ãƒ‡ãƒ¼ã‚¿ã§æç”»ã™ã‚‹
		            syncState(syncData); 
		            updateUI(syncData);
		        }
		    });

		    setTimeout(() => {
		        if (isHost) {
		            document.getElementById('battle-msg').innerText = "å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ã‚’çµ„ã‚“ã§ã„ã¾ã™...";
		            runHostLogic(); 
		        } else {
		            document.getElementById('battle-msg').innerText = "ãƒ›ã‚¹ãƒˆã®é€šä¿¡ã‚’å¾…ã£ã¦ã„ã¾ã™...";
		        }
		    }, 1500);
		}

		// --- 2. ãƒ‡ãƒ¼ã‚¿æ›´æ–°å°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯ (State Layer) ---
		// ã“ã®é–¢æ•°ã¯ã€Œå®Ÿä½“ãƒ‡ãƒ¼ã‚¿(players)ã€ã‚’ã„ã˜ã‚‹ã ã‘ã§ã€DOMã¯ã„ã˜ã‚‰ãªã„
		function syncState(data) {
		    if (data.type === 'match') {
		        const p1 = players.find(p => p.name === data.p1Name);
		        const p2 = players.find(p => p.name === data.p2Name);
		        // ãƒ›ã‚¹ãƒˆã®é€ã£ã¦ããŸHPã«ãƒ¡ãƒ¢ãƒªã‚’åŒæœŸ
		        if (p1 && p1.cards[0]) p1.cards[0].currentHp = data.p1Hp;
		        if (p2 && p2.cards[0]) p2.cards[0].currentHp = data.p2Hp;

		    } else if (data.type === 'turn') {
		        const p1 = players.find(p => p.name === data.p1Name);
		        const p2 = players.find(p => p.name === data.p2Name);
		        // æ”»æ’ƒå´ã®ç‰¹å®šã¯ä¸è¦ã ãŒã€HPã®æ•°å€¤ã¯å¸¸ã«æœ€æ–°ã‚’ç¶­æŒ
		        if (p1 && p1.cards[0]) p1.cards[0].currentHp = data.p1Hp;
		        if (p2 && p2.cards[0]) p2.cards[0].currentHp = data.p2Hp;

		    } else if (data.type === 'result') {
		        const loser = players.find(p => p.name === data.loserName);
		        if (loser && loser.cards.length > 0) {
								if(!isHost){
				            loser.cards.shift(); // ğŸ’¡ è² ã‘ãŸã‚«ãƒ¼ãƒ‰ã‚’1æšã ã‘æ¨ã¦ã‚‹ï¼ˆã“ã“ã§å”¯ä¸€ã®å‡¦ç†ï¼‰
								}
		        }
		    }
		}

		// --- 3. æç”»å°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯ (View Layer) ---
		// playersã®çŠ¶æ…‹ã‚’è¦‹ã¦HTMLã‚’ä½œã‚‹ã ã‘ï¼ˆå‰¯ä½œç”¨ãªã—ï¼‰
		function updateUI(data) {
		    const roles = ["å…ˆé‹’", "ä¸­å …", "å¤§å°†"];

		    if (data.type === 'match') {
		        const p1 = players.find(p => p.name === data.p1Name);
		        const p2 = players.find(p => p.name === data.p2Name);
		        
		        // å½¹è·ã¯ç¾åœ¨ã®ã€Œæ®‹ã‚Šæšæ•°ã€ã‹ã‚‰é€†ç®—ï¼ˆStateãŒshiftæ¸ˆã¿ãªã®ã§æ­£ã—ã„è¡¨ç¤ºã«ãªã‚‹ï¼‰
		        const r1 = roles[Math.max(0, 3 - p1.cards.length)];
		        const r2 = roles[Math.max(0, 3 - p2.cards.length)];

		        if (p1 && p1.cards[0]) {
		            document.getElementById('player-view').innerHTML = renderCard(p1.cards[0]);
		            updateHpBar('#player-view', p1.cards[0].currentHp);
		        }
		        if (p2 && p2.cards[0]) {
		            document.getElementById('enemy-view').innerHTML = renderCard(p2.cards[0]);
		            updateHpBar('#enemy-view', p2.cards[0].currentHp);
		        }

		        document.getElementById('battle-msg').innerHTML = 
		            `<span style="color:var(--accent)">${data.p1Name}ã®${r1}</span><br>VS<br><span style="color:#4da6ff">${data.p2Name}ã®${r2}</span>`;
		            
		    } else if (data.type === 'turn') {
		        updateHpBar('#player-view', data.p1Hp);
		        updateHpBar('#enemy-view', data.p2Hp);
		        const log = document.getElementById('log-content');
		        log.innerHTML = `<div>${data.turn}T: ${data.atkName}ã®æ”»æ’ƒï¼ ${data.dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸</div>` + log.innerHTML;
				} else if (data.type === 'next') {
		        // ğŸ’¡ ä¿®æ­£ï¼šã“ã“ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºã«ã™ã‚‹
		        const overlay = document.getElementById('tap-overlay');
		        if (overlay) {
		            overlay.style.display = 'none';
		        }
		        console.log("æ¬¡ã¸é€²ã¿ã¾ã™ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤ºï¼‰");
				} else if (data.type === 'result') {
				    // HPãƒãƒ¼ã‚’0ã«ã™ã‚‹å‡¦ç†ãªã©ã¯ãã®ã¾ã¾
				    if (data.loserSide === 'player') updateHpBar('#player-view', 0);
				    else updateHpBar('#enemy-view', 0);

						// ğŸ’¡ è¿½åŠ ï¼šã‚«ãƒ¼ãƒ‰ãŒæ¸›ã£ãŸå¾Œã®ç”Ÿå­˜ãƒªã‚¹ãƒˆã‚’å†æç”»ã™ã‚‹
				    updateWaitList();

				    // ğŸ’¡ data.msg ã‚’è¡¨ç¤ºï¼ˆã“ã“ãŒ "ã€‡ã€‡ã®å…ˆé‹’ãŒ..." ã«ãªã‚Šã¾ã™ï¼‰
				    const msgHtml = `<div style="color:gold; font-weight:bold; font-size:1.2rem; text-shadow: 0 0 10px rgba(255,215,0,0.5);">
				                        ğŸ“¢ ${data.msg}
				                      </div>`;
				    document.getElementById('battle-msg').innerHTML = msgHtml;

				    // ãƒ­ã‚°ã«ã‚‚è©³ç´°ã‚’æ®‹ã™
				    const log = document.getElementById('log-content');
				    if (log) {
				        log.innerHTML = `<div style="background:rgba(255,215,0,0.1); padding:8px; border-radius:5px; margin:5px 0; border-left:4px solid gold;">
				                            âš”ï¸ ${data.msg}
				                          </div>` + log.innerHTML;
				    }
				} else if (data.type === 'finish') {
		        showFinalResult(data.ranking);
		    }
		}

		// --- 4. ãƒ›ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯ (Controller Layer) ---
		// è¨ˆç®—ã—ã¦Firebaseã«é€ã‚‹ã ã‘ã€‚è‡ªåˆ†ã®UIã‚’ç›´æ¥å©ã‹ãªã„
		async function runHostLogic() {
		    let ranking = [];
		    const roles = ["å…ˆé‹’", "ä¸­å …", "å¤§å°†"];
		    const MATRIX = [[1, 0.8, 1.2, 1], [1.2, 1, 0.8, 1], [0.8, 1.2, 1, 1], [1, 1, 1, 1]];

		    await db.ref(`rooms/${roomId}/sync`).set(null);

		    while (true) {
		        let alives = players.filter(p => p.cards && p.cards.length > 0);
		        
		        // è„±è½ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
		        players.forEach(p => { 
		            if(p.cards.length === 0 && !ranking.includes(p.name)) ranking.unshift(p.name); 
		        });

		        if (alives.length <= 1) {
		            if(alives.length === 1) ranking.unshift(alives[0].name);
		            await db.ref(`rooms/${roomId}/sync`).set({ type: 'finish', ranking: ranking });
		            break; 
		        }

		        let p1 = alives[Math.floor(Math.random() * alives.length)];
		        let p2; do { p2 = alives[Math.floor(Math.random() * alives.length)]; } while(p1 === p2);

		        let c1 = p1.cards[0], c2 = p2.cards[0];

		        // ğŸ’¡ å‘½ä»¤ã‚’é€ã‚‹ã€‚è‡ªåˆ†ã‚‚ on('value') ã§ã“ã‚Œã‚’å—ã‘å–ã‚Šã€æç”»ãŒèµ°ã‚‹ã€‚
		        await db.ref(`rooms/${roomId}/sync`).set({ 
		            type: 'match', p1Name: p1.name, p1Hp: c1.currentHp, p2Name: p2.name, p2Hp: c2.currentHp 
		        });
		        
		        await hostWaitNext("è©¦åˆé–‹å§‹ï¼");

		        let turn = 0;
		        while (c1.currentHp > 0 && c2.currentHp > 0) {
		            turn++;
		            let volt = turn > 20 ? 1 + (turn - 20) * 0.05 : 1.0;
		            const isP1Attack = Math.random() * (c1.spd + c2.spd) < c1.spd;
		            const atk = isP1Attack ? c1 : c2;
		            const def = isP1Attack ? c2 : c1;
		            const dmg = Math.max(1, Math.floor((atk.atk * volt) * MATRIX[atk.elmIdx][def.elmIdx] - def.def));
		            def.currentHp -= dmg;

		            await db.ref(`rooms/${roomId}/sync`).set({ 
		                type: 'turn', turn, atkName: (isP1Attack ? p1.name : p2.name), dmg, p1Hp: c1.currentHp, p2Hp: c2.currentHp,
		                p1Name: p1.name, p2Name: p2.name // syncStateç”¨
		            });
		            await new Promise(r => setTimeout(r, 600));
		        }
		        
		        const isP1Win = c1.currentHp > 0;
						const winPlayer = isP1Win ? p1 : p2;
						const losePlayer = isP1Win ? p2 : p1;

						// ğŸ’¡ å½¹è·åã‚’ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰æšæ•°ã‹ã‚‰å–å¾—ï¼ˆshiftã™ã‚‹å‰ã®æšæ•°ã§åˆ¤å®šï¼‰
						const winRole = roles[Math.max(0, 3 - winPlayer.cards.length)];
						const loseRole = roles[Math.max(0, 3 - losePlayer.cards.length)];

						const resultData = {
						    type: 'result',
						    winner: winPlayer.name,
						    winRole: winRole,        // ğŸ”¥ è¿½åŠ 
						    loserName: losePlayer.name,
						    loseRole: loseRole,      // ğŸ”¥ è¿½åŠ 
						    p1Hp: c1.currentHp,
						    p2Hp: c2.currentHp,
						    loserSide: (isP1Win ? 'enemy' : 'player'),
						    // ğŸ’¡ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å½¹è·ã‚’çµ„ã¿è¾¼ã‚€
						    msg: `${winPlayer.name}ã®${winRole}ãŒã€${losePlayer.name}ã®${loseRole}ã‚’æ’ƒç ´ï¼`
						};

						//	ã‚«ãƒ¼ãƒ‰ä¸€æšå‰Šé™¤
						losePlayer.cards.shift();

						// ã“ã®å¾Œã§ Firebase ã« set ã™ã‚‹
						await db.ref(`rooms/${roomId}/sync`).set(resultData);

		        await hostWaitNext("æ¬¡ã®è©¦åˆã¸");
		    }
		}


		function runGuestLogic() {
		    // ã‚²ã‚¹ãƒˆã¯Firebaseã®æ›´æ–°ã‚’ç›£è¦–ã—ã¦ã€å±Šã„ãŸã‚‰UIã‚’æ›´æ–°ã™ã‚‹ã ã‘
		    db.ref(`rooms/${roomId}/sync`).on('value', (snap) => {
		        const data = snap.val();
		        updateUI(data);
		    });
		}

		function updateHpBar(targetSelector, currentHp) {
		    const container = document.querySelector(targetSelector);
		    if (!container) return;

		    const cardEl = container.querySelector('.card');
		    
		    // ğŸ’¡ ã“ã“ãŒé‡è¦ï¼ã‚«ãƒ¼ãƒ‰ãŒãªã„ã€ã‚ã‚‹ã„ã¯ dataset ãŒç„¡ã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
		    if (!cardEl || !cardEl.dataset) {
		        console.log("ã¾ã ã‚«ãƒ¼ãƒ‰ãŒæç”»ã•ã‚Œã¦ã„ãªã„ãŸã‚HPæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™");
		        return; 
		    }

		    const maxHp = parseFloat(cardEl.dataset.maxHp);
		    if (isNaN(maxHp)) return;

		    const hpBar = cardEl.querySelector('.hp-bar-fill');
		    if (hpBar) {
		        const percent = Math.max(0, (currentHp / maxHp) * 100);
		        hpBar.style.width = percent + "%";
		    }
		}

		function renderCard(c) {
		    if (!c) return `<div class="card empty"><div>NO CARD</div></div>`;
		    
		    const icons = ["ğŸ”¥", "ğŸ’§", "ğŸƒ", "â›°ï¸"];
		    
		    // ãƒãƒ¼ã®é•·ã•ã‚’è¨ˆç®— (æœ€å¤§å€¤ã‚’100ã¨ã—ã¦%ç®—å‡º)
		    const atkWidth = Math.min(100, (c.raw.atk / 100) * 100);
		    const defWidth = Math.min(100, (c.raw.def / 100) * 100);
		    const spdWidth = Math.min(100, (c.raw.spd / 100) * 100);

		    return `
		        <div class="card element-${c.elmIdx}" data-max-hp="${c.maxHp}">
		            <div class="card-rank">${c.rank}</div>
		            <div class="card-name">${c.pName}</div>
		            <div class="card-icon">${icons[c.elmIdx]}</div>

		            <div class="stat-row" style="margin-top: 110px;">
		                <div class="stat-label-container">
		                    <span class="stat-label">HP</span>
		                    <span class="stat-value">${Math.floor(c.maxHp)}</span>
		                </div>
		                <div class="bar-bg">
		                    <div class="hp-bar-fill" style="width: 100%;"></div>
		                </div>
		            </div>

		            <div class="stat-row">
		                <div class="stat-label-container">
		                    <span class="stat-label">ATK</span>
		                    <span class="stat-value">${Math.floor(c.raw.atk)}</span>
		                </div>
		                <div class="bar-bg">
		                    <div class="stat-bar-fill atk-color" style="width: ${atkWidth}%;"></div>
		                </div>
		            </div>

		            <div class="stat-row">
		                <div class="stat-label-container">
		                    <span class="stat-label">DEF</span>
		                    <span class="stat-value">${Math.floor(c.raw.def)}</span>
		                </div>
		                <div class="bar-bg">
		                    <div class="stat-bar-fill def-color" style="width: ${defWidth}%;"></div>
		                </div>
		            </div>

		            <div class="stat-row">
		                <div class="stat-label-container">
		                    <span class="stat-label">SPD</span>
		                    <span class="stat-value">${Math.floor(c.raw.spd)}</span>
		                </div>
		                <div class="bar-bg">
		                    <div class="stat-bar-fill spd-color" style="width: ${spdWidth}%;"></div>
		                </div>
		            </div>
		        </div>
		    `;
		}

		function updateWaitList() {
		    const container = document.getElementById('wait-content');
		    if (!container) return;

		    // ã‚«ãƒ¼ãƒ‰ãŒ1æšä»¥ä¸Šã‚ã‚‹äººã ã‘ã‚’è¡¨ç¤ºã™ã‚‹ã€ã¾ãŸã¯æ®‹ã‚Šæšæ•°ã‚’è¡¨ç¤ºã™ã‚‹
		    let html = "";
		    players.forEach(p => {
		        const count = p.cards ? p.cards.length : 0;
		        const status = count > 0 ? "ç”Ÿå­˜" : "è„±è½";
		        const color = count > 0 ? "#4da6ff" : "#888";
		        
		        html += `<div style="margin-bottom:5px; color:${color}">
		                    ${p.name} : ${'â˜…'.repeat(count)}${'â˜†'.repeat(3-count)} (${status})
		                 </div>`;
		    });
		    container.innerHTML = html;
		}

    function showFinalResult(ranking) {
        document.getElementById('game-ui').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        document.getElementById('rank-list').innerHTML = ranking.map((name, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333; ${i===0?'color:gold; font-weight:bold;':''}">
                <span>${i+1}ä½</span><span>${name}</span>
            </div>`).join('');
    }

    init();
</script>
</body>
</html>