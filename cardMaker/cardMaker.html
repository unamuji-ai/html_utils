<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>コンカフェ嬢バトルカード生成</title>
<style>
  body { font-family: sans-serif; padding: 20px; line-height: 1.7; }
  h1 { color: #801e63; font-size: 20px; }
  #cardCanvas { border: 2px solid #e91e63; margin-top: 20px; width: 300px; height: 1000px; }
  button { padding: 10px 20px; margin-top: 10px; font-size: 14px; }
</style>
</head>
<body>

<h1>✨ コンカフェ嬢バトルカード生成 ✨</h1>

<input type="file" id="imageInput" accept="image/*"><br>
<button onclick="generateCard()">カードを生成する</button>
<button onclick="downloadCard()">ダウンロード</button>

<canvas id="cardCanvas" width="300" height="1000"></canvas>

<script>
// =============================
// 属性とステータス
// =============================
const positiveAttributes  = [
  "元気","癒し","愛嬌","面白さ","機転","心尽くし","コミュ力"
];

const negativeAttributes = [
  "悪ノリ","下ネタ","P活","店外","グリ下","乞食","鬼畜","色営","オラ営","アルハラ","酒雑魚","ホス狂","彼氏持ち","風掛け持ち"
];

// 平均 mean、標準偏差 sd の正規分布乱数
function randNorm(mean, sd) {
  let u = Math.random();
  let v = Math.random();
  let z = Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
  return Math.round(mean + sd * z);
}

function clamp(v) {
  return Math.max(0, Math.min(100, v));
}

function randomStats() {
  return {
    beauty: clamp(randNorm(60, 20)),
    intelligence: clamp(randNorm(60, 20)),
    stamina: clamp(randNorm(60, 20)),
    guts: clamp(randNorm(60, 20)),
    mental: clamp(randNorm(60, 20))
  };
}

function randomAttributes() {
  const pos = [...positiveAttributes].sort(() => Math.random() - 0.5).slice(0, 2);
  const neg = [...negativeAttributes].sort(() => Math.random() - 0.5).slice(0, 1);
  return [...pos, ...neg];
}

// =============================
// キャプション用フレーズ
// =============================
const listA = [
  "夜の光に溶けるように",
  "微笑みの奥に小さな炎を灯し",
  "夢の続きに迷い込んだまま",
  "誰かの心をそっと照らすように",
  "秘密の魔法を胸に抱いて"
];

const listB = [
  "今日もあなたを迎えにいく",
  "静かに強さを隠している",
  "ふわりと世界を変えてしまう",
  "小さな勇気を積み重ねている",
  "誰よりも優しい嘘をつく"
];

const listC = [
  "そんな私を見つけてくれてありがとう。",
  "この瞬間が永遠でありますように。",
  "あなたの物語に寄り添えたら嬉しい。",
  "今日も少しだけ強くなれた気がする。",
  "心のどこかで、あなたを待っている。"
];

function randomCaption() {
  const pick = arr => arr[Math.floor(Math.random() * arr.length)];
  return pick(listA) + "、" + pick(listB) + "。" + pick(listC);
}

// =============================
// カード生成
// =============================
function generateCard() {
  const file = document.getElementById("imageInput").files[0];
  if (!file) {
    alert("画像を選んでね");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      drawCard(img);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// =============================
// アスペクト比を維持して描画
// =============================
const rarityColor = {
  "SSR": "#d3e",
  "SR":  "#ca2",
  "R":   "#e82",
  "N":   "#27f"
};

function drawCard(userImage) {
  const canvas = document.getElementById("cardCanvas");
  const ctx = canvas.getContext("2d");

  // レア度計算
  const stats = randomStats();
  const attrs = randomAttributes();
  const rarity = calcRarity(stats);

  // フレーム画像を先に読み込む
  const frameImg = new Image();
  frameImg.src = {
    "SSR": "ssr.png",
    "SR":  "sr.png",
    "R":   "r.png",
    "N":   "n.png"
  }[rarity];

  frameImg.onload = () => {
		// ① 背景
		ctx.fillStyle = "#404060";
		ctx.fillRect(0, 0, canvas.width, canvas.height);

		// ② 自撮り（中央260×460にフィット）
		const targetW = 260;
		const targetH = 460;
		const x = 20;
		const y = 70;

		// 自撮り画像をトリミングして中央にフィット
		const ratio = Math.max(targetW / userImage.width, targetH / userImage.height);
		const w = userImage.width * ratio;
		const h = userImage.height * ratio;
		const cropX = (w - targetW) / 2;
		const cropY = (h - targetH) / 2;

		// オフスクリーンCanvasでトリミング
		const tempCanvas = document.createElement("canvas");
		tempCanvas.width = targetW;
		tempCanvas.height = targetH;
		const tempCtx = tempCanvas.getContext("2d");

		// ここで「croppedSelfie」を作っている
		tempCtx.drawImage(userImage, -cropX, -cropY, w, h);

		// これをそのまま描画する
		ctx.drawImage(tempCanvas, x, y);

		// ③ フレーム（300×600）
		ctx.drawImage(frameImg, 0, 0, 300, 600); // ← 上部に固定

		// ④ ステータス・スキル・キャプション（y=610〜）
		drawStatusAndText(ctx, stats, attrs, rarity, 610); // ← yオフセットを渡す
  };
}

function drawStatusAndText(ctx, stats, attrs, rarity, offsetY = 610) {
  ctx.font = "28px sans-serif";
  ctx.fillStyle = rarityColor[rarity];
  ctx.fillText(rarity, 220, offsetY + 20);

  ctx.fillStyle = "#fff";
  ctx.font = "18px sans-serif";
  ctx.fillText("【ステータス】", 20, offsetY + 20);

  function drawBar(label, value, y) {
    ctx.fillStyle = "#fff";
    ctx.font = "14px sans-serif";
    ctx.fillText(`${label}: ${value}`, 20, y);
    ctx.fillStyle = "#ddd";
    ctx.fillRect(100, y - 10, 150, 8);
    ctx.fillStyle = "#f20";
    ctx.fillRect(100, y - 10, (value / 100) * 150, 8);
  }

  drawBar("容姿", stats.beauty, offsetY + 45);
  drawBar("知力", stats.intelligence, offsetY + 70);
  drawBar("体力", stats.stamina, offsetY + 95);
  drawBar("根性", stats.guts, offsetY + 120);
  drawBar("精神力", stats.mental, offsetY + 145);

  ctx.fillStyle = "#fff";
  ctx.font = "18px sans-serif";
  ctx.fillText("【パッシブスキル】", 20, offsetY + 170);

  let ax = 20;
  let ay = offsetY + 195;
  attrs.forEach(attr => {
    const isPositive = positiveAttributes.includes(attr);
    ctx.fillStyle = isPositive ? "#fcc" : "#2cf";
    ctx.font = "16px sans-serif";
    ctx.fillText(attr, ax, ay);
    ax += ctx.measureText(attr).width + 15;
    if (ax > 260) {
      ax = 20;
      ay += 20;
    }
  });

  const caption = randomCaption();
  ctx.font = "14px sans-serif";
  ctx.fillStyle = "#fff";
  const lines = caption.match(/.{1,15}/g);
  let cy = ay + 30;
  lines.forEach(line => {
    ctx.fillText(line, 20, cy);
    cy += 16;
  });
}

// =============================
// レア度計算
// =============================
function calcRarity(stats) {
  const values = Object.values(stats);
  const total = values.reduce((a, b) => a + b, 0);
  const minVal = Math.min(...values);

  if (total >= 400 && minVal >= 60) return "SSR";
  if (total >= 350 && minVal >= 40) return "SR";
  if (total >= 300) return "R";
  return "N";
}

// =============================
// ダウンロード
// =============================
function downloadCard() {
  const canvas = document.getElementById("cardCanvas");
  const link = document.createElement("a");
  link.download = "battle_card.png";
  link.href = canvas.toDataURL();
  link.click();
}
</script>

</body>
</html>