import streamlit as st
import pandas as pd
import plotly.express as px
import random

# ページ設定
st.set_page_config(page_title="あなたに対するネット上の評価", layout="centered")

# --- セッション状態の初期化 ---
if 'step' not in st.session_state:
    st.session_state.step = 0
if 'answers' not in st.session_state:
    st.session_state.answers = []
# sales: 営業火力, mental: 対人胆力, risk: 爆弾指数, compliance: 規律遵守
if 'points' not in st.session_state:
    st.session_state.points = {"sales": 0, "mental": 0, "risk": 0, "compliance": 0}

# --- 劇薬化された設問データ ---
# 配点順: (営業火力, 対人胆力, 爆弾指数, 規律遵守)
questions = [
    # SNS・自撮り編
    {"q": "自撮りの投稿傾向は？", "options": [
        ("清楚・美少女系", (5, 0, -10, 50)), 
        ("グラビア系", (25, 15, 15, 0)), 
        ("露出・エロ寄り", (45, 45, 60, -50)), 
        ("病み・地雷系", (15, -15, 30, 0))]},
    {"q": "客へのSNS営業のメイン手法は？", "options": [
        ("ポストのみ", (-10, -20, 0, 40)), 
        ("DMで「今日いるよ！」", (15, 5, 5, 20)), 
        ("DMで「寂しい」", (35, 25, 30, -10)), 
        ("DMで「今日来て！何時くる？」", (50, 40, 20, -20))]},
    {"q": "SNSでの返信・いいね運用は？", "options": [
        ("ほとんどしない", (-20, -30, 0, 30)), 
        ("出勤日にいいねだけ", (-5, 10, 10, 30)), 
        ("太客・オキニには厚めに", (40, 30, 40, -10)), 
        ("気まぐれに適当", (15, 15, 15, 15))]},

    # 接客・ドリンク編
    {"q": "ドリンクのねだり方は？", "options": [
        ("いただけてもよろしいですか？", (5, -10, -5, 50)), 
        ("ねー、なんか飲んでいい？", (30, 20, 20, -10)), 
        ("無言で見つめる", (40, 40, 30, 10)), 
        ("喉乾いちゃった🥺", (25, 15, 15, 5))]},
    {"q": "チェキ撮影時の物理的距離は？", "options": [
        ("ソーシャルディスタンス", (-20, -10, -10, 50)), 
        ("こぶし一つ分", (10, 5, 5, 30)), 
        ("多少の接触まで", (35, 25, 25, 0)), 
        ("完全な接触・密着", (60, 50, 60, -50))]},
    
    # ガチ恋対応編
    {"q": "【リアル】「付き合ってるよね？」と手を重ねてこられたら？", "options": [
        ("「秘密だよ」と指を絡める", (60, 60, 50, -60)), 
        ("えー何飲んでいい？と高額ボトル要求", (10, 40, 50, 0)), 
        ("笑いながら僅かだけ許容", (40, 20, 20, 0)), 
        ("「接触はNGだよ」と制する", (-30, -40, -20, 60))]},
    {"q": "【DM】深夜3時の就寝前「誰かと一緒？不安」という粘着DMには？", "options": [
        ("「もう寝るとこ、おやすみ」", (20, 10, 0, 10)), 
        ("未読放置", (-10, -20, 0, 40)), 
        ("翌朝「ごめん、寝てた」の一言", (10, 0, 5, 30)), 
        ("出勤前まで既読放置", (5, -10, 0, 30))]},
    
    # 説教対応編
    {"q": "【リアル】「君の自撮りは良くない、そもそも髪型が…」と説教され始めたら？", "options": [
        ("「えーどんなのが好き？」とじっくり聞く", (40, 50, -10, 30)), 
        ("「好みは人それぞれだからね」と軽く流す", (5, 10, 5, 20)), 
        ("「喉乾いた！お茶飲んでいい？」と話題を変える", (-10, 20, 15, 15)), 
        ("「自分がかわいいと思えばいいの！」と反論", (-20, 30, 30, 5))]},
    {"q": "【DM】客から長文のダメ出しDMが届いたら？", "options": [
        ("改善する（フリ）の返信をする", (50, 50, -10, 30)), 
        ("スクショしていつか晒す、その場は無視", (-20, 30, 40, -10)), 
        ("「はいはいｗ」とスタンプ1個で終了", (-15, 20, 20, 10)), 
        ("ブロックorミュート設定", (-40, -50, 20, 10))]},
    
    # 下ネタ・セクハラ編
    {"q": "【リアル】「最近いつした？」と聞かれたら？", "options": [
        ("「出勤前」と即答", (50, 60, 50, -40)), 
        ("えー何を？ととぼける", (0, -10, -10, 20)), 
        ("「シャンパン入れてくれたら教える」", (30, 25, 20, 10)), 
        ("「セクハラなら普通に引きます」と断絶", (-20, -50, -10, 60))]},
    {"q": "【DM】太客から卑猥な画像と共に「そっちのも送って」と来たら？", "options": [
        ("「いくらのボトル下ろすかによる」", (20, 60, 30, -30)), 
        ("「びっくり!ちっさw」と煽る", (-30, 50, 20, -10)), 
        ("無言で既読スルー", (0, -10, 0, 30)), 
        ("運営に報告・ブロック相談", (0, 10, -30, 50))]},

    # 特殊客編
    {"q": "【素伝】ドリンク出さない客への対応は？", "options": [
        ("「来てくれるだけいいよ」と聖母対応", (45, 40, 20, 10)), 
        ("「話すると喉渇くんだよね〜」と圧", (15, 20, 15, 10)), 
        ("挨拶だけで放置", (-20, -15, 10, 30)), 
        ("ダメもとでドリンクおねだり", (-10, 10, 5, 20))]},
    {"q": "【推し変】目の前で他の子を褒め始めたら？", "options": [
        ("「他の子がいいんだ」と拗ねる", (40, 20, 10, -10)), 
        ("「あの子可愛いよね！」と割り切る", (5, 10, 5, 30)), 
        ("温度を0にして放置", (10, -10, 15, 20)), 
        ("「ふーん、あっそ、バイバイｗ」と切り捨てる", (20, 0, 10, 0))]},
    {"q": "【臭い客】至近距離で臭いがきつい時は？", "options": [
        ("笑顔で耐えて香水を撒く", (20, 40, 5, 30)), 
        ("常に距離をキープ", (5, -10, 0, 20)), 
        ("ファブリーズを撒く", (10, 30, 30, -20)), 
        ("「お風呂入ってきた？ｗ」と指摘", (-10, 40, 20, -30))]},
    {"q": "【繋がり要求】「本名とLINE教えて」と言われたら？", "options": [
        ("「もっと仲良くなったらね」", (30, 30, 20, 10)), 
        ("「店辞めたら教えるかも」", (45, 20, 50, -20)), 
        ("「無理ｗ」", (0, 10, 5, 20)), 
        ("「ルール違反。次言ったら出禁」", (-30, 30, -20, 60))]},
    {"q": "【店外要求】「今後ご飯行こう」と誘われたら？", "options": [
        ("「おいしい所なら！」と言いながら絶対行かない", (55, 40, 15, -40)), 
        ("「100万くらい使ってくれたら考える」", (15, 40, 30, 10)), 
        ("相手次第", (5, 30, 60, -60)), 
        ("「解雇になっちゃうんで…」で断る", (-20, -20, -20, 60))]},
    
    # 詰め編
    {"q": "シャンパンが入った時のリアクションは？", "options": [
        ("実際の感情以上に喜ぶ", (30, 10, 30, 30)), 
        ("「お礼は何がいい？」とする気もない話をする", (50, 45, 20, -10)), 
        ("淡々と、でも丁寧に御礼", (10, -10, 5, 30)), 
        ("「次回は別のもほしいな」", (20, 30, 20, 10))]},
    {"q": "客が他の客と喧嘩し始めたら？", "options": [
        ("オーナーもしくは警察を呼ぶ", (0, -10, 20, 50)), 
        ("「他のお客様の迷惑なので」と注意する", (-10, 30, -10, 40)), 
        ("誰かがどうにかするだろ、で放置", (0, -30, 10, -30)), 
        ("面白いので煽る", (0, 30, 60, -50))]},
    {"q": "卒業時群がってくる繋がり厨への対応は？", "options": [
        ("「卒業したら会おうね」と嘘をつき通す", (60, 50, 40, -50)), 
        ("「もう会えないけどありがとう」で乗り切る", (-20, -10, -20, 50)), 
        ("相手による", (10, -10, 40, -40)), 
        ("「転生するまで待ってて」で次に引っ張る", (20, 20, 10, 20))]},
    {"q": "最後に。あなたにとって「客」とは？", "options": [
        ("人生を豊かにしてくれる存在", (30, 30, 20, 30)), 
        ("ただの「ATM（金）」", (-30, 30, 50, 0)), 
        ("適度な距離で楽しむ遊び相手", (15, 10, 10, 40)), 
        ("接客という仕事の攻略対象", (15, 25, 10, 20))]}
]

TOTAL_STEPS = len(questions)

# --- 画面描画 ---
if st.session_state.step == 0:
    st.title("🌐 コンカフェ嬢・営業精密診断 PRO")
    st.warning("⚠️ **診断の際のお願い**\n\n特定の個人や状況に限定せず、**平均的な自身の振る舞い**をイメージして回答してください。")
    name = st.text_input("源氏名を入力してください", key="name_input")
    if st.button("診断を開始"):
        if name:
            st.session_state.name = name
            st.session_state.step = 1
            st.rerun()

elif 1 <= st.session_state.step <= TOTAL_STEPS:
    idx = st.session_state.step - 1
    q_data = questions[idx]
    st.write(f"第 {st.session_state.step} 問 / {TOTAL_STEPS}")
    st.progress(st.session_state.step / TOTAL_STEPS)
    st.subheader(q_data["q"])
    choice_text = st.radio("選択肢：", [opt[0] for opt in q_data["options"]], index=None, key=f"q_{st.session_state.step}")
    if st.button("次へ →"):
        if choice_text:
            selected_opt = next(opt for opt in q_data["options"] if opt[0] == choice_text)
            st.session_state.points["sales"] += selected_opt[1][0]
            st.session_state.points["mental"] += selected_opt[1][1]
            st.session_state.points["risk"] += selected_opt[1][2]
            st.session_state.points["compliance"] += selected_opt[1][3]
            st.session_state.step += 1
            st.rerun()

else:
    st.balloons()
    st.title(f"📊 {st.session_state.name} さんの分析結果")
    
    # --- スコア計算（シミュレーション済みの分母調整） ---
    s = max(min(st.session_state.points["sales"] // 5, 100), 0)
    m = max(min(st.session_state.points["mental"] // 6, 100), 0)
    r = max(min(st.session_state.points["risk"] // 6, 100), 0)
    c = max(min(st.session_state.points["compliance"] // 4, 100), 0)

    # レーダーチャート
    df_plot = pd.DataFrame(dict(r=[s, m, r, c], theta=['営業火力', '対人胆力', '爆弾指数', '規律遵守']))
    fig = px.line_polar(df_plot, r='r', theta='theta', line_close=True, range_r=[0,100])
    fig.update_traces(fill='toself', line_color='#FF4B4B')
    st.plotly_chart(fig)

    col1, col2 = st.columns(2)
    col1.metric("営業火力", f"{s}%")
    col1.metric("対人胆力", f"{m}%")
    col2.metric("爆弾指数", f"{r}%")
    col2.metric("規律遵守", f"{c}%")

    st.divider()

    # --- クラスター判定ロジック ---
    style, desc = "バランス型アイドル嬢", "全てのステータスが平均的。王道の立ち回りで安定した人気を誇るエース候補です。"
    titles = ["【安定】〇〇ちゃんは安定感あるよな。迷ったらとりあえず行け。"]
    replies = ["「診断結果、完全に今の立ち回りと一致してて草」", "「最近あそこの店、この子が目立ってるな。次期エースだろ」"]

    # 1. 超・極端タイプ (特筆すべき突き抜け)
    if s > 85 and c > 80:
        style, desc = "伝説のプロキャスト", "高い規律と圧倒的な営業火力を両立。運営・客の双方から神格化される完成形。"
        titles = ["【神】〇〇店の『伝説の嬢』、ついに見つかるｗ"]
        replies = [f"「{st.session_state.name}様、昨日もタワー立ててて格が違いすぎたわ」", "「プロ意識の塊。店外誘ったら笑顔で高額シャンパン空けさせられたｗ」"]
        
    elif r > 80 and c < 30:
        style, desc = "界隈の劇薬・爆弾娘", "リスク度外視の攻撃スタイル。ネット掲示板で『絶対に関わるな』と晒されるスリル担当。"
        titles = ["【警告】ガチ恋泥棒・〇〇ちゃん、今日も元気に繋がり発覚ｗ"]
        replies = [f"「昨日{st.session_state.name}と外歩いてるの見たぞ。運営寝てるんか？」", "「爆弾指数高すぎｗもはや清々しいな、お前ら絶対近づくなよ」"]
        
    # 2. 意外な2軸の組み合わせ (相関を逆手に取った個性)
    elif m > 65 and c > 70:
        style, desc = "裏番長・フィクサー嬢", "感情に流されず、規律を守りつつ客を統治する。運営の信頼が最も厚い影の支配者。"
        titles = ["【最強】〇〇店の番長、客の喧嘩を『一瞥』で鎮圧ｗｗ"]
        replies = ["「客が揉め始めた瞬間、無言で圧かけて黙らせてて震えたわ」", f"「{st.session_state.name}が辞めたらこの店終わるって店長が泣いてたぞ」"]

    elif s > 70 and r > 60:
        style, desc = "計算高いビジネス地雷", "営業のために『病み』や『危うさ』を武器にする。どこまでが演技か不明なプロ地雷。"
        titles = ["【職人芸】〇〇ちゃんの『ビジネス病み』に釣られた被害者の会"]
        replies = ["「病みツイートに釣られてシャンパン入れた俺が馬鹿だった。裏で笑ってそう」", "「どこまでが演技なんだ…？ 怖すぎて逆にハマるわ」"]

    elif s < 40 and c > 75:
        style, desc = "愛され天然・養われ型", "必死な営業は皆無。ただそこに『純粋』に存在することで、客の保護欲をカンストさせる才。"
        titles = ["【絶滅危惧種】ガツガツしてない〇〇ちゃん、おじさんの財布を無自覚に破壊ｗ"]
        replies = ["「この子にだけは『金ないならいいよ』って言わせたくない。俺が稼ぐ。」", f"「{st.session_state.name}に営業されたことないけど、気づいたら月50使ってたわ」"]

    elif m > 75 and c < 40:
        style, desc = "無敵のサイコパス営業", "メンタルが強すぎて、客を詰めたりルールを無視しても心が痛まない、ある意味で最強の女。"
        titles = ["【悲報】〇〇店のキャスト、客の説教を『BGM』扱いしててワロタ"]
        replies = ["「客にブスって言われて『えーｗお揃いですねｗ』って返してて草生えた」", "「鋼のメンタルすぎて詰めが効かない。最終的にこっちが謝ってたわ」"]

    elif s > 70 and m < 40:
        style, desc = "ガラスの特攻隊長", "高い営業火力を持つが、メンタルは繊細。売上の波で情緒が激しく揺れ動く、目が離せないタイプ。"
        titles = ["【不安定】〇〇店のNo.1、今日もシャンパン飲んで泣いてるｗ"]
        replies = [f"「{st.session_state.name}、売上えぐいのにすぐ病むから目が離せん」", "「情緒がジェットコースターすぎて、支えてあげなきゃ感がすごいわ」"]

    elif r < 30 and s < 30:
        style, desc = "清廉潔白な置物(地蔵)", "悪いことは一切しないが、営業も一切しない。清らかすぎてコンカフェの空気を浄化する専門。"
        titles = ["【浄化】〇〇店の新人、ただ座ってるだけで時給発生ｗｗ"]
        replies = ["「挨拶して以降ずっと黙っててワロタ。逆に出勤してるのが奇跡だろ」", "「この子だけは絶対に汚しちゃいけない気がする。拝むための存在」"]

    # 3. バランス型の中の細分化
    elif s > 50 and m > 50:
        style, desc = "王道・次期エース候補", "全ての項目が平均以上で、特に攻めの姿勢がある。安定した人気を誇る将来の看板嬢。"
        titles = ["【朗報】〇〇店の期待の新人、非の打ち所がない王道スタイル。"]
        replies = ["「非の打ち所がないな。このままいけば半年後には看板だわ」", "「対応に隙がない。教育が行き届いてるのか、本人のセンスか…」"]
    
    # 判定なし（上記すべてに漏れた場合）
    else:
        style, desc = "愛想笑いのプロ(八方美人)", "誰からも嫌われないが、決定打に欠ける器用貧乏タイプ。毒にも薬にもならない安定感。"
        titles = ["【安定】〇〇ちゃんは安定感あるよな。迷ったらとりあえず行け。"]
        replies = ["「良くも悪くも普通。とりあえず誰が行っても外れはない感じ」", "「愛想はいいんだけど、もう一押し欲しいよな。頑張れ」"]

    # --- 表示処理 ---
    st.success(f"あなたの営業スタイル： **【{style}】**")
    st.write(desc)

    st.subheader("💬 SNSまとめスレの反応")
    st.info(f"📁 {random.choice(titles)}")
    for rep in replies:
        st.chat_message("user").write(rep)


    if st.button("最初からやり直す"):
        for key in list(st.session_state.keys()): del st.session_state[key]
        st.rerun()