<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hit & Blow Online - Pro</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 20px; width: 100%; max-width: 350px; text-align: center; }
        .status-bar { font-weight: bold; padding: 8px; margin-bottom: 15px; border-radius: 5px; width: 100%; transition: 0.3s; }
        .my-turn { background: #e63946; color: white; }
        .waiting { background: #ddd; color: #666; }
        .finished { background: #1d3557; color: white; }
        
        input[type="number"] { font-size: 24px; width: 140px; padding: 10px; text-align: center; border: 2px solid #ccc; border-radius: 8px; margin: 10px 0; }
        .error-msg { color: #e63946; font-size: 12px; height: 18px; font-weight: bold; }
        
        .btn { background: #1d3557; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .restart-btn { background: #2a9d8f; margin-top: 20px; display: none; }

        .logs-container { display: flex; gap: 10px; margin-top: 20px; width: 100%; }
        .log-box { flex: 1; background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; height: 200px; overflow-y: auto; font-size: 13px; text-align: left; }
        .log-title { font-weight: bold; font-size: 11px; color: #777; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .log-item { margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }

    </style>
</head>
<body>

<div class="card">
    <div id="status" class="status-bar waiting">æ¥ç¶šä¸­...</div>

    <div id="setup-ui">
        <p>ç›¸æ‰‹ã«å½“ã¦ã‚‹4æ¡ã®æ•°å­—ã‚’æ±ºã‚ã¦ãã ã•ã„</p>
        <div class="error-msg" id="setup-error"></div>
        <input type="number" id="secretInput" placeholder="1234" oninput="validateInput('secretInput', 'setup-error', 'confirmBtn')">
        <br>
        <button id="confirmBtn" class="btn" onclick="confirmSecret()" disabled>æ±ºå®š</button>
    </div>

    <div id="game-ui" style="display:none;">
        <div id="input-area">
            <p id="instruction">ç›¸æ‰‹ã®æ•°å­—ã‚’äºˆæƒ³ã—ã¦ãã ã•ã„</p>
            <div class="error-msg" id="guess-error"></div>
						<div id="skill-memo" style="display: flex; justify-content: center; gap: 5px; width: 100%; max-width: 200px; height: 45px; margin: 10px auto; font-family: 'Courier New', monospace; font-weight: bold;">
						    <div id="memo-pos-0" style="flex: 1; border: 2px solid #2a9d8f; border-radius: 4px; background: #f0fdfa; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; color: #2a9d8f;"></div>
						    <div id="memo-pos-1" style="flex: 1; border: 2px solid #2a9d8f; border-radius: 4px; background: #f0fdfa; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; color: #2a9d8f;"></div>
						    <div id="memo-pos-2" style="flex: 1; border: 2px solid #2a9d8f; border-radius: 4px; background: #f0fdfa; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; color: #2a9d8f;"></div>
						    <div id="memo-pos-3" style="flex: 1; border: 2px solid #2a9d8f; border-radius: 4px; background: #f0fdfa; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px; color: #2a9d8f;"></div>
						</div>

						<div style="display: flex; flex-direction: column; align-items: center;">
								<input type="number" id="guessInput" placeholder="????" oninput="validateInput('guessInput', 'guess-error', 'guessBtn')" style="margin-top: 5px; letter-spacing: 8px; padding-left: 20px;">
						</div>

            <br>
            <button id="guessBtn" class="btn" onclick="onGuessSubmit()" disabled>äºˆæƒ³ã‚’é€ä¿¡</button>
        </div>

        <div class="logs-container">
            <div class="log-box">
                <div class="log-title">ç›¸æ‰‹ã®äºˆæƒ³ (è‡ªåˆ†)</div>
                <div id="my-defend-log"></div>
            </div>
            <div class="log-box">
                <div class="log-title">è‡ªåˆ†ã®äºˆæƒ³ (ç›¸æ‰‹)</div>
                <div id="my-attack-log"></div>
            </div>
        </div>

				<div id="sp-container" style="width: 100%; margin-bottom: 10px; display: none;">
				    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 2px;">
				        <span>Skill Points</span>
				        <span id="sp-value">0 / 10</span>
				    </div>
				    <div style="width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden;">
				        <div id="sp-bar" style="width: 0%; height: 100%; background: #2a9d8f; transition: 0.3s;"></div>
				    </div>
				</div>

				<div id="skill-area" style="margin-top: 15px;">
				    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
				        <button id="skill-0" class="btn skill-btn" onclick="useSkill(0)" disabled style="font-size: 12px; padding: 8px;">Skill 1</button>
				        <button id="skill-1" class="btn skill-btn" onclick="useSkill(1)" disabled style="font-size: 12px; padding: 8px;">Skill 2</button>
				        <button id="skill-2" class="btn skill-btn" onclick="useSkill(2)" disabled style="font-size: 12px; padding: 8px;">Skill 3</button>
				        <button id="skill-3" class="btn skill-btn" onclick="useSkill(3)" disabled style="font-size: 12px; padding: 8px;">Skill 4</button>
				    </div>
				</div>

        <button id="restartBtn" class="btn restart-btn" onclick="requestRestart()">ã‚‚ã†ä¸€åº¦å¯¾æˆ¦ã™ã‚‹</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const role = params.get('role');
    
    let mySecret = "";
    let isMyTurn = false;
    let opponentReady = false;
    let opponentWantsRestart = false;

		let mySP = 0;
		const MAX_SP = 10;
		let skillStock = []; // ã‚¹ãƒˆãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚­ãƒ«ã®ç¨®é¡ã‚’ä¿å­˜ ['HL', 'OE', ...]
		let revealedInfo = {
		    HL: [false, false, false, false], // å„æ¡ã® Hi/Lo åˆ¤æ˜ãƒ•ãƒ©ã‚°
		    OE: [false, false, false, false]  // å„æ¡ã® Odd/Even åˆ¤æ˜ãƒ•ãƒ©ã‚°
		};
		// è¿½åŠ ï¼šè‡ªåˆ†ã®éå»ã®äºˆæƒ³ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
		let attackHistory = [];
		let revealedPositions = []; // æ­£è§£ãŒåˆ¤æ˜ã—ãŸæ¡


		// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡éƒ¨ã«ã‚¹ã‚­ãƒ«é–¢ä¿‚ã‚’è¿½åŠ 
		window.addEventListener("message", (e) => {
		    const data = e.data;
		    if (data.type === "READY") {
		        opponentReady = true;
		        checkStart();
		    } else if (data.type === "GUESS") {
		        handleOpponentGuess(data.value);
		    } else if (data.type === "RESULT") {
		        handleResult(data);
		    } else if (data.type === "RESTART") {
		        opponentWantsRestart = true;
		        checkRestart();
		    } else if (data.type === "SKILL_REQ") {
		        handleSkillRequest(data);
		    } else if (data.type === "SKILL_RES") {
		        updateSkillMemo(data);
		    }
		});


		// --- å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ (4æ¡åˆ¤å®š ï¼‹ æ—¢å‡ºãƒã‚§ãƒƒã‚¯) ---
		function validateInput(inputId, errorId, btnId) {
		    const val = document.getElementById(inputId).value;
		    const errorEl = document.getElementById(errorId);
		    const inputEl = document.getElementById(inputId);
		    const btn = document.getElementById(btnId);
		    
		    // åˆæœŸçŠ¶æ…‹
		    errorEl.innerText = "";
		    inputEl.style.borderColor = "#ccc";
		    btn.disabled = true;

		    if (val.length !== 4) {
		        if (val.length > 0) errorEl.innerText = "4æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„";
		        return;
		    }

		    // æ—¢å‡ºãƒã‚§ãƒƒã‚¯ï¼ˆäºˆæƒ³å…¥åŠ›æ™‚ã®ã¿ï¼‰
		    if (inputId === 'guessInput') {
		        if (attackHistory.includes(val)) {
		            errorEl.innerText = "è­¦å‘Šï¼šã“ã®æ•°å­—ã¯æ—¢ã«å…¥åŠ›æ¸ˆã¿ã§ã™ï¼";
		            errorEl.style.color = "#ff9800"; // è­¦å‘Šè‰²ã¯ã‚ªãƒ¬ãƒ³ã‚¸
		            inputEl.style.borderColor = "#ff9800";
		            // é€ä¿¡è‡ªä½“ã¯ç¦æ­¢ã—ãªã„ï¼ˆã‚ãˆã¦ã‚‚ã†ä¸€åº¦é€ã‚ŠãŸã„å ´åˆã‚‚ã‚ã‚‹ãŸã‚ï¼‰
		            if (isMyTurn) btn.disabled = false;
		            return;
		        }
		    }

		    // æ­£å¸¸æ™‚
		    if (inputId === 'guessInput') {
		        if (isMyTurn) btn.disabled = false;
		    } else {
		        btn.disabled = false; // è¨­å®šç”»é¢ç”¨
		    }
		}

		// 1. æ•°å­—æ±ºå®šæ™‚ã«SPã‚²ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã•ã›ã‚‹
		function confirmSecret() {
		    mySecret = document.getElementById('secretInput').value;
		    document.getElementById('setup-ui').style.display = 'none';
		    document.getElementById('game-ui').style.display = 'block';
		    
		    // ã“ã“ã§SPã‚²ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼
		    document.getElementById('sp-container').style.display = 'block'; 
		    
		    updateStatus("ç›¸æ‰‹ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™...");
		    send({ type: "READY" });
		    checkStart();
		    updateSPUI(); // åˆæœŸè¡¨ç¤ºæ›´æ–°
		}

		function checkStart() {
		    if (mySecret && opponentReady) {
		        // ãƒ›ã‚¹ãƒˆï¼ˆå…ˆã«URLã‚’é–‹ã„ãŸå´ï¼‰ãŒå…ˆæ”»ã€ã‚²ã‚¹ãƒˆãŒå¾Œæ”»
		        if (role === "host") {
		            setTurn(true);
		        } else {
		            setTurn(false);
		        }
		    }
		}

		// äºˆæƒ³é€ä¿¡æ™‚ã«å±¥æ­´ã«è¿½åŠ 
		function onGuessSubmit() {
		    const val = document.getElementById('guessInput').value;
		    if (val.length !== 4) return;
		    
		    attackHistory.push(val);
		    send({ type: "GUESS", value: val });
		    
		    document.getElementById('guessInput').value = "";
		    
		    // é€ä¿¡ç›´å¾Œã«å³åº§ã«ã‚¿ãƒ¼ãƒ³ã‚’çµ‚äº†ã•ã›ã‚‹
		    setTurn(false);
		}

    function handleOpponentGuess(guessValue) {
        let hit = 0, blow = 0;
        const gArr = guessValue.split("");
        const sArr = mySecret.split("");
        for (let i = 0; i < 4; i++) {
            if (gArr[i] === sArr[i]) hit++;
            else if (sArr.includes(gArr[i])) blow++;
        }
        const isWin = (hit === 4);
        addLog("my-defend-log", `${guessValue} : ${hit}H ${blow}B`);
        send({ type: "RESULT", value: guessValue, hit, blow, win: isWin });

        if (isWin) {
            endGame("ã‚ãªãŸã®è² ã‘ã§ã™...");
        } else {
            setTurn(true);
        }
    }

		// 3. åˆ¤å®šçµæœ(RESULT)ãŒå±Šã„ãŸæ™‚ã«SPã‚’åŠ ç®—ã™ã‚‹
		function handleResult(data) {
		    addLog("my-attack-log", `${data.value} : ${data.hit}H ${data.blow}B`);
		    
		    // SPè¨ˆç®—
		    const hitPenalty = parseInt(data.hit) * 2;
		    const blowPenalty = parseInt(data.blow) * 1;
		    const earnedSP = 8 - hitPenalty - blowPenalty;
		    
		    if (earnedSP > 0) {
		        addSP(earnedSP); // ã“ã“ã§10ptè¶…ãˆãŸã‚‰ã‚¹ã‚­ãƒ«ã«å¤‰æ›ã•ã‚Œã‚‹
		    }

		    if (data.win) {
		        endGame("ã‚ãªãŸã®å‹ã¡ï¼");
		    } else {
		        // å‹ã¡ã§ãªã„ãªã‚‰ã€è‡ªåˆ†ã«ã‚¿ãƒ¼ãƒ³ã‚’æˆ»ã™
		        // ã“ã‚Œã«ã‚ˆã£ã¦ setTurn(true) å†…ã® updateSPUI ãŒå®Ÿè¡Œã•ã‚Œã€
		        // æºœã¾ã£ãŸã°ã‹ã‚Šã®ã‚¹ã‚­ãƒ«ãŒã€Œä½¿ãˆã‚‹çŠ¶æ…‹ï¼ˆç·‘ï¼‰ã€ã«ãªã‚Šã¾ã™
		        setTurn(false); 
		    }
		}

		// 4. ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã‚‚ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
		function setTurn(myTurn) {
		    isMyTurn = myTurn;
		    const btn = document.getElementById('guessBtn');
		    const status = document.getElementById('status');
		    const input = document.getElementById('guessInput');
		    
		    if (myTurn) {
		        status.innerText = "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³";
		        status.className = "status-bar my-turn";
		        // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã«ãªã£ãŸæ™‚ã ã‘ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãƒœã‚¿ãƒ³ã‚’æ´»æ€§åŒ–
		        validateInput('guessInput', 'guess-error', 'guessBtn');
		    } else {
		        // ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã®æ™‚ã¯å¼·åˆ¶çš„ã«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
		        btn.disabled = true;
		        status.innerText = "ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³...";
		        status.className = "status-bar waiting";
		    }
		    
		    // ã‚¹ã‚­ãƒ«ãƒœã‚¿ãƒ³ãªã©ã®è¡¨ç¤ºã‚‚ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³çŠ¶æ…‹ã«åˆã‚ã›ã¦æ›´æ–°
		    updateSPUI(); 
		}

    function endGame(msg) {
        updateStatus(msg);
        document.getElementById('status').className = "status-bar finished";
        document.getElementById('input-area').style.opacity = "0.5";
        document.getElementById('guessBtn').disabled = true;
        document.getElementById('restartBtn').style.display = "inline-block";
    }

		// 1. SPåŠ ç®—ã¨è‡ªå‹•ã‚¹ã‚­ãƒ«ã®åˆ†å²
		function addSP(amount) {
		    if (revealedPositions.length >= 4) return;

		    mySP += amount;

		    // SPãŒ10ä»¥ä¸Šã«é”ã—ãŸæ™‚ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼ˆä¸€æ°—ã«20æºœã¾ã£ãŸå ´åˆãªã©ã‚‚è€ƒæ…®ï¼‰
		    while (mySP >= MAX_SP) {
		        if (skillStock.length >= 4) {
		            // ã€ç©¶æ¥µã‚¹ã‚­ãƒ«ç™ºå‹•ã€‘ã‚¹ãƒˆãƒƒã‚¯4 ï¼‹ ã‚²ãƒ¼ã‚¸10åˆ°é”
		            let available = [0, 1, 2, 3].filter(p => !revealedPositions.includes(p));
		            if (available.length > 0) {
		                const chosenPos = available[Math.floor(Math.random() * available.length)];
		                send({ type: "SKILL_REQ", skillType: 'FULL', pos: chosenPos });
		                
		                skillStock = []; // ã‚¹ãƒˆãƒƒã‚¯å…¨æ¶ˆè²»
		                mySP = 0;        // ç©¶æ¥µã‚¹ã‚­ãƒ«ã¯ä¾‹å¤–çš„ã«ã‚²ãƒ¼ã‚¸ã‚‚0ã«ã™ã‚‹ï¼ˆç¹°ã‚Šè¶Šã—ãªã—ã®å¼·åŠ›ãªæŠ€ã¨ã—ã¦è¨­å®šï¼‰
		                addLog("my-attack-log", "ğŸ”¥ç©¶æ¥µã‚¹ã‚­ãƒ«ç™ºå‹•ï¼å…¨SPã‚’æ§ã’ã¦æ­£è§£ã‚’1æ¡è§£èª­ï¼");
		            } else {
		                mySP = MAX_SP;
		            }
		            break; // ç©¶æ¥µã‚¹ã‚­ãƒ«ç™ºå‹•å¾Œã¯ãƒ«ãƒ¼ãƒ—çµ‚äº†
		        } else {
		            // ã€é€šå¸¸ãƒ«ãƒ¼ãƒ«ã€‘ã‚¹ãƒˆãƒƒã‚¯ã‚’1ã¤å¢—ã‚„ã—ã€10ã ã‘æ¶ˆè²»ï¼ˆç¹°ã‚Šè¶Šã—ï¼‰
		            const newSkill = Math.random() > 0.5 ? 'HL' : 'OE';
		            skillStock.push(newSkill);
		            mySP -= MAX_SP; // 10ã ã‘å¼•ã„ã¦ä½™ã‚Šã¯æ®‹ã™
		            addLog("my-attack-log", `ğŸã‚¹ã‚­ãƒ«ç²å¾—: ${newSkill === 'HL' ? 'Hi/Lo' : 'Odd/Even'}`);
		        }
		    }
		    updateSPUI();
		}

		// 2. UIæ›´æ–° (ã‚¹ã‚­ãƒ«ã‚¹ãƒˆãƒƒã‚¯ã®è¡¨ç¤º)
		function updateSPUI() {
		    const percent = Math.min((mySP / MAX_SP) * 100, 100);
		    const barEl = document.getElementById('sp-bar');
		    const valEl = document.getElementById('sp-value');
		    if (barEl) barEl.style.width = percent + "%";
		    if (valEl) valEl.innerText = `${Math.floor(mySP)} / ${MAX_SP}`;

		    for (let i = 0; i < 4; i++) {
		        const btn = document.getElementById(`skill-${i}`);
		        if (!btn) continue;

		        if (skillStock && skillStock[i]) {
		            const typeName = skillStock[i] === 'HL' ? "Hi / Low" : "Odd / Even";
		            btn.innerText = typeName;
		            
		            if (isMyTurn) {
		                // æœ‰åŠ¹æ™‚ï¼šç·‘èƒŒæ™¯ã«ç™½æ–‡å­—
		                btn.disabled = false;
		                btn.style.background = "#2a9d8f";
		                btn.style.color = "#ffffff"; // æ–‡å­—è‰²ã‚’ç™½ã«
		                btn.style.fontWeight = "bold";
		                btn.style.cursor = "pointer";
		                btn.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
		            } else {
		                // ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ï¼šã‚°ãƒ¬ãƒ¼èƒŒæ™¯
		                btn.disabled = true;
		                btn.style.background = "#ccc";
		                btn.style.color = "#888"; // æ–‡å­—è‰²ã‚’è–„ã
		                btn.style.fontWeight = "normal";
		                btn.style.cursor = "not-allowed";
		                btn.style.boxShadow = "none";
		            }
		        } else {
		            // ç©ºãã‚¹ãƒ­ãƒƒãƒˆ
		            btn.innerText = "(ç©ºã)";
		            btn.disabled = true;
		            btn.style.background = "#eee";
		            btn.style.color = "#bbb";
		            btn.style.fontWeight = "normal";
		            btn.style.boxShadow = "none";
		        }
		    }
		}

		// 3. ã‚¹ã‚­ãƒ«ä½¿ç”¨å‡¦ç† (ãƒ©ãƒ³ãƒ€ãƒ ãªæ¡ã‚’é¸æŠ)
		function useSkill(index) {
		    if (!isMyTurn || !skillStock[index]) return;

		    const type = skillStock[index]; // 'HL' ã‹ 'OE'
		    
		    // ã¾ã ã€Œæ­£è§£(FULL)ã€ãŒã‚ã‹ã£ã¦ãŠã‚‰ãšã€ã‹ã¤ã€Œãã®ç¨®é¡ã®æƒ…å ±ã€ãŒå‡ºã¦ã„ãªã„æ¡ã‚’æ¢ã™
		    let targetPos = [];
		    for (let i = 0; i < 4; i++) {
		        const isFullRevealed = revealedPositions.includes(i);
		        const isTypeRevealed = (type === 'HL' ? revealedInfo.HL[i] : revealedInfo.OE[i]);
		        
		        if (!isFullRevealed && !isTypeRevealed) {
		            targetPos.push(i);
		        }
		    }

		    // ã‚‚ã—å…¨ã¦ã®æ¡ã§ãã®æƒ…å ±ãŒåˆ¤æ˜æ¸ˆã¿ãªã‚‰ã€é©å½“ãªæœªè§£èª­ã®æ¡ã«é€ã‚‹ï¼ˆç„¡é§„æ’ƒã¡å›é¿ï¼‰
		    if (targetPos.length === 0) {
		        targetPos = [0, 1, 2, 3].filter(p => !revealedPositions.includes(p));
		    }

		    if (targetPos.length === 0) return; // å…¨æ¡æ­£è§£æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„

		    const chosenPos = targetPos[Math.floor(Math.random() * targetPos.length)];
		    
		    send({ type: "SKILL_REQ", skillType: type, pos: chosenPos });
		    skillStock.splice(index, 1);
		    updateSPUI();
		}

		// 4. ç›¸æ‰‹å´ã§ã®å›ç­”ç”Ÿæˆ
		function handleSkillRequest(data) {
		    const sArr = mySecret.split("").map(Number);
		    const val = sArr[data.pos];

		    if (data.skillType === 'FULL') {
		        // 1æ¡ã®æ­£è§£ãã®ã‚‚ã®ã‚’è¿”ã™
		        send({ type: "SKILL_RES", resType: 'FULL', pos: data.pos, value: val });
		    } else {
		        // å¾“æ¥ã®Hi/Lo ã¾ãŸã¯ Odd/Even
		        let mark = "";
		        if (data.skillType === 'HL') mark = val >= 5 ? "Hiâ†‘" : "Loâ†“";
		        else mark = val % 2 === 0 ? "Evn" : "Odd";
		        send({ type: "SKILL_RES", resType: 'PARTIAL', pos: data.pos, mark: mark });
		    }
		}

		// 5. è‡ªåˆ†ã®ç”»é¢ã«ãƒãƒ¼ã‚¯ã‚’åæ˜ 
		function updateSkillMemo(data) {
		    const memoEl = document.getElementById(`memo-pos-${data.pos}`);
		    if (!memoEl) return;

		    if (data.resType === 'FULL') {
		        memoEl.innerText = data.value;
		        memoEl.style.fontSize = "24px";
		        memoEl.style.color = "#e63946";
		        memoEl.style.background = "#fff1f2";
		        memoEl.style.borderColor = "#e63946";
		        if (!revealedPositions.includes(data.pos)) revealedPositions.push(data.pos);
		    } else {
		        // --- åˆ¤æ˜ãƒ•ãƒ©ã‚°ã‚’æ›´æ–° ---
		        if (data.mark.includes("Hi") || data.mark.includes("Lo")) revealedInfo.HL[data.pos] = true;
		        if (data.mark.includes("Odd") || data.mark.includes("Evn")) revealedInfo.OE[data.pos] = true;

		        // --- é‡è¤‡è¡¨ç¤ºã®é˜²æ­¢ã¨ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ ---
		        let currentHTML = memoEl.innerHTML;
		        if (!currentHTML.includes(data.mark)) {
		            const newDiv = document.createElement('div');
		            newDiv.innerText = data.mark;
		            newDiv.style.fontSize = "10px";
		            newDiv.style.lineHeight = "1.1";
		            
		            // åˆã‚ã¦ã®æƒ…å ±ãªã‚‰ä¸­èº«ã‚’ã‚¯ãƒªã‚¢ã—ã¦è¿½åŠ 
		            if (memoEl.innerText === "" || memoEl.innerText === "?") {
		                memoEl.innerHTML = "";
		            } else {
		                newDiv.style.borderTop = "1px solid #eee";
		                newDiv.style.marginTop = "2px";
		            }
		            memoEl.appendChild(newDiv);
		        }
		    }
		    updateSPUI();
		}

    // --- ãƒªã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç† ---
    function requestRestart() {
        send({ type: "RESTART" });
        document.getElementById('restartBtn').disabled = true;
        document.getElementById('restartBtn').innerText = "ç›¸æ‰‹ã®åŒæ„å¾…ã¡...";
        checkRestart();
    }

    function checkRestart() {
        // è‡ªåˆ†ã‚‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã„ã‚‹ï¼ˆdisabledã«ãªã£ã¦ã„ã‚‹ï¼‰ã‹ã¤ç›¸æ‰‹ã‚‚RESTARTã‚’é€ã£ã¦ããŸ
        if (document.getElementById('restartBtn').disabled && opponentWantsRestart) {
					location.reload();
        }
    }


    function updateStatus(msg) { document.getElementById('status').innerText = msg; }
    function send(data) { window.parent.postMessage(data, "*"); }
    function addLog(id, msg) {
        const el = document.getElementById(id);
        const div = document.createElement('div');
        div.className = "log-item";
        div.innerText = msg;
        el.prepend(div);
    }
</script>
</body>
</html>